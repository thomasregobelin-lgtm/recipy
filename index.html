<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Recipy">
<meta name="theme-color" content="#FF3E7F">
<meta name="description" content="Recipy — Planificateur de repas intelligent">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<title>Recipy — Planificateur</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700,900&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
/* ═══════════════════════════════════════════
   TOKENS
═══════════════════════════════════════════ */
:root{
  --pink:#FF3E7F; --pink-soft:#FFF0F5; --pink-mid:#FFB3CE;
  --dark:#1A1A2E; --gray:#6B7280; --gray-light:#E5E7EB;
  --light:#F5F5F7; --white:#fff;
  --green:#10B981; --amber:#F59E0B; --blue:#3B82F6;
  --radius-card:20px; --radius-pill:50px;
  --shadow-card:0 4px 20px rgba(0,0,0,.08);
  --shadow-float:0 16px 48px rgba(0,0,0,.18);
  --font-display:Georgia,serif;
  --font-body:"DM Sans",sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'DM Sans',sans-serif;background:var(--light);margin:0;padding:0;overflow:hidden;}
html{height:100%;overflow:hidden;}

/* ═══════════════════════════════════════════
   APP SHELL — full viewport, no phone frame
═══════════════════════════════════════════ */
.phone{
  width:100%;
  height:100vh;
  height:100dvh;
  background:var(--light);
  position:relative;
  overflow:hidden;
}
.screen{
  width:100%;
  height:100%;
  position:absolute;
  inset:0;
  display:none;
  flex-direction:column;
  opacity:0;
  transition:opacity .28s ease;
}
.screen.active{display:flex;opacity:1;}
.status-bar{display:none;}
@media(min-width:481px){
  .status-bar{display:flex;justify-content:space-between;align-items:center;padding:14px 28px 0;font-size:13px;font-weight:600;color:var(--dark);flex-shrink:0;}
}

/* ═══════════════════════════════════════════
   SPLASH
═══════════════════════════════════════════ */
#splash{background:linear-gradient(160deg,#1A1A2E 0%,#16213E 55%,#0F3460 100%);justify-content:center;align-items:center;}
.splash-logo{font-family:'Playfair Display',Georgia,serif;font-size:52px;font-weight:900;color:#fff;letter-spacing:-1px;}
.splash-sub{color:rgba(255,255,255,.45);font-size:14px;margin-top:6px;}
.splash-emoji{font-size:78px;margin-bottom:18px;}
.splash-btn{margin-top:56px;background:var(--pink);color:#fff;border:none;padding:18px 60px;border-radius:var(--radius-pill);font-size:16px;font-weight:600;font-family:inherit;cursor:pointer;box-shadow:0 10px 32px rgba(255,62,127,.45);transition:transform .15s;}
.splash-btn:active{transform:scale(.96);}

/* ═══════════════════════════════════════════
   ONBOARDING
═══════════════════════════════════════════ */
.page-body{padding:20px 24px;flex:1;overflow-y:auto;}
.page-title{font-family:'Playfair Display',Georgia,serif;font-size:26px;font-weight:700;color:var(--dark);margin-bottom:6px;}
.page-sub{color:var(--gray);font-size:14px;margin-bottom:20px;}
.dots{display:flex;gap:8px;margin-bottom:20px;}
.dot{width:8px;height:8px;border-radius:50%;background:var(--gray-light);transition:all .3s;}
.dot.active{background:var(--pink);width:24px;border-radius:4px;}
.input-group{margin:12px 0;}
.input-group label{font-size:11px;font-weight:700;color:var(--gray);display:block;margin-bottom:5px;letter-spacing:.6px;text-transform:uppercase;}
.input-group input{width:100%;padding:14px 18px;border:2px solid var(--gray-light);border-radius:16px;font-family:inherit;font-size:15px;outline:none;transition:border-color .2s;color:var(--dark);}
.input-group input:focus{border-color:var(--pink);}
.btn-p{width:100%;padding:16px;background:var(--pink);color:#fff;border:none;border-radius:16px;font-family:inherit;font-size:16px;font-weight:600;cursor:pointer;margin-top:12px;box-shadow:0 8px 20px rgba(255,62,127,.3);transition:transform .15s;}
.btn-p:active{transform:scale(.98);}
.btn-s{width:100%;padding:15px;background:transparent;color:var(--dark);border:2px solid var(--gray-light);border-radius:16px;font-family:inherit;font-size:15px;font-weight:600;cursor:pointer;margin-top:8px;}
.or-div{text-align:center;color:var(--gray);font-size:13px;margin:14px 0;position:relative;}
.or-div::before,.or-div::after{content:"";position:absolute;top:50%;width:38%;height:1px;background:var(--gray-light);}
.or-div::before{left:0;}.or-div::after{right:0;}
.allergy-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin:14px 0;}
.allergy-chip{padding:18px 12px;border-radius:18px;border:2px solid var(--gray-light);display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer;transition:all .2s;}
.allergy-chip .ci{font-size:28px;}.allergy-chip .cl{font-size:12px;font-weight:500;color:var(--dark);}
.allergy-chip.selected{border-color:var(--pink);background:var(--pink-soft);}
.diet-opt{display:flex;align-items:center;gap:14px;padding:16px;border-radius:16px;border:2px solid var(--gray-light);margin:8px 0;cursor:pointer;transition:all .2s;}
.diet-ic{font-size:32px;}.diet-inf h4{font-size:14px;font-weight:600;color:var(--dark);}.diet-inf p{font-size:11px;color:var(--gray);margin-top:2px;}
.diet-chk{margin-left:auto;width:22px;height:22px;border-radius:50%;border:2px solid var(--gray-light);display:flex;align-items:center;justify-content:center;font-size:11px;transition:all .2s;}
.diet-opt.selected{border-color:var(--pink);background:var(--pink-soft);}
.diet-opt.selected .diet-chk{background:var(--pink);border-color:var(--pink);color:#fff;}

/* ═══════════════════════════════════════════
   MAIN SWIPE
═══════════════════════════════════════════ */
#main{background:var(--light);}
.main-hdr{display:flex;justify-content:space-between;align-items:center;padding:18px 24px 10px;flex-shrink:0;}
.main-title{font-family:'Playfair Display',Georgia,serif;font-size:26px;font-weight:900;color:var(--dark);}
.icon-btn{width:42px;height:42px;border-radius:14px;background:var(--white);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:19px;box-shadow:var(--shadow-card);transition:transform .15s;}
.icon-btn:active{transform:scale(.9);}
.filt-bar{display:flex;gap:7px;padding:0 24px 14px;overflow-x:auto;flex-shrink:0;}
.filt-bar::-webkit-scrollbar{display:none;}
.filt-pill{padding:7px 16px;border-radius:var(--radius-pill);border:2px solid var(--gray-light);background:var(--white);font-size:12px;font-weight:600;color:var(--gray);cursor:pointer;white-space:nowrap;transition:all .2s;}
.filt-pill.active{background:var(--pink);border-color:var(--pink);color:#fff;}
.card-area{flex:1;display:flex;align-items:center;justify-content:center;padding:0 18px;}
.recipe-card{width:100%;max-width:316px;background:var(--white);border-radius:24px;overflow:hidden;box-shadow:0 20px 64px rgba(0,0,0,.13);cursor:grab;user-select:none;position:relative;}
.recipe-card.dragging{cursor:grabbing;}
.card-img{width:100%;height:210px;display:flex;align-items:center;justify-content:center;font-size:80px;position:relative;}
.card-ov{position:absolute;inset:0;background:linear-gradient(to bottom,transparent 50%,rgba(0,0,0,.14));}
.swipe-badge{position:absolute;top:18px;border-radius:12px;padding:7px 18px;font-size:16px;font-weight:800;opacity:0;pointer-events:none;z-index:10;}
.swipe-badge.left{left:18px;background:#FF4757;color:#fff;transform:rotate(-15deg);}
.swipe-badge.right{right:18px;background:#2ED573;color:#fff;transform:rotate(15deg);}
.card-body{padding:14px 18px 18px;}
.card-tags{display:flex;gap:5px;margin-bottom:7px;}
.card-tag{padding:3px 10px;border-radius:var(--radius-pill);background:var(--pink-soft);color:var(--pink);font-size:10px;font-weight:700;letter-spacing:.3px;}
.card-title{font-family:'Playfair Display',Georgia,serif;font-size:19px;font-weight:700;color:var(--dark);}
.card-desc{color:var(--gray);font-size:12px;margin-top:4px;line-height:1.5;}
.card-meta{display:flex;gap:12px;margin-top:10px;}
.card-meta-item{font-size:11px;color:var(--gray);font-weight:500;}
.swipe-actions{display:flex;justify-content:center;align-items:center;gap:18px;padding:8px 24px 12px;flex-shrink:0;}
.act-btn{border-radius:50%;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .2s;}
.act-btn:active{transform:scale(.86)!important;}
.act-pass{width:54px;height:54px;font-size:22px;background:var(--white);color:#555;box-shadow:var(--shadow-card);}
.act-save{width:54px;height:54px;font-size:22px;background:var(--pink);color:#fff;box-shadow:0 8px 24px rgba(255,62,127,.42);}
.act-info{width:40px;height:40px;font-size:17px;background:var(--white);color:var(--pink);box-shadow:var(--shadow-card);}

/* ═══════════════════════════════════════════
   BOTTOM NAV (4 tabs)
═══════════════════════════════════════════ */
.bottom-nav{display:flex;justify-content:space-around;align-items:stretch;padding:0 0 max(22px,env(safe-area-inset-bottom));background:var(--white);border-top:1px solid rgba(0,0,0,.05);flex-shrink:0;position:relative;}
.nav-indicator{position:absolute;top:0;height:3px;border-radius:0 0 4px 4px;background:var(--pink);width:var(--ind-w,25%);left:var(--ind-l,0%);transition:left .32s cubic-bezier(.4,0,.2,1),width .32s cubic-bezier(.4,0,.2,1);pointer-events:none;}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;padding:10px 0 2px;border:none;background:transparent;cursor:pointer;position:relative;outline:none;}
.nav-btn::after{content:"";position:absolute;inset:0;background:rgba(255,62,127,.09);opacity:0;transform:scale(.5);border-radius:14px;transition:opacity .22s,transform .22s;pointer-events:none;}
.nav-btn.tap::after{opacity:1;transform:scale(1);}
.nav-icon{font-size:21px;display:flex;align-items:center;justify-content:center;position:relative;transition:transform .28s cubic-bezier(.34,1.56,.64,1);}
.nav-label{font-size:9px;font-weight:700;letter-spacing:.4px;color:var(--gray);transition:color .22s,opacity .2s,transform .22s;opacity:0;transform:translateY(4px);white-space:nowrap;text-transform:uppercase;}
.nav-btn.active .nav-icon{transform:scale(1.2) translateY(-2px);}
.nav-btn.active .nav-label{color:var(--pink);opacity:1;transform:translateY(0);}
.nav-badge{position:absolute;top:-5px;right:-8px;min-width:16px;height:16px;border-radius:9px;background:var(--pink);color:#fff;font-size:9px;font-weight:700;display:flex;align-items:center;justify-content:center;padding:0 3px;transform:scale(0);transition:transform .28s cubic-bezier(.34,1.56,.64,1);border:2px solid var(--white);pointer-events:none;}
.nav-badge.show{transform:scale(1);}
@keyframes badgePop{0%{transform:scale(1.7);}100%{transform:scale(1);}}
.nav-badge.pop{animation:badgePop .28s cubic-bezier(.34,1.56,.64,1) forwards;}

/* ═══════════════════════════════════════════
   DETAIL
═══════════════════════════════════════════ */
#detail{background:var(--white);}
.det-img{height:250px;display:flex;align-items:center;justify-content:center;font-size:100px;position:relative;flex-shrink:0;}
.det-back,.det-fav{position:absolute;top:56px;width:42px;height:42px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:19px;transition:transform .18s;}
.det-back{left:18px;background:rgba(255,255,255,.92);}
.det-fav{right:18px;background:var(--pink);color:#fff;}
.det-fav:active,.det-back:active{transform:scale(.84);}
.det-body{flex:1;overflow-y:auto;padding:18px 22px 20px;}
.det-title{font-family:'Playfair Display',Georgia,serif;font-size:24px;font-weight:700;color:var(--dark);}
.det-desc{color:var(--gray);margin-top:6px;line-height:1.6;font-size:13px;}
.portion-ctrl{display:flex;align-items:center;gap:14px;background:var(--light);border-radius:18px;padding:13px 16px;margin-top:16px;}
.portion-lbl{font-weight:600;font-size:14px;color:var(--dark);flex:1;}
.portion-btns{display:flex;align-items:center;gap:12px;}
.portion-btn{width:32px;height:32px;border-radius:50%;background:var(--pink);color:#fff;border:none;cursor:pointer;font-size:17px;display:flex;align-items:center;justify-content:center;transition:transform .14s;}
.portion-btn:active{transform:scale(.86);}
.portion-num{font-size:19px;font-weight:700;color:var(--dark);min-width:22px;text-align:center;}
/* Add to planning button */
.btn-planning{width:100%;padding:14px;background:linear-gradient(135deg,var(--dark),#2d2d4e);color:#fff;border:none;border-radius:14px;font-family:inherit;font-size:14px;font-weight:600;cursor:pointer;margin-top:14px;display:flex;align-items:center;justify-content:center;gap:8px;transition:transform .15s;}
.btn-planning:active{transform:scale(.98);}
.sec-title{font-family:'Playfair Display',Georgia,serif;font-size:18px;font-weight:700;color:var(--dark);margin:18px 0 10px;}
.ing-list{display:flex;flex-direction:column;gap:8px;}
.ing-item{display:flex;justify-content:space-between;align-items:center;padding:11px 14px;background:var(--light);border-radius:12px;}
.ing-name{font-size:13px;font-weight:500;color:var(--dark);}
.ing-qty{font-size:12px;color:var(--pink);font-weight:600;}
.steps{display:flex;flex-direction:column;gap:12px;}
.step{display:flex;gap:12px;}
.step-n{width:28px;height:28px;border-radius:50%;background:var(--pink);color:#fff;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0;}
.step-t{font-size:13px;color:var(--gray);line-height:1.6;padding-top:3px;}

/* ═══════════════════════════════════════════
   SAVED / MES RECETTES — liste verticale iOS
═══════════════════════════════════════════ */
#saved{background:#F2F2F7;}
.saved-topbar{display:flex;justify-content:space-between;align-items:center;padding:14px 20px 6px;flex-shrink:0;}
.saved-topbar .main-title{font-family:'Playfair Display',Georgia,serif;font-size:24px;font-weight:900;color:var(--dark);}
.count-label{font-size:11px;color:var(--gray);margin-top:2px;}
/* sel-toolbar kept for JS compat but unused visually */
.sel-toolbar,.sel-info,.sel-actions{display:none!important;}
/* ── Animations ── */
@keyframes cardIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}
@keyframes cardExit{to{opacity:0;transform:translateX(60px);height:0;padding:0;margin:0;}}
/* ── Section wrapper (groups rows into a card) ── */
.saved-section{margin:0 16px 14px;border-radius:16px;overflow:hidden;box-shadow:0 1px 6px rgba(0,0,0,.07);background:var(--white);}
/* ── Row ── */
.rc-row{background:var(--white);display:flex;flex-direction:column;border-bottom:1px solid #EBEBF0;animation:cardIn .26s ease both;transition:background .1s;}
.rc-row:last-child{border-bottom:none;}
.rc-row.card-exit{animation:cardExit .22s ease forwards;}
/* ── Row main line ── */
.rc-main{display:flex;align-items:center;gap:13px;padding:11px 14px;cursor:pointer;}
.rc-main:active{background:#F9F9FB;}
/* Photo ronde */
.rc-photo{width:54px;height:54px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:27px;overflow:hidden;}
/* Infos centre */
.rc-info{flex:1;min-width:0;}
.rc-title{font-size:14px;font-weight:700;color:var(--dark);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.rc-meta{font-size:11px;color:var(--gray);margin-top:2px;}
/* Portions */
.rc-portions{display:flex;align-items:center;gap:4px;background:#F2F2F7;border-radius:20px;padding:4px 10px;flex-shrink:0;}
.rc-portions span{font-size:12px;font-weight:600;color:var(--dark);}
/* Chevron */
.rc-chevron{font-size:14px;color:#C7C7CC;margin-left:6px;flex-shrink:0;transition:transform .22s cubic-bezier(.4,0,.2,1);}
.rc-row.expanded .rc-chevron{transform:rotate(90deg);color:var(--pink);}
/* ── Action bar (collapsed by default) ── */
.rc-actions{display:flex;gap:0;border-top:1px solid #F0F0F5;overflow:hidden;max-height:0;opacity:0;transition:max-height .26s cubic-bezier(.4,0,.2,1), opacity .2s ease;}
.rc-row.expanded .rc-actions{max-height:52px;opacity:1;}
.rc-action-btn{flex:1;padding:13px 0;border:none;background:transparent;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:5px;transition:background .12s;border-right:1px solid #F0F0F5;}
.rc-action-btn:last-child{border-right:none;}
.rc-action-btn:active{background:#F5F5F8;}
.rc-action-btn.del{color:#FF3B30;}
.rc-action-btn.detail{color:var(--dark);}
.rc-action-btn.plan{color:var(--pink);}
/* ── List scroll container ── */
.saved-list{flex:1;overflow-y:auto;padding:4px 0 16px;}
/* ── Empty state ── */
.empty-state{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px;text-align:center;}
.empty-state .ei{font-size:56px;margin-bottom:16px;opacity:.38;}
.empty-state h3{font-family:'Playfair Display',Georgia,serif;font-size:20px;color:var(--dark);margin-bottom:6px;}
.empty-state p{font-size:13px;color:var(--gray);line-height:1.6;}
/* ═══════════════════════════════════════════
   CALENDRIER
═══════════════════════════════════════════ */
#calendar{background:var(--light);}
.cal-hdr{display:flex;justify-content:space-between;align-items:center;padding:14px 22px 8px;flex-shrink:0;}
.cal-hdr .main-title{font-family:'Playfair Display',Georgia,serif;font-size:24px;font-weight:900;color:var(--dark);}
/* Week strip — horizontal row of 7 days */
.week-strip{display:flex;flex-direction:row;padding:0 12px 10px;flex-shrink:0;gap:0;}
.day-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;}
.day-label{font-size:9px;font-weight:700;color:var(--gray);letter-spacing:.5px;text-transform:uppercase;}
.day-num{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;color:var(--dark);}
.day-num.today{background:var(--pink);color:#fff;}
/* Cal body */
.cal-body{flex:1;overflow-y:auto;padding:0 12px 16px;}
.cal-day-section{margin-bottom:10px;}
.cal-day-title{font-size:11px;font-weight:700;color:var(--gray);letter-spacing:.5px;text-transform:uppercase;margin-bottom:5px;padding:0 2px;}
/* Filled meal slot */
.meal-slot{background:#fff;border-radius:14px;padding:10px 12px;margin-bottom:6px;display:flex;align-items:center;gap:10px;box-shadow:0 1px 6px rgba(0,0,0,.06);cursor:grab;}
.meal-slot[draggable="true"]:active{cursor:grabbing;}
.meal-slot.drag-over{outline:2px dashed var(--pink);background:var(--pink-soft);}
.meal-emoji{font-size:28px;flex-shrink:0;}
.meal-info{flex:1;min-width:0;}
.meal-title{font-size:13px;font-weight:700;color:var(--dark);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.meal-meta{font-size:10px;color:var(--gray);margin-top:2px;}
.meal-time-badge{display:inline-block;padding:2px 7px;border-radius:6px;font-size:9px;font-weight:700;letter-spacing:.3px;margin-bottom:2px;}
.meal-time-badge.midi{background:#FEF3C7;color:#D97706;}
.meal-time-badge.soir{background:#EDE9FE;color:#7C3AED;}
.meal-remove{width:26px;height:26px;border-radius:50%;background:var(--light);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;color:var(--gray);flex-shrink:0;transition:all .15s;}
.meal-remove:hover{background:#FEE2E2;color:#EF4444;}
/* Empty slot */
.meal-slot-empty{background:rgba(255,255,255,.6);border:1.5px dashed var(--gray-light);border-radius:14px;padding:10px 14px;margin-bottom:6px;display:flex;align-items:center;gap:8px;cursor:pointer;transition:all .18s;}
.meal-slot-empty:hover,.meal-slot-empty:active{border-color:var(--pink);background:var(--pink-soft);}
.meal-slot-empty span{font-size:12px;color:var(--gray);}
/* Calendar empty hint */
.cal-empty-hint{text-align:center;padding:24px 20px;color:var(--gray);font-size:13px;line-height:1.7;}

#prefs{background:var(--light);}
.prefs-body{flex:1;overflow-y:auto;padding:14px;}
.prefs-sec{background:var(--white);border-radius:18px;overflow:hidden;margin-bottom:14px;}
.prefs-row{display:flex;align-items:center;padding:14px 16px;border-bottom:1px solid #F3F4F6;cursor:pointer;}
.prefs-row:last-child{border-bottom:none;}
.prefs-ic{font-size:20px;margin-right:12px;}
.prefs-lbl{font-size:14px;font-weight:500;color:var(--dark);flex:1;}
.prefs-arr{color:var(--gray);}
.prof-hdr{display:flex;flex-direction:column;align-items:center;padding:18px;margin-bottom:8px;}
.prof-av{width:76px;height:76px;border-radius:50%;background:linear-gradient(135deg,var(--pink),#FF6B9D);display:flex;align-items:center;justify-content:center;font-size:34px;margin-bottom:10px;}
.prof-name{font-family:'Playfair Display',Georgia,serif;font-size:20px;font-weight:700;color:var(--dark);}
.prof-sub{color:var(--gray);font-size:12px;margin-top:3px;}
.toggle{width:46px;height:24px;border-radius:12px;background:var(--gray-light);position:relative;cursor:pointer;transition:background .28s;flex-shrink:0;}
.toggle.on{background:var(--pink);}
.toggle::after{content:"";position:absolute;width:18px;height:18px;border-radius:50%;background:#fff;top:3px;left:3px;transition:transform .28s;box-shadow:0 2px 5px rgba(0,0,0,.2);}
.toggle.on::after{transform:translateX(22px);}

/* ═══════════════════════════════════════════
   MODALS
═══════════════════════════════════════════ */
.overlay{position:absolute;inset:0;background:rgba(0,0,0,.42);z-index:99;opacity:0;pointer-events:none;transition:opacity .28s;}
.overlay.show{opacity:1;pointer-events:all;}
.modal{position:absolute;bottom:0;left:0;right:0;transform:translateY(100%);width:100%;background:var(--white);border-radius:28px 28px 0 0;padding:18px 22px 36px;transition:transform .36s cubic-bezier(.4,0,.2,1);z-index:100;max-height:82%;overflow-y:auto;}
.modal.open{transform:translateY(0);}
.modal.open{transform:translateY(0);}
.modal-handle{width:38px;height:4px;background:var(--gray-light);border-radius:2px;margin:0 auto 16px;}
.modal-title{font-family:'Playfair Display',Georgia,serif;font-size:20px;font-weight:700;color:var(--dark);margin-bottom:14px;}
/* Planning picker */
.plan-day-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:5px;margin-bottom:14px;}
.plan-day-btn{padding:8px 0;border-radius:10px;border:2px solid var(--gray-light);background:transparent;font-family:inherit;font-size:10px;font-weight:700;cursor:pointer;text-align:center;transition:all .18s;}
.plan-day-btn.selected{background:var(--dark);border-color:var(--dark);color:#fff;}
.plan-time-row{display:flex;gap:8px;margin-bottom:14px;}
.plan-time-btn{flex:1;padding:11px;border-radius:12px;border:2px solid var(--gray-light);background:transparent;font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;transition:all .18s;}
.plan-time-btn.selected{border-color:var(--pink);background:var(--pink-soft);color:var(--pink);}
/* Filter modal */
.filt-sec-title{font-size:11px;font-weight:700;color:var(--gray);margin:12px 0 8px;letter-spacing:.5px;text-transform:uppercase;}
.filt-chips{display:flex;flex-wrap:wrap;gap:7px;}
.filt-chip{padding:7px 14px;border-radius:var(--radius-pill);border:2px solid var(--gray-light);font-size:12px;font-weight:600;cursor:pointer;transition:all .18s;}
.filt-chip.selected{border-color:var(--pink);background:var(--pink-soft);color:var(--pink);}

/* ═══════════════════════════════════════════
   TOAST
═══════════════════════════════════════════ */
.toast{position:fixed;bottom:calc(86px + env(safe-area-inset-bottom));left:50%;transform:translateX(-50%) translateY(18px);background:var(--dark);color:#fff;padding:10px 20px;border-radius:var(--radius-pill);font-size:13px;font-weight:500;white-space:nowrap;opacity:0;transition:all .28s cubic-bezier(.34,1.56,.64,1);z-index:200;pointer-events:none;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* ═══════════════════════════════════════════
   MICRO ANIMATIONS
═══════════════════════════════════════════ */
@keyframes heartBurst{0%{transform:scale(1);}30%{transform:scale(1.52);}65%{transform:scale(.92);}100%{transform:scale(1);}}
.heart-burst{animation:heartBurst .38s cubic-bezier(.34,1.56,.64,1) forwards;}

/* ═══════════════════════════════════════════
   LISTE DE COURSES
═══════════════════════════════════════════ */
#shopping{background:#F2F2F7;}
.shop-hdr{padding:14px 20px 4px;flex-shrink:0;}
.shop-action-btn{padding:10px 0;border:none;border-radius:12px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:5px;transition:transform .13s;}
.shop-action-btn:active{transform:scale(.95);}
.shop-action-btn.export{background:var(--pink);color:#fff;box-shadow:0 4px 16px rgba(255,62,127,.3);}
.shop-action-btn.uncheck,.shop-action-btn.reset{background:var(--white);color:var(--dark);box-shadow:0 1px 4px rgba(0,0,0,.08);}
.shop-body{flex:1;overflow-y:auto;padding:0 14px 14px;}
.shop-category{margin-bottom:16px;}
.shop-cat-title{font-size:10px;font-weight:700;color:var(--gray);letter-spacing:.7px;text-transform:uppercase;margin-bottom:6px;padding:0 2px;}
.shop-card{background:var(--white);border-radius:14px;overflow:hidden;box-shadow:0 1px 6px rgba(0,0,0,.06);}
.shop-item{display:flex;align-items:center;gap:12px;padding:12px 14px;border-bottom:1px solid #F0F0F5;cursor:pointer;transition:opacity .15s;}
.shop-item:last-child{border-bottom:none;}
.shop-item.checked{opacity:.45;}
.shop-item.checked .shop-item-name{text-decoration:line-through;color:#9CA3AF;}
.shop-cb{width:22px;height:22px;border-radius:7px;border:2px solid #D1D5DB;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:13px;color:#fff;transition:all .18s;}
.shop-item.checked .shop-cb{background:#10B981;border-color:#10B981;}
.shop-item-name{flex:1;font-size:13px;font-weight:500;color:var(--dark);}
.shop-item-qty{font-size:12px;font-weight:700;color:var(--pink);flex-shrink:0;}

/* ═══════════════════════════════════════════
   CREATE RECIPE SCREEN
═══════════════════════════════════════════ */
#create{background:#F2F2F7;}
.create-hdr{display:flex;align-items:center;gap:10px;padding:14px 18px 8px;flex-shrink:0;}
.create-hdr .main-title{font-family:'Playfair Display',Georgia,serif;font-size:22px;font-weight:900;color:#1A1A2E;flex:1;}
.create-hdr .btn-create-save{padding:8px 16px;background:#FF3E7F;color:#fff;border:none;border-radius:20px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:transform .15s,opacity .15s;}
.create-hdr .btn-create-save:active{transform:scale(.94);}
.create-body{flex:1;overflow-y:auto;padding:0 16px 24px;}

/* Form sections */
.cf-section{background:#fff;border-radius:14px;overflow:hidden;margin-bottom:14px;box-shadow:0 1px 5px rgba(0,0,0,.06);}
.cf-section-title{font-size:10px;font-weight:700;color:#6B7280;letter-spacing:.7px;text-transform:uppercase;padding:10px 14px 2px;}
.cf-row{display:flex;align-items:center;padding:10px 14px;border-bottom:1px solid #F0F0F5;}
.cf-row:last-child{border-bottom:none;}
.cf-label{font-size:13px;font-weight:600;color:#1A1A2E;min-width:90px;flex-shrink:0;}
.cf-input{flex:1;border:none;outline:none;font-family:'DM Sans',sans-serif;font-size:13px;color:#1A1A2E;background:transparent;text-align:right;}
.cf-input::placeholder{color:#C7C7CC;}
.cf-textarea{width:100%;border:none;outline:none;font-family:'DM Sans',sans-serif;font-size:13px;color:#1A1A2E;background:transparent;resize:none;line-height:1.6;padding:10px 14px;box-sizing:border-box;min-height:90px;}
.cf-textarea::placeholder{color:#C7C7CC;}

/* Photo upload */
.cf-photo-zone{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;cursor:pointer;gap:8px;background:#FAFAFA;border:2px dashed #E5E7EB;border-radius:14px;margin-bottom:14px;transition:border-color .18s,background .18s;}
.cf-photo-zone:hover{border-color:#FF3E7F;background:#FFF5F8;}
.cf-photo-zone.has-photo{border-style:solid;border-color:#FF3E7F;padding:0;overflow:hidden;}
.cf-photo-zone img{width:100%;max-height:180px;object-fit:cover;border-radius:12px;}
.cf-photo-icon{font-size:32px;opacity:.4;}
.cf-photo-label{font-size:12px;color:#6B7280;font-weight:500;}

/* Tags */
.cf-tags-wrap{display:flex;flex-wrap:wrap;gap:7px;padding:10px 14px;}
.cf-tag{padding:5px 12px;border-radius:20px;font-size:11px;font-weight:700;cursor:pointer;border:2px solid #E5E7EB;background:transparent;color:#6B7280;transition:all .15s;font-family:'DM Sans',sans-serif;}
.cf-tag.selected{background:#FF3E7F;border-color:#FF3E7F;color:#fff;}
.cf-tag-input-row{display:flex;align-items:center;gap:8px;padding:6px 14px 12px;}
.cf-tag-input{flex:1;border:none;border-bottom:2px solid #E5E7EB;outline:none;font-family:'DM Sans',sans-serif;font-size:12px;color:#1A1A2E;background:transparent;padding:4px 0;}
.cf-tag-add{width:28px;height:28px;border-radius:50%;background:#FF3E7F;color:#fff;border:none;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;}

/* Ingredients list */
.cf-ing-list{padding:4px 14px 8px;}
.cf-ing-row{display:flex;align-items:center;gap:8px;padding:5px 0;border-bottom:1px solid #F5F5F7;}
.cf-ing-row:last-child{border-bottom:none;}
.cf-ing-name{flex:1;border:none;outline:none;font-family:'DM Sans',sans-serif;font-size:13px;color:#1A1A2E;background:transparent;}
.cf-ing-name::placeholder{color:#C7C7CC;}
.cf-ing-qty{width:70px;border:none;outline:none;font-family:'DM Sans',sans-serif;font-size:12px;color:#6B7280;background:transparent;text-align:right;}
.cf-ing-qty::placeholder{color:#C7C7CC;}
.cf-ing-del{width:22px;height:22px;border-radius:50%;background:#FEE2E2;border:none;color:#EF4444;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;line-height:1;}
.cf-add-row{display:flex;align-items:center;gap:8px;padding:8px 14px;cursor:pointer;color:#FF3E7F;font-size:12px;font-weight:700;}

/* Gradient picker */
.cf-grad-wrap{display:flex;gap:8px;padding:10px 14px;overflow-x:auto;}
.cf-grad-swatch{width:36px;height:36px;border-radius:50%;cursor:pointer;flex-shrink:0;border:3px solid transparent;transition:transform .15s,border-color .15s;}
.cf-grad-swatch.selected{border-color:#1A1A2E;transform:scale(1.15);}

/* Saved custom recipes list */
.create-list-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;text-align:center;gap:10px;}
.create-list-empty .ei{font-size:48px;opacity:.3;}

/* ═══════════════════════════════════════════
   CREATE RECIPE SCREEN
═══════════════════════════════════════════ */
#create{background:#F2F2F7;}
.cr-hdr{display:flex;align-items:center;padding:14px 18px 6px;flex-shrink:0;gap:10px;}
.cr-title{font-family:'Playfair Display',Georgia,serif;font-size:22px;font-weight:900;color:#1A1A2E;flex:1;}
.cr-btn-new{padding:8px 16px;background:#FF3E7F;color:#fff;border:none;border-radius:20px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer;box-shadow:0 4px 14px rgba(255,62,127,.32);transition:transform .15s;}
.cr-btn-new:active{transform:scale(.94);}
.cr-tabs{display:flex;gap:0;padding:0 18px 10px;flex-shrink:0;}
.cr-tab{flex:1;padding:7px 0;text-align:center;font-size:12px;font-weight:700;color:#6B7280;border-bottom:2px solid transparent;cursor:pointer;transition:all .18s;}
.cr-tab.active{color:#FF3E7F;border-color:#FF3E7F;}
.cr-body{flex:1;overflow-y:auto;padding:0 14px 20px;}

/* Form card sections */
.cf-card{background:#fff;border-radius:14px;overflow:hidden;margin-bottom:12px;box-shadow:0 1px 5px rgba(0,0,0,.05);}
.cf-card-title{font-size:9px;font-weight:700;color:#9CA3AF;letter-spacing:.8px;text-transform:uppercase;padding:10px 14px 0;}
.cf-row{display:flex;align-items:center;min-height:44px;padding:0 14px;border-bottom:1px solid #F5F5F7;}
.cf-row:last-child{border-bottom:none;}
.cf-lbl{font-size:13px;font-weight:600;color:#1A1A2E;min-width:110px;flex-shrink:0;}
.cf-inp{flex:1;border:none;outline:none;font-family:'DM Sans',sans-serif;font-size:13px;color:#1A1A2E;background:transparent;text-align:right;padding:10px 0;}
.cf-inp::placeholder{color:#C7C7CC;}

/* Photo zone */
.cf-photo{display:flex;align-items:center;justify-content:center;min-height:130px;background:#FAFAFA;border:2px dashed #E5E7EB;border-radius:14px;cursor:pointer;flex-direction:column;gap:6px;margin-bottom:12px;transition:border-color .2s,background .2s;overflow:hidden;position:relative;}
.cf-photo:hover{border-color:#FF3E7F;background:#FFF5F8;}
.cf-photo.filled{border-style:solid;border-color:#FF3E7F;padding:0;}
.cf-photo img{width:100%;height:130px;object-fit:cover;display:block;}
.cf-photo-overlay{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,.4));padding:8px;display:flex;justify-content:flex-end;}
.cf-photo-change{background:rgba(255,255,255,.9);border:none;border-radius:10px;padding:4px 10px;font-size:11px;font-weight:600;cursor:pointer;color:#1A1A2E;}
.cf-photo-icon{font-size:28px;opacity:.3;}
.cf-photo-lbl{font-size:12px;color:#9CA3AF;font-weight:500;}

/* Emoji gradient picker */
.cf-emoji-row{display:flex;gap:10px;padding:10px 14px;align-items:center;flex-wrap:wrap;}
.cf-emoji-btn{font-size:24px;width:40px;height:40px;border-radius:10px;border:2px solid transparent;cursor:pointer;display:flex;align-items:center;justify-content:center;background:#F5F5F7;transition:all .15s;}
.cf-emoji-btn.sel{border-color:#FF3E7F;background:#FFF0F5;transform:scale(1.12);}
.cf-grad-row{display:flex;gap:8px;padding:8px 14px 12px;overflow-x:auto;}
.cf-swatch{width:34px;height:34px;border-radius:50%;cursor:pointer;flex-shrink:0;border:3px solid transparent;transition:all .18s;}
.cf-swatch.sel{border-color:#1A1A2E;transform:scale(1.2);}

/* Tags */
.cf-tags-wrap{display:flex;flex-wrap:wrap;gap:7px;padding:10px 14px 6px;}
.cf-tag{padding:5px 12px;border-radius:20px;font-size:11px;font-weight:700;cursor:pointer;border:2px solid #E5E7EB;background:transparent;color:#6B7280;transition:all .15s;font-family:'DM Sans',sans-serif;}
.cf-tag.sel{background:#FF3E7F;border-color:#FF3E7F;color:#fff;}
.cf-tag-custom-row{display:flex;align-items:center;gap:8px;padding:6px 14px 12px;}
.cf-tag-inp{flex:1;border:none;border-bottom:2px solid #E5E7EB;outline:none;font-family:'DM Sans',sans-serif;font-size:12px;color:#1A1A2E;background:transparent;padding:4px 0;}
.cf-tag-inp::placeholder{color:#C7C7CC;}
.cf-tag-add-btn{width:28px;height:28px;border-radius:50%;background:#FF3E7F;color:#fff;border:none;font-size:20px;line-height:1;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;}

/* Ingredients */
.cf-ing-list{padding:2px 14px 6px;}
.cf-ing-item{display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid #F5F5F7;}
.cf-ing-item:last-child{border-bottom:none;}
.cf-ing-name{flex:1;border:none;outline:none;font-family:'DM Sans',sans-serif;font-size:13px;color:#1A1A2E;background:transparent;padding:0;}
.cf-ing-name::placeholder,.cf-ing-qty::placeholder{color:#C7C7CC;}
.cf-ing-qty{width:72px;border:none;outline:none;font-family:'DM Sans',sans-serif;font-size:12px;color:#6B7280;background:transparent;text-align:right;}
.cf-ing-del{width:22px;height:22px;border-radius:50%;background:#FEE2E2;border:none;color:#EF4444;font-size:15px;line-height:1;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.cf-add-ing{display:flex;align-items:center;gap:6px;padding:8px 14px;cursor:pointer;font-size:12px;font-weight:700;color:#FF3E7F;}

/* Steps textarea */
.cf-textarea{width:100%;box-sizing:border-box;border:none;outline:none;font-family:'DM Sans',sans-serif;font-size:13px;color:#1A1A2E;background:transparent;resize:none;min-height:100px;line-height:1.7;padding:10px 14px;}
.cf-textarea::placeholder{color:#C7C7CC;}

/* Saved custom recipes list */
.cr-list{display:flex;flex-direction:column;gap:0;}
.cr-recipe-row{display:flex;align-items:center;gap:12px;padding:12px 14px;background:#fff;border-bottom:1px solid #F5F5F7;cursor:pointer;transition:background .15s;}
.cr-recipe-row:first-child{border-radius:14px 14px 0 0;}
.cr-recipe-row:last-child{border-bottom:none;border-radius:0 0 14px 14px;}
.cr-recipe-row:only-child{border-radius:14px;}
.cr-recipe-row:hover{background:#FFF5F8;}
.cr-recipe-emoji{font-size:30px;width:46px;height:46px;border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.cr-recipe-info{flex:1;min-width:0;}
.cr-recipe-title{font-size:13px;font-weight:700;color:#1A1A2E;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.cr-recipe-meta{font-size:11px;color:#9CA3AF;margin-top:2px;}
.cr-recipe-del{width:30px;height:30px;border-radius:50%;background:#F3F4F6;border:none;color:#9CA3AF;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;}
.cr-recipe-del:hover{background:#FEE2E2;color:#EF4444;}
.cr-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;text-align:center;gap:10px;}
.cr-empty-icon{font-size:52px;opacity:.25;}
.cr-empty-title{font-family:'Playfair Display',Georgia,serif;font-size:18px;font-weight:700;color:#1A1A2E;}
.cr-empty-sub{font-size:12px;color:#9CA3AF;line-height:1.7;}
/* Save button at bottom of form */
.cf-submit{width:calc(100% - 28px);margin:4px 14px 8px;padding:14px;background:#FF3E7F;color:#fff;border:none;border-radius:14px;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:700;cursor:pointer;box-shadow:0 6px 20px rgba(255,62,127,.35);transition:transform .15s,box-shadow .15s;}
.cf-submit:active{transform:scale(.97);box-shadow:0 2px 8px rgba(255,62,127,.3);}

/* ═══════════════════════════════════════════
   PROFILE / SETTINGS SCREEN
═══════════════════════════════════════════ */
#profile{background:#F2F2F7;}
.prof2-hdr{display:flex;align-items:center;padding:14px 18px 8px;flex-shrink:0;gap:10px;}
.prof2-back{width:34px;height:34px;border-radius:50%;background:#fff;border:none;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 1px 4px rgba(0,0,0,.1);}
.prof2-title{font-family:'Playfair Display',Georgia,serif;font-size:20px;font-weight:900;color:#1A1A2E;flex:1;}
.prof2-body{flex:1;overflow-y:auto;padding:0 14px 30px;}
.prof2-avatar{display:flex;flex-direction:column;align-items:center;padding:20px 0 16px;gap:8px;}
.prof2-av-circle{width:72px;height:72px;border-radius:50%;background:linear-gradient(135deg,#FF3E7F,#FF8C42);display:flex;align-items:center;justify-content:center;font-size:32px;box-shadow:0 4px 16px rgba(255,62,127,.3);}
.prof2-av-name{font-family:'Playfair Display',Georgia,serif;font-size:18px;font-weight:700;color:#1A1A2E;}
.prof2-av-sub{font-size:11px;color:#9CA3AF;}
.prof2-sec{margin-bottom:14px;}
.prof2-sec-title{font-size:9px;font-weight:700;color:#9CA3AF;letter-spacing:.8px;text-transform:uppercase;padding:0 4px 6px;}
.prof2-card{background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 1px 5px rgba(0,0,0,.05);}
.prof2-row{display:flex;align-items:center;min-height:46px;padding:0 14px;border-bottom:1px solid #F5F5F7;gap:10px;}
.prof2-row:last-child{border-bottom:none;}
.prof2-row-ic{font-size:18px;width:26px;text-align:center;flex-shrink:0;}
.prof2-row-lbl{flex:1;font-size:13px;font-weight:500;color:#1A1A2E;}
.prof2-row-val{font-size:12px;color:#9CA3AF;max-width:140px;text-align:right;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.prof2-row-arr{font-size:16px;color:#C7C7CC;margin-left:4px;}
.prof2-inp{flex:1;border:none;outline:none;font-family:'DM Sans',sans-serif;font-size:13px;color:#1A1A2E;background:transparent;text-align:right;padding:10px 0;}
.prof2-inp::placeholder{color:#C7C7CC;}
/* Diet options */
.prof2-diet-grid{display:flex;flex-direction:column;gap:0;}
.prof2-diet-opt{display:flex;align-items:center;padding:12px 14px;border-bottom:1px solid #F5F5F7;cursor:pointer;transition:background .15s;gap:10px;}
.prof2-diet-opt:last-child{border-bottom:none;}
.prof2-diet-opt.sel{background:#FFF5F8;}
.prof2-diet-ic{font-size:22px;flex-shrink:0;}
.prof2-diet-info{flex:1;}
.prof2-diet-info h4{font-size:13px;font-weight:600;color:#1A1A2E;margin:0;}
.prof2-diet-info p{font-size:11px;color:#9CA3AF;margin:2px 0 0;}
.prof2-diet-chk{width:22px;height:22px;border-radius:50%;border:2px solid #E5E7EB;display:flex;align-items:center;justify-content:center;font-size:12px;color:#fff;flex-shrink:0;transition:all .18s;}
.prof2-diet-opt.sel .prof2-diet-chk{background:#FF3E7F;border-color:#FF3E7F;}
/* Allergy chips */
.prof2-allergy-grid{display:flex;flex-wrap:wrap;gap:8px;padding:12px 14px;}
.prof2-allergy-chip{display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:20px;border:2px solid #E5E7EB;background:#F9F9F9;cursor:pointer;font-size:12px;font-weight:600;color:#6B7280;transition:all .15s;}
.prof2-allergy-chip.sel{background:#FFF5F8;border-color:#FF3E7F;color:#FF3E7F;}
/* Disliked tags */
.prof2-dislike-wrap{display:flex;flex-wrap:wrap;gap:7px;padding:10px 14px 6px;}
.prof2-dislike-tag{display:flex;align-items:center;gap:4px;padding:5px 10px;border-radius:20px;background:#F3F4F6;font-size:12px;font-weight:600;color:#6B7280;}
.prof2-dislike-tag button{background:none;border:none;color:#9CA3AF;font-size:14px;cursor:pointer;padding:0;line-height:1;}
.prof2-dislike-inp-row{display:flex;align-items:center;gap:8px;padding:6px 14px 12px;}
.prof2-dislike-inp{flex:1;border:none;border-bottom:2px solid #E5E7EB;outline:none;font-family:'DM Sans',sans-serif;font-size:12px;color:#1A1A2E;background:transparent;padding:4px 0;}
.prof2-dislike-inp::placeholder{color:#C7C7CC;}
.prof2-dislike-add{width:28px;height:28px;border-radius:50%;background:#FF3E7F;color:#fff;border:none;font-size:20px;line-height:1;cursor:pointer;display:flex;align-items:center;justify-content:center;}
/* Save button */
.prof2-save{width:calc(100% - 28px);margin:4px 14px 8px;padding:14px;background:#FF3E7F;color:#fff;border:none;border-radius:14px;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:700;cursor:pointer;box-shadow:0 6px 20px rgba(255,62,127,.3);transition:transform .15s;}
.prof2-save:active{transform:scale(.97);}
/* Danger zone */
.prof2-danger{color:#EF4444 !important;}

/* ═══════════════════════════════════════════
   SWIPE END SCREEN
═══════════════════════════════════════════ */
#swipe-end{display:none;flex-direction:column;align-items:center;justify-content:center;padding:40px 30px;text-align:center;gap:16px;position:absolute;inset:0;background:#fff;z-index:10;border-radius:inherit;}
.swipe-end-icon{font-size:64px;animation:bounce .8s ease infinite alternate;}
@keyframes bounce{from{transform:translateY(0);}to{transform:translateY(-12px);}}
.swipe-end-title{font-family:'Playfair Display',Georgia,serif;font-size:22px;font-weight:900;color:#1A1A2E;line-height:1.3;}
.swipe-end-sub{font-size:13px;color:#6B7280;line-height:1.7;max-width:260px;}
.swipe-end-btns{display:flex;flex-direction:column;gap:10px;width:100%;}
.swipe-end-btn-primary{padding:14px;background:#FF3E7F;color:#fff;border:none;border-radius:14px;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:700;cursor:pointer;box-shadow:0 6px 20px rgba(255,62,127,.3);}
.swipe-end-btn-secondary{padding:14px;background:#F3F4F6;color:#1A1A2E;border:none;border-radius:14px;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;cursor:pointer;}

/* Profile button in main header */
.btn-profile{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,#FF3E7F,#FF8C42);border:none;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(255,62,127,.3);transition:transform .15s;}
.btn-profile:active{transform:scale(.9);}

/* ═══════════════════════════════════════════
   SAVED — MODE ÉDITION + RECHERCHE PLANNING
═══════════════════════════════════════════ */

/* Topbar with edit button */
.saved-topbar{display:flex;justify-content:space-between;align-items:center;padding:14px 20px 6px;flex-shrink:0;}
.btn-edit-mode{padding:6px 14px;border-radius:20px;border:2px solid var(--gray-light);background:transparent;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:700;color:var(--gray);cursor:pointer;transition:all .18s;}
.btn-edit-mode.active{background:var(--pink);border-color:var(--pink);color:#fff;}

/* Edit toolbar (shown in edit mode) */
.edit-toolbar{display:none;align-items:center;justify-content:space-between;padding:8px 20px;background:#FFF5F8;border-bottom:1px solid #FFD6E5;flex-shrink:0;}
.edit-toolbar.show{display:flex;}
.edit-sel-count{font-size:12px;font-weight:700;color:var(--pink);}
.edit-actions{display:flex;gap:8px;}
.btn-edit-action{padding:6px 14px;border-radius:20px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:700;cursor:pointer;border:none;transition:all .15s;}
.btn-edit-action.select-all{background:var(--light);color:var(--dark);}
.btn-edit-action.delete-sel{background:#EF4444;color:#fff;}
.btn-edit-action.delete-sel:disabled{opacity:.4;cursor:not-allowed;}

/* Checkbox on each row in edit mode */
.rc-checkbox{width:22px;height:22px;border-radius:7px;border:2px solid #D1D5DB;background:#fff;flex-shrink:0;display:none;align-items:center;justify-content:center;font-size:13px;color:#fff;transition:all .18s;margin-right:2px;}
.edit-mode .rc-checkbox{display:flex;}
.edit-mode .rc-chevron{display:none;}
.rc-row.sel-checked .rc-checkbox{background:var(--pink);border-color:var(--pink);}
.edit-mode .rc-row{cursor:pointer;}
.edit-mode .rc-row.expanded{/* keep rows flat in edit mode */}
.edit-mode .rc-actions{display:none!important;max-height:0!important;}

/* Planning modal search bar */
.plan-search-wrap{position:relative;margin-bottom:12px;}
.plan-search-inp{width:100%;padding:10px 14px 10px 36px;border:2px solid var(--gray-light);border-radius:12px;font-family:'DM Sans',sans-serif;font-size:13px;color:var(--dark);outline:none;box-sizing:border-box;transition:border-color .18s;}
.plan-search-inp:focus{border-color:var(--pink);}
.plan-search-icon{position:absolute;left:11px;top:50%;transform:translateY(-50%);font-size:15px;pointer-events:none;opacity:.45;}
.plan-search-clear{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;font-size:16px;color:var(--gray);cursor:pointer;display:none;padding:0;line-height:1;}



/* User badge in main header */
.user-badge{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--gray);max-width:90px;overflow:hidden;}
.user-avatar{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#FF3E7F,#FF8C42);display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;}
/* Sync indicator */
.sync-dot{width:7px;height:7px;border-radius:50%;background:#10B981;position:absolute;bottom:2px;right:2px;border:1.5px solid #fff;transition:background .3s;}
.sync-dot.syncing{background:#F59E0B;animation:pulse .8s ease infinite alternate;}
.sync-dot.offline{background:#EF4444;}
@keyframes pulse{from{opacity:1;}to{opacity:.3;}}

</style>

</head>
<body>
<div class="phone" id="app">
  <div class="overlay" id="overlay"></div>
  <div class="toast" id="toast"></div>

  <!-- ══ SPLASH ══ -->
  <div class="screen active" id="splash">
    <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;text-align:center;">
      <div class="splash-emoji">🍽️</div>
      <div class="splash-logo">RECIPY</div>
      <div class="splash-sub">Planifiez, cuisinez, savourez</div>
      <button class="splash-btn" id="btn-start">Commencer</button>
    </div>
  </div>

  <!-- ══ ONBOARD ══ -->
  <div class="screen" id="onboard">
    <div class="status-bar"><span>9:41</span><span>▲▲ 🔋</span></div>
    <div class="page-body">
      <div class="dots"><div class="dot active"></div><div class="dot"></div><div class="dot"></div></div>
      <div style="font-size:48px;margin-bottom:14px;">👋</div>
      <div class="page-title">Bienvenue sur Recipy</div>
      <div class="page-sub">Créez votre compte pour commencer</div>
      <div class="input-group"><label>Prénom</label><input type="text" placeholder="Marie"></div>
      <div class="input-group"><label>Email</label><input type="email" placeholder="marie@exemple.fr"></div>
      <div class="input-group"><label>Mot de passe</label><input type="password" placeholder="••••••••"></div>
      <button class="btn-p" id="btn-to-allergies">Créer mon compte</button>
      <div class="or-div">ou</div>
      <button class="btn-s" id="btn-login">Se connecter</button>
    </div>
  </div>

  <!-- ══ ALLERGIES ══ -->
  <div class="screen" id="allergies">
    <div class="status-bar"><span>9:41</span><span>▲▲ 🔋</span></div>
    <div class="page-body">
      <div class="dots"><div class="dot"></div><div class="dot active"></div><div class="dot"></div></div>
      <div class="page-title">Vos allergies</div>
      <div class="page-sub">Sélectionnez ce que vous évitez</div>
      <div class="allergy-grid">
        <div class="allergy-chip"><span class="ci">🥜</span><span class="cl">Arachides</span></div>
        <div class="allergy-chip"><span class="ci">🥛</span><span class="cl">Lactose</span></div>
        <div class="allergy-chip"><span class="ci">🌾</span><span class="cl">Gluten</span></div>
        <div class="allergy-chip"><span class="ci">🦐</span><span class="cl">Crustacés</span></div>
        <div class="allergy-chip"><span class="ci">🥚</span><span class="cl">Oeufs</span></div>
        <div class="allergy-chip"><span class="ci">🐟</span><span class="cl">Poisson</span></div>
        <div class="allergy-chip"><span class="ci">🌰</span><span class="cl">Noix</span></div>
        <div class="allergy-chip"><span class="ci">🫘</span><span class="cl">Soja</span></div>
      </div>
      <button class="btn-p" id="btn-to-diet">Continuer</button>
      <button class="btn-s" id="btn-skip-a">Passer</button>
    </div>
  </div>

  <!-- ══ DIET ══ -->
  <div class="screen" id="diet">
    <div class="status-bar"><span>9:41</span><span>▲▲ 🔋</span></div>
    <div class="page-body">
      <div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot active"></div></div>
      <div class="page-title">Votre régime</div>
      <div class="page-sub">Pour des recettes adaptées</div>
      <div class="diet-opt selected" id="diet0"><div class="diet-ic">🍖</div><div class="diet-inf"><h4>Omnivore</h4><p>Je mange de tout</p></div><div class="diet-chk">✓</div></div>
      <div class="diet-opt" id="diet1"><div class="diet-ic">🥗</div><div class="diet-inf"><h4>Végétarien</h4><p>Pas de viande ni poisson</p></div><div class="diet-chk"></div></div>
      <div class="diet-opt" id="diet2"><div class="diet-ic">🌱</div><div class="diet-inf"><h4>Vegan</h4><p>Aucun produit animal</p></div><div class="diet-chk"></div></div>
      <div class="diet-opt" id="diet3"><div class="diet-ic">🥩</div><div class="diet-inf"><h4>Keto</h4><p>Faible en glucides</p></div><div class="diet-chk"></div></div>
      <button class="btn-p" id="btn-to-main">C'est parti ! 🎉</button>
    </div>
  </div>

  <!-- ══ MAIN SWIPE ══ -->
  <div class="screen" id="main">
    <div class="status-bar"><span>9:41</span><span>▲▲ 🔋</span></div>
    <div class="main-hdr">
      <div class="main-title">Recipy</div>
      <button class="icon-btn" id="btn-filter">🔧</button>
      <button class="btn-profile" id="btn-open-profile">👤</button>
    </div>
    <div class="filt-bar">
      <div class="filt-pill active" id="fp0">Tout</div>
      <div class="filt-pill" id="fp1">🍝 Pasta</div>
      <div class="filt-pill" id="fp2">🥗 Salade</div>
      <div class="filt-pill" id="fp3">🍜 Soupe</div>
      <div class="filt-pill" id="fp4">🍰 Dessert</div>
    </div>
    <div class="card-area" style="position:relative;">
      <!-- Swipe end overlay -->
      <div id="swipe-end">
        <div class="swipe-end-icon">🎉</div>
        <div class="swipe-end-title">Vous avez tout vu !</div>
        <div class="swipe-end-sub">Vous avez exploré toutes les recettes disponibles pour votre profil.</div>
        <div class="swipe-end-btns">
          <button class="swipe-end-btn-primary" id="btn-swipe-restart">🔄 Recommencer le swipe</button>
          <button class="swipe-end-btn-secondary" id="btn-swipe-go-saved">♥ Voir mes recettes likées</button>
        </div>
      </div>
      <div class="recipe-card" id="swipe-card">
        <div class="swipe-badge left" id="badge-left">✕ PASSER</div>
        <div class="swipe-badge right" id="badge-right">★ SAUVER</div>
        <div class="card-img" id="card-img"><div class="card-ov"></div></div>
        <div class="card-body">
          <div class="card-tags"><div class="card-tag" id="ctag1"></div><div class="card-tag" id="ctag2"></div></div>
          <div class="card-title" id="ctitle"></div>
          <div class="card-desc" id="cdesc"></div>
          <div class="card-meta">
            <div class="card-meta-item">⏱️ <span id="ctime"></span></div>
            <div class="card-meta-item">👤 2 pers.</div>
            <div class="card-meta-item">💰 <span id="cprice"></span></div>
          </div>
        </div>
      </div>
    </div>
    <div class="swipe-actions">
      <button class="act-btn act-pass" id="btn-pass">✕</button>
      <button class="act-btn act-info" id="btn-info">ℹ</button>
      <button class="act-btn act-save" id="btn-save">★</button>
    </div>
    <nav class="bottom-nav">
      <div class="nav-indicator"></div>
      <button class="nav-btn active" data-tab="0" data-goto="main"><div class="nav-icon">🍴</div><div class="nav-label">Accueil</div></button>
      <button class="nav-btn" data-tab="1" data-goto="saved"><div class="nav-icon">♥<span class="nav-badge"></span></div><div class="nav-label">Recettes</div></button>
      <button class="nav-btn" data-tab="2" data-goto="calendar"><div class="nav-icon">📅<span class="nav-badge" id="cal-badge-main"></span></div><div class="nav-label">Planning</div></button>
      <button class="nav-btn" data-tab="3" data-goto="shopping"><div class="nav-icon">🛒<span class="nav-badge" id="shop-badge-main"></span></div><div class="nav-label">Courses</div></button>
    
      <button class="nav-btn" data-tab="4" data-goto="create"><div class="nav-icon">✏️</div><div class="nav-label">Créer</div></button>
    </nav>
  </div>

  <!-- ══ DETAIL ══ -->
  <div class="screen" id="detail">
    <div class="det-img" id="det-img">
      <button class="det-back" id="btn-det-back">←</button>
      <button class="det-fav" id="btn-det-fav">★</button>
    </div>
    <div class="det-body">
      <div class="card-tags" style="margin-bottom:7px;"><div class="card-tag" id="det-tag1"></div><div class="card-tag" id="det-tag2"></div>
        <div id="det-price" style="font-size:12px;font-weight:600;color:#FF3E7F;margin-top:4px;"></div></div>
      <div class="det-title" id="det-title"></div>
      <div class="det-desc" id="det-desc"></div>
      <div class="portion-ctrl">
        <div class="portion-lbl">🍽️ Portions</div>
        <div class="portion-btns">
          <button class="portion-btn" id="btn-pm">−</button>
          <div class="portion-num" id="pnum">2</div>
          <button class="portion-btn" id="btn-pp">+</button>
        </div>
      </div>
      <button class="btn-planning" id="btn-add-to-planning">📅 Ajouter au planning</button>
      <div class="sec-title">Ingrédients</div>
      <div class="ing-list" id="det-ing"></div>
      <div class="sec-title">Instructions</div>
      <div class="steps" id="det-steps"></div>
    </div>
    <nav class="bottom-nav">
      <div class="nav-indicator"></div>
      <button class="nav-btn active" data-tab="0" data-goto="main"><div class="nav-icon">🍴</div><div class="nav-label">Accueil</div></button>
      <button class="nav-btn" data-tab="1" data-goto="saved"><div class="nav-icon">♥<span class="nav-badge"></span></div><div class="nav-label">Recettes</div></button>
      <button class="nav-btn" data-tab="2" data-goto="calendar"><div class="nav-icon">📅</div><div class="nav-label">Planning</div></button>
      <button class="nav-btn" data-tab="3" data-goto="shopping"><div class="nav-icon">🛒</div><div class="nav-label">Courses</div></button>
    
      <button class="nav-btn" data-tab="4" data-goto="create"><div class="nav-icon">✏️</div><div class="nav-label">Créer</div></button>
    </nav>
  </div>

  <!-- ══ SAVED ══ -->
  <div class="screen" id="saved">
    <div class="status-bar"><span>9:41</span><span>▲▲ 🔋</span></div>
    <div class="saved-topbar">
      <div><div class="main-title">Mes Recettes</div><div class="count-label" id="saved-count-label">0 recette</div></div>
      <button class="btn-edit-mode" id="btn-toggle-edit">Modifier</button>
    </div>
    <!-- Edit toolbar -->
    <div class="edit-toolbar" id="edit-toolbar">
      <span class="edit-sel-count" id="edit-sel-count">0 sélectionnée</span>
      <div class="edit-actions">
        <button class="btn-edit-action select-all" id="btn-sel-all">Tout</button>
        <button class="btn-edit-action delete-sel" id="btn-del-sel" disabled>🗑 Supprimer</button>
      </div>
    </div>
    <!-- sel-toolbar kept for JS compat -->
    <div class="sel-toolbar" id="sel-toolbar" style="display:none!important">
      <span class="sel-info" id="sel-info"></span>
      <div class="sel-actions">
        <button class="sel-btn all" id="btn-sel-all"></button>
        <button class="sel-btn del" id="btn-del-selected"></button>
        <button class="sel-btn cancel" id="btn-cancel-sel"></button>
        <button class="sel-btn all" id="btn-select-mode" style="display:none"></button>
      </div>
    </div>
    <div id="saved-content" style="flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:0;"></div>
    <nav class="bottom-nav">
      <div class="nav-indicator"></div>
      <button class="nav-btn" data-tab="0" data-goto="main"><div class="nav-icon">🍴</div><div class="nav-label">Accueil</div></button>
      <button class="nav-btn active" data-tab="1" data-goto="saved"><div class="nav-icon">♥<span class="nav-badge"></span></div><div class="nav-label">Recettes</div></button>
      <button class="nav-btn" data-tab="2" data-goto="calendar"><div class="nav-icon">📅</div><div class="nav-label">Planning</div></button>
      <button class="nav-btn" data-tab="3" data-goto="shopping"><div class="nav-icon">🛒</div><div class="nav-label">Courses</div></button>
    
      <button class="nav-btn" data-tab="4" data-goto="create"><div class="nav-icon">✏️</div><div class="nav-label">Créer</div></button>
    </nav>
  </div>

  <!-- ══ CALENDRIER ══ -->
  <div class="screen" id="calendar" style="flex-direction:column;">
    <div class="status-bar"><span>9:41</span><span>▲▲ 🔋</span></div>
    <div class="cal-hdr">
      <button class="icon-btn" id="btn-week-prev" title="Semaine précédente" style="font-size:18px;">‹</button>
      <div style="flex:1;text-align:center;">
        <div class="main-title" style="font-size:16px;margin:0;">Planning</div>
        <div id="cal-week-label" style="font-size:10px;color:#6B7280;font-weight:500;margin-top:1px;"></div>
      </div>
      <div style="display:flex;gap:4px;">
        <button class="icon-btn" id="btn-week-next" title="Semaine suivante" style="font-size:18px;">›</button>
        <button class="icon-btn" id="btn-clear-week" title="Vider la semaine">🗑️</button>
      </div>
    </div>
    <!-- 7 day strip -->
    <!-- Planning indicator -->
    <div id="cal-shop-indicator" style="margin:0 12px 6px;padding:8px 12px;background:#FFF5F8;border-radius:10px;display:none;flex-shrink:0;align-items:center;justify-content:space-between;gap:8px;"></div>
    <div class="week-strip" id="week-strip" style="display:flex;flex-direction:row;width:100%;flex-shrink:0;padding:0 12px 10px;box-sizing:border-box;"></div>
    <div class="cal-body" id="cal-body" style="flex:1;overflow-y:auto;padding:0 12px 16px;"></div>
    <nav class="bottom-nav">
      <div class="nav-indicator"></div>
      <button class="nav-btn" data-tab="0" data-goto="main"><div class="nav-icon">🍴</div><div class="nav-label">Accueil</div></button>
      <button class="nav-btn" data-tab="1" data-goto="saved"><div class="nav-icon">♥<span class="nav-badge"></span></div><div class="nav-label">Recettes</div></button>
      <button class="nav-btn active" data-tab="2" data-goto="calendar"><div class="nav-icon">📅</div><div class="nav-label">Planning</div></button>
      <button class="nav-btn" data-tab="3" data-goto="shopping"><div class="nav-icon">🛒</div><div class="nav-label">Courses</div></button>
    
      <button class="nav-btn" data-tab="4" data-goto="create"><div class="nav-icon">✏️</div><div class="nav-label">Créer</div></button>
    </nav>
  </div>

  <!-- ══ LISTE DE COURSES ══ -->
  <div class="screen" id="shopping" style="flex-direction:column;background:#F2F2F7;">
    <div class="status-bar"><span>9:41</span><span>▲▲ 🔋</span></div>
    <!-- HEADER -->
    <div style="padding:14px 18px 8px;flex-shrink:0;">
      <div style="font-size:24px;font-weight:900;color:#1A1A2E;font-family:inherit;">Liste de courses</div>
      <div id="shop-week-label" style="font-size:11px;font-weight:600;color:#FF3E7F;margin-top:2px;"></div>
      <div id="shop-count-label" style="font-size:11px;color:#6B7280;margin-top:1px;">Générée depuis le planning</div>
      <div id="shop-cost-label" style="display:none;margin-top:6px;display:inline-flex;align-items:center;gap:6px;background:#FFF5F8;border-radius:20px;padding:4px 10px 4px 8px;">
        <span style="font-size:14px;">💰</span>
        <span id="shop-cost-value" style="font-size:13px;font-weight:700;color:#FF3E7F;"></span>
        <span style="font-size:10px;color:#9CA3AF;">estimé</span>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px;">
        <button id="btn-shop-history" style="background:none;border:none;font-size:11px;font-weight:700;color:#9CA3AF;cursor:pointer;padding:4px 8px;border-radius:8px;">📋 Historique</button>
        <button id="btn-courses-faites" style="background:linear-gradient(135deg,#10B981,#059669);color:#fff;border:none;font-size:11px;font-weight:700;cursor:pointer;padding:6px 12px;border-radius:10px;">✓ Courses faites</button>
      </div>
    </div>
    <!-- Recettes source -->
    <div id="shop-recipes-summary" style="margin:0 14px 10px;padding:10px 14px;background:#fff;border-radius:12px;box-shadow:0 1px 4px rgba(0,0,0,.06);flex-shrink:0;display:none;"></div>
    <!-- BODY (populated by JS) -->
    <div id="shop-body" style="flex:1;overflow-y:auto;padding:0 14px 80px;position:relative;"></div>

    <!-- Bouton + flottant -->
    <button id="btn-add-manual" onclick="openAddManualModal()" style="position:absolute;bottom:72px;right:16px;width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,#FF3E7F,#FF6B6B);border:none;color:#fff;font-size:28px;cursor:pointer;box-shadow:0 4px 16px rgba(255,62,127,.4);display:flex;align-items:center;justify-content:center;z-index:10;">+</button>

    <!-- Modal historique courses -->
    <div id="modal-shop-history" style="display:none;position:absolute;inset:0;background:rgba(0,0,0,.5);z-index:100;align-items:flex-end;">
      <div style="background:#F2F2F7;border-radius:24px 24px 0 0;padding:24px 20px;width:100%;box-sizing:border-box;max-height:80vh;overflow-y:auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <div style="font-family:'Playfair Display',Georgia,serif;font-size:20px;font-weight:700;color:#1A1A2E;">📋 Historique</div>
          <button onclick="closeShopHistory()" style="background:none;border:none;font-size:22px;color:#9CA3AF;cursor:pointer;">✕</button>
        </div>
        <div id="shop-history-body"></div>
      </div>
    </div>

    <!-- Modal ajout manuel -->
    <div id="modal-add-manual" style="display:none;position:absolute;inset:0;background:rgba(0,0,0,.5);z-index:100;align-items:flex-end;">
      <div style="background:#fff;border-radius:24px 24px 0 0;padding:24px 20px;width:100%;box-sizing:border-box;">
        <div style="font-family:'Playfair Display',Georgia,serif;font-size:20px;font-weight:700;color:#1A1A2E;margin-bottom:16px;">Ajouter un article</div>
        <input id="manual-item-input" type="text" placeholder="Ex: Café, PQ, Lait..." style="width:100%;padding:12px 14px;border:2px solid #F0F0F5;border-radius:12px;font-size:14px;font-family:inherit;outline:none;box-sizing:border-box;margin-bottom:12px;"/>
        <div style="margin-bottom:16px;">
          <div style="font-size:11px;font-weight:700;color:#6B7280;letter-spacing:.5px;margin-bottom:8px;">RAYON</div>
          <div id="manual-cat-picker" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
        </div>
        <div style="display:flex;gap:10px;">
          <button onclick="closeAddManualModal()" style="flex:1;padding:14px;border-radius:14px;border:2px solid #F0F0F5;background:transparent;font-size:14px;font-weight:600;cursor:pointer;color:#6B7280;">Annuler</button>
          <button onclick="confirmAddManual()" style="flex:2;padding:14px;border-radius:14px;border:none;background:linear-gradient(135deg,#FF3E7F,#FF6B6B);color:#fff;font-size:14px;font-weight:700;cursor:pointer;">Ajouter ✓</button>
        </div>
      </div>
    </div>

    <nav class="bottom-nav">
      <div class="nav-indicator"></div>
      <button class="nav-btn" data-tab="0" data-goto="main"><div class="nav-icon">🍴</div><div class="nav-label">Accueil</div></button>
      <button class="nav-btn" data-tab="1" data-goto="saved"><div class="nav-icon">♥<span class="nav-badge"></span></div><div class="nav-label">Recettes</div></button>
      <button class="nav-btn" data-tab="2" data-goto="calendar"><div class="nav-icon">📅</div><div class="nav-label">Planning</div></button>
      <button class="nav-btn active" data-tab="3" data-goto="shopping"><div class="nav-icon">🛒</div><div class="nav-label">Courses</div></button>
    
      <button class="nav-btn" data-tab="4" data-goto="create"><div class="nav-icon">✏️</div><div class="nav-label">Créer</div></button>
    </nav>
  </div>

  <!-- ══ PREFS ══ -->
  <div class="screen" id="prefs">
    <div class="status-bar"><span>9:41</span><span>▲▲ 🔋</span></div>
    <div class="prefs-body">
      <div class="prof-hdr"><div class="prof-av">👩</div><div class="prof-name">Marie Dupont</div><div class="prof-sub"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="fa979b88939fba9f829f978a969fd49c88">[email&#160;protected]</a> • Végétarien</div></div>
      <div class="prefs-sec">
        <div class="prefs-row"><div class="prefs-ic">🥗</div><div class="prefs-lbl">Régime alimentaire</div><div class="prefs-arr">›</div></div>
        <div class="prefs-row"><div class="prefs-ic">⚠️</div><div class="prefs-lbl">Allergies</div><div class="prefs-arr">›</div></div>
      </div>
      <div class="prefs-sec">
        <div class="prefs-row" id="tog0"><div class="prefs-ic">🔔</div><div class="prefs-lbl">Notifications</div><div class="toggle on"></div></div>
        <div class="prefs-row" id="tog1"><div class="prefs-ic">🌙</div><div class="prefs-lbl">Mode sombre</div><div class="toggle"></div></div>
        <div class="prefs-row" id="tog2"><div class="prefs-ic">🌍</div><div class="prefs-lbl">Recettes internationales</div><div class="toggle on"></div></div>
      </div>
      <div class="prefs-sec">
        <div class="prefs-row" id="btn-logout"><div class="prefs-ic">🚪</div><div class="prefs-lbl" style="color:var(--pink)">Se déconnecter</div></div>
      </div>
    </div>
    <nav class="bottom-nav">
      <div class="nav-indicator"></div>
      <button class="nav-btn" data-tab="0" data-goto="main"><div class="nav-icon">🍴</div><div class="nav-label">Accueil</div></button>
      <button class="nav-btn" data-tab="1" data-goto="saved"><div class="nav-icon">♥<span class="nav-badge"></span></div><div class="nav-label">Recettes</div></button>
      <button class="nav-btn" data-tab="2" data-goto="calendar"><div class="nav-icon">📅</div><div class="nav-label">Planning</div></button>
      <button class="nav-btn" data-tab="3" data-goto="shopping"><div class="nav-icon">🛒</div><div class="nav-label">Courses</div></button>
    
      <button class="nav-btn" data-tab="4" data-goto="create"><div class="nav-icon">✏️</div><div class="nav-label">Créer</div></button>
    </nav>
  </div>

  <!-- ══ MODAL: Filtre swipe ══ -->
  <div class="modal" id="filt-modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Filtrer</div>
    <div class="filt-sec-title">Temps</div>
    <div class="filt-chips">
      <div class="filt-chip selected" id="fc0">⚡ &lt;15 min</div>
      <div class="filt-chip" id="fc1">🕐 15–30 min</div>
      <div class="filt-chip" id="fc2">🕑 30–60 min</div>
    </div>
    <div class="filt-sec-title">Difficulté</div>
    <div class="filt-chips">
      <div class="filt-chip selected" id="fc3">😊 Facile</div>
      <div class="filt-chip" id="fc4">🤔 Moyen</div>
      <div class="filt-chip" id="fc5">👩‍🍳 Expert</div>
    </div>
    <button class="btn-p" id="btn-apply-filt" style="margin-top:16px;">Appliquer</button>
  </div>

  <!-- ══ MODAL: Ajouter au planning ══ -->
  <div class="modal" id="plan-modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Ajouter au planning</div>
    <div style="font-size:11px;font-weight:700;color:var(--gray);letter-spacing:.5px;text-transform:uppercase;margin-bottom:8px;">Jour</div>
    <div class="plan-day-grid" id="plan-day-grid"></div>
    <div style="font-size:11px;font-weight:700;color:var(--gray);letter-spacing:.5px;text-transform:uppercase;margin-bottom:8px;">Moment</div>
    <div class="plan-time-row">
      <button class="plan-time-btn selected" id="pt-midi">🌤️ Midi</button>
      <button class="plan-time-btn" id="pt-soir">🌙 Soir</button>
    </div>
    <button class="btn-p" id="btn-confirm-plan">Confirmer</button>
  </div>

  <!-- ══ CREATE RECIPE ══ -->
  <div class="screen" id="create" style="flex-direction:column;">
    <div class="status-bar"><span>9:41</span><span>▲▲ 🔋</span></div>

    <!-- Header -->
    <div class="cr-hdr">
      <div class="cr-title">Mes Créations</div>
      <button class="cr-btn-new" id="btn-show-form">+ Nouvelle</button>
    </div>

    <!-- Tabs: liste | formulaire -->
    <div class="cr-tabs">
      <div class="cr-tab active" id="cr-tab-list" style="cursor:pointer;">Mes recettes</div>
      <div class="cr-tab" id="cr-tab-form" style="cursor:pointer;">Créer une recette</div>
    </div>

    <!-- LIST PANEL -->
    <div class="cr-body" id="cr-panel-list">
      <div id="cr-list-content"></div>
    </div>

    <!-- FORM PANEL (hidden by default) -->
    <div class="cr-body" id="cr-panel-form" style="display:none;">

      <!-- Photo -->
      <div class="cf-photo" id="cf-photo-zone">
        <div class="cf-photo-icon">📷</div>
        <div class="cf-photo-lbl">Ajouter une photo (optionnel)</div>
        <input type="file" id="cf-photo-input" accept="image/*" style="display:none;">
      </div>

      <!-- Emoji + couleur card -->
      <div class="cf-card">
        <div class="cf-card-title">Apparence dans le swipe</div>
        <div class="cf-emoji-row" id="cf-emoji-picker">
          <button class="cf-emoji-btn sel" data-emoji="🍳">🍳</button>
          <button class="cf-emoji-btn" data-emoji="🥘">🥘</button>
          <button class="cf-emoji-btn" data-emoji="🍜">🍜</button>
          <button class="cf-emoji-btn" data-emoji="🥗">🥗</button>
          <button class="cf-emoji-btn" data-emoji="🍕">🍕</button>
          <button class="cf-emoji-btn" data-emoji="🍰">🍰</button>
          <button class="cf-emoji-btn" data-emoji="🥩">🥩</button>
          <button class="cf-emoji-btn" data-emoji="🍱">🍱</button>
          <button class="cf-emoji-btn" data-emoji="🌮">🌮</button>
          <button class="cf-emoji-btn" data-emoji="🥪">🥪</button>
        </div>
        <div class="cf-grad-row" id="cf-grad-picker">
          <div class="cf-swatch sel" data-grad="linear-gradient(135deg,#FF6B6B,#FFE66D)" style="background:linear-gradient(135deg,#FF6B6B,#FFE66D);"></div>
          <div class="cf-swatch" data-grad="linear-gradient(135deg,#a8edea,#fed6e3)" style="background:linear-gradient(135deg,#a8edea,#fed6e3);"></div>
          <div class="cf-swatch" data-grad="linear-gradient(135deg,#84fab0,#8fd3f4)" style="background:linear-gradient(135deg,#84fab0,#8fd3f4);"></div>
          <div class="cf-swatch" data-grad="linear-gradient(135deg,#f6d365,#fda085)" style="background:linear-gradient(135deg,#f6d365,#fda085);"></div>
          <div class="cf-swatch" data-grad="linear-gradient(135deg,#f093fb,#f5576c)" style="background:linear-gradient(135deg,#f093fb,#f5576c);"></div>
          <div class="cf-swatch" data-grad="linear-gradient(135deg,#4facfe,#00f2fe)" style="background:linear-gradient(135deg,#4facfe,#00f2fe);"></div>
          <div class="cf-swatch" data-grad="linear-gradient(135deg,#43e97b,#38f9d7)" style="background:linear-gradient(135deg,#43e97b,#38f9d7);"></div>
          <div class="cf-swatch" data-grad="linear-gradient(135deg,#fa709a,#fee140)" style="background:linear-gradient(135deg,#fa709a,#fee140);"></div>
        </div>
      </div>

      <!-- Infos principales -->
      <div class="cf-card">
        <div class="cf-card-title">Informations</div>
        <div class="cf-row">
          <span class="cf-lbl">Titre *</span>
          <input class="cf-inp" id="cf-title" type="text" placeholder="Ma recette maison" maxlength="50">
        </div>
        <div class="cf-row">
          <span class="cf-lbl">Description</span>
          <input class="cf-inp" id="cf-desc" type="text" placeholder="En deux mots..." maxlength="120">
        </div>
        <div class="cf-row">
          <span class="cf-lbl">Temps de prép.</span>
          <input class="cf-inp" id="cf-time" type="text" placeholder="ex: 30 min" maxlength="20">
        </div>
        <div class="cf-row">
          <span class="cf-lbl">Portions</span>
          <input class="cf-inp" id="cf-portions" type="number" min="1" max="20" placeholder="2" style="max-width:60px;">
        </div>
        <div class="cf-row">
          <span class="cf-lbl">Nb personnes</span>
          <input class="cf-inp" id="cf-persons" type="number" min="1" max="20" placeholder="2" style="max-width:60px;">
        </div>
      </div>

      <!-- Tags -->
      <div class="cf-card">
        <div class="cf-card-title">Catégories / Tags</div>
        <div class="cf-tags-wrap" id="cf-tags-preset">
          <button class="cf-tag sel" data-tag="MAISON">MAISON</button>
          <button class="cf-tag" data-tag="RAPIDE">RAPIDE</button>
          <button class="cf-tag" data-tag="VÉGÉTARIEN">VÉGÉTARIEN</button>
          <button class="cf-tag" data-tag="ÉPICÉ">ÉPICÉ</button>
          <button class="cf-tag" data-tag="DESSERT">DESSERT</button>
          <button class="cf-tag" data-tag="PASTA">PASTA</button>
          <button class="cf-tag" data-tag="FAMILIAL">FAMILIAL</button>
          <button class="cf-tag" data-tag="HEALTHY">HEALTHY</button>
          <button class="cf-tag" data-tag="CLASSIQUE">CLASSIQUE</button>
          <button class="cf-tag" data-tag="FRAIS">FRAIS</button>
        </div>
        <div class="cf-tag-custom-row">
          <input class="cf-tag-inp" id="cf-tag-custom" type="text" placeholder="Tag personnalisé…" maxlength="20">
          <button class="cf-tag-add-btn" id="cf-tag-add-btn">+</button>
        </div>
      </div>

      <!-- Ingrédients -->
      <div class="cf-card">
        <div class="cf-card-title">Ingrédients</div>
        <div class="cf-ing-list" id="cf-ing-list"></div>
        <div class="cf-add-ing" id="cf-add-ing">
          <span style="font-size:18px;line-height:1;">+</span> Ajouter un ingrédient
        </div>
      </div>

      <!-- Préparation -->
      <div class="cf-card">
        <div class="cf-card-title">Préparation</div>
        <textarea class="cf-textarea" id="cf-steps" placeholder="Décrivez les étapes de préparation...&#10;Vous pouvez écrire librement."></textarea>
      </div>

      <!-- Submit -->
      <button class="cf-submit" id="cf-submit">✓ Enregistrer la recette</button>
    </div>

    <nav class="bottom-nav">
      <div class="nav-indicator"></div>
      <button class="nav-btn" data-tab="0" data-goto="main"><div class="nav-icon">🍴</div><div class="nav-label">Accueil</div></button>
      <button class="nav-btn" data-tab="1" data-goto="saved"><div class="nav-icon">♥<span class="nav-badge"></span></div><div class="nav-label">Recettes</div></button>
      <button class="nav-btn" data-tab="2" data-goto="calendar"><div class="nav-icon">📅<span class="nav-badge"></span></div><div class="nav-label">Planning</div></button>
      <button class="nav-btn" data-tab="3" data-goto="shopping"><div class="nav-icon">🛒<span class="nav-badge"></span></div><div class="nav-label">Courses</div></button>
      <button class="nav-btn active" data-tab="4" data-goto="create"><div class="nav-icon">✏️</div><div class="nav-label">Créer</div></button>
    </nav>
  </div>


  <!-- ══ PROFILE / SETTINGS ══ -->
  <div class="screen" id="profile" style="flex-direction:column;">
    <div class="status-bar"><span>9:41</span><span>▲▲ 🔋</span></div>
    <div class="prof2-hdr">
      <button class="prof2-back" id="btn-profile-back">‹</button>
      <div class="prof2-title">Mon profil</div>
      <button class="prof2-save" id="btn-profile-save" style="width:auto;margin:0;padding:8px 16px;font-size:12px;box-shadow:none;">Sauvegarder</button>
    </div>

    <div class="prof2-body">
      <!-- Avatar -->
      <div class="prof2-avatar">
        <div class="prof2-av-circle">👤</div>
        <div class="prof2-av-name" id="prof-display-name">Mon compte</div>
        <div class="prof2-av-sub" id="prof-display-diet">Omnivore</div>
      </div>

      <!-- Compte -->
      <div class="prof2-sec">
        <div class="prof2-sec-title">Compte</div>
        <div class="prof2-card">
          <div class="prof2-row">
            <span class="prof2-row-ic">✉️</span>
            <span class="prof2-row-lbl">Email</span>
            <input class="prof2-inp" id="prof-email" type="email" placeholder="mon@email.fr" maxlength="60">
          </div>
          <div class="prof2-row">
            <span class="prof2-row-ic">🔒</span>
            <span class="prof2-row-lbl">Mot de passe</span>
            <input class="prof2-inp" id="prof-password" type="password" placeholder="••••••••" maxlength="40">
          </div>
          <div class="prof2-row">
            <span class="prof2-row-ic">💳</span>
            <span class="prof2-row-lbl">Abonnement</span>
            <span class="prof2-row-val">Gratuit</span>
            <span class="prof2-row-arr">›</span>
          </div>
        </div>
      </div>

      <!-- Régime alimentaire -->
      <div class="prof2-sec">
        <div class="prof2-sec-title">Régime alimentaire</div>
        <div class="prof2-card prof2-diet-grid" id="prof-diet-grid">
          <div class="prof2-diet-opt sel" data-diet="Omnivore">
            <div class="prof2-diet-ic">🍖</div>
            <div class="prof2-diet-info"><h4>Omnivore</h4><p>Je mange de tout</p></div>
            <div class="prof2-diet-chk">✓</div>
          </div>
          <div class="prof2-diet-opt" data-diet="Végétarien">
            <div class="prof2-diet-ic">🥗</div>
            <div class="prof2-diet-info"><h4>Végétarien</h4><p>Pas de viande ni poisson</p></div>
            <div class="prof2-diet-chk"></div>
          </div>
          <div class="prof2-diet-opt" data-diet="Vegan">
            <div class="prof2-diet-ic">🌱</div>
            <div class="prof2-diet-info"><h4>Vegan</h4><p>Aucun produit animal</p></div>
            <div class="prof2-diet-chk"></div>
          </div>
          <div class="prof2-diet-opt" data-diet="Keto">
            <div class="prof2-diet-ic">🥩</div>
            <div class="prof2-diet-info"><h4>Keto</h4><p>Faible en glucides</p></div>
            <div class="prof2-diet-chk"></div>
          </div>
        </div>
      </div>

      <!-- Allergies -->
      <div class="prof2-sec">
        <div class="prof2-sec-title">Allergies & intolérances</div>
        <div class="prof2-card">
          <div class="prof2-allergy-grid" id="prof-allergy-grid">
            <div class="prof2-allergy-chip" data-allergy="Arachides">🥜 Arachides</div>
            <div class="prof2-allergy-chip" data-allergy="Lactose">🥛 Lactose</div>
            <div class="prof2-allergy-chip" data-allergy="Gluten">🌾 Gluten</div>
            <div class="prof2-allergy-chip" data-allergy="Crustacés">🦐 Crustacés</div>
            <div class="prof2-allergy-chip" data-allergy="Oeufs">🥚 Oeufs</div>
            <div class="prof2-allergy-chip" data-allergy="Poisson">🐟 Poisson</div>
            <div class="prof2-allergy-chip" data-allergy="Noix">🌰 Noix</div>
            <div class="prof2-allergy-chip" data-allergy="Soja">🫘 Soja</div>
          </div>
        </div>
      </div>

      <!-- Aliments non aimés -->
      <div class="prof2-sec">
        <div class="prof2-sec-title">Aliments non aimés</div>
        <div class="prof2-card">
          <div class="prof2-dislike-wrap" id="prof-dislike-tags"></div>
          <div class="prof2-dislike-inp-row">
            <input class="prof2-dislike-inp" id="prof-dislike-inp" type="text" placeholder="Ex: coriandre, anchois…" maxlength="30">
            <button class="prof2-dislike-add" id="prof-dislike-add">+</button>
          </div>
        </div>
      </div>

      <!-- Paramètres -->
      <div class="prof2-sec">
        <div class="prof2-sec-title">Paramètres</div>
        <div class="prof2-card">
          <div class="prof2-row" id="prof-tog-notif" style="cursor:pointer;">
            <span class="prof2-row-ic">🔔</span>
            <span class="prof2-row-lbl">Notifications</span>
            <div class="toggle on" id="tog-notif"></div>
          </div>
          <div class="prof2-row" id="prof-tog-dark" style="cursor:pointer;">
            <span class="prof2-row-ic">🌙</span>
            <span class="prof2-row-lbl">Mode sombre</span>
            <div class="toggle" id="tog-dark"></div>
          </div>
        </div>
      </div>

      <!-- Danger zone -->
      <div class="prof2-sec">
        <div class="prof2-card">
          <div class="prof2-row" id="btn-prof-logout" style="cursor:pointer;">
            <span class="prof2-row-ic">🚪</span>
            <span class="prof2-row-lbl prof2-danger">Se déconnecter</span>
          </div>
        </div>
      </div>

    </div>
  </div>

</div><!-- /phone -->

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script data-cfasync="false">
(function(){"use strict";

/* ═══════════════════════════════════════════
   RECIPES DATA
═══════════════════════════════════════════ */
var RECIPES=[
{id:1,emoji:"🧀",title:"Gratin de Ravioles du Dauphiné",
desc:"Ravioles du Dauphiné IGP gratinées à la crème entière et au gruyère, simplement poivrées.",
tag1:"PASTA",tag2:"VÉGÉTARIEN",time:"30 min",grad:"linear-gradient(135deg,#F6D365,#FDA085)",
ing:[
  ["Ravioles du Dauphiné IGP surgelées","500g"],
  ["Crème liquide entière","650ml"],
  ["Gruyère râpé","100g"],
  ["Poivre","à goût"]
],
steps:[
  "Préchauffer le four à 210°C.",
  "Verser les ravioles surgelées détachées dans un plat à gratin sans les décongeler.",
  "Ajouter la crème liquide, poivrer selon votre goût et parsemer de gruyère râpé.",
  "Enfourner 25 minutes jusqu’à ce que le dessus soit bien doré.",
  "Servir immédiatement, accompagné d’une salade verte."
]},
  {id:2,emoji:"🥗",title:"Salade Niçoise",desc:"La salade emblématique de Nice : thon, anchois, olives, oeufs et tomates.",tag1:"SALADE",tag2:"TRADITIONNEL",time:"15 min",grad:"linear-gradient(135deg,#a8e6cf,#56ab2f)",
   ing:[["Thon en boîte","160g"],["Oeufs","2"],["Tomates","3"],["Olives noires","50g"],["Anchois","6 filets"],["Haricots verts","100g"]],
   steps:["Cuire les oeufs 9 min, refroidir et couper en quartiers.","Blanchir les haricots verts 5 min, refroidir.","Disposer tous les ingrédients sur un lit de salade.","Assaisonner d'huile d'olive, vinaigre, sel et poivre."]},
  {id:3,emoji:"🥑",title:"Toast Avocat Burrata",desc:"Pain grillé, avocat citronné, burrata, dukkah et menthe fraîche.",tag1:"BRUNCH",tag2:"VEGGIE",time:"10 min",grad:"linear-gradient(135deg,#84fab0,#8fd3f4)",
   ing:[["Pain de campagne","2 tranches"],["Avocat","1"],["Burrata","1"],["Dukkah","1 c.s."],["Citron","½"]],
   steps:["Griller le pain jusqu'à dorure.","Écraser l'avocat avec jus de citron, sel et poivre.","Tartiner le pain d'avocat, déposer la burrata déchirée.","Parsemer de dukkah et décorer de feuilles de menthe."]},
  {id:4,emoji:"🥟",title:"Tortellini Épinard Crème",desc:"Tortellini fondants, épinards sautés et sauce crème au gruyère.",tag1:"VÉGÉTARIEN",tag2:"RAPIDE",time:"25 min",grad:"linear-gradient(135deg,#84fab0,#8fd3f4)",
   ing:[["Tortellini fromage","500 g"],["Épinards frais","300 g"],["Crème fraîche","20 cl"],["Gruyère râpé","100 g"],["Ail","1 gousse"],["Huile d'olive","1 c.s."],["Sel","Au goût"],["Poivre","Au goût"]],
   steps:["Cuire les tortellini dans une grande eau salée puis égoutter.","Faire revenir l'ail dans l'huile, ajouter les épinards et laisser tomber.","Incorporer la crème, saler, poivrer et laisser mijoter 3 à 5 min.","Ajouter les tortellini, mélanger délicatement puis incorporer le gruyère jusqu'à fonte complète."]},
  {id:5,emoji:"🌶️",title:"Chili Con Carne Rapide",desc:"Viande hachée, haricots rouges et tomates, relevés d'épices, prêt en moins de 30 min.",tag1:"ÉPICÉ",tag2:"RAPIDE",time:"30 min",grad:"linear-gradient(135deg,#f6d365,#fda085)",
   ing:[["Viande hachée de boeuf","500 g"],["Haricots rouges en conserve","400 g"],["Tomates concassées en conserve","400 g"],["Oignon","1"],["Ail","2 gousses"],["Piment en poudre","1 c.c."],["Cumin en poudre","1 c.c."],["Huile d'olive","2 c.s."],["Sel","Au goût"],["Poivre","Au goût"]],
   steps:["Emincer l'oignon et hacher l'ail.","Faire revenir l'oignon et l'ail dans l'huile chaude.","Ajouter la viande hachée et cuire jusqu'a dorure.","Ajouter tomates, haricots, piment et cumin, saler et poivrer.","Laisser mijoter 10 a 15 min, servir chaud."]},
  {id:6,emoji:"🥪",title:"Croc Monsieur Salade Chevre",desc:"Croque-monsieur dore au jambon et fromage, salade verte et chevre chaud.",tag1:"RAPIDE",tag2:"CLASSIQUE",time:"15 min",grad:"linear-gradient(135deg,#fceabb,#f8b500)",
   ing:[["Pain de mie","8 tranches"],["Jambon","4 tranches"],["Fromage rape","100 g"],["Beurre","20 g"],["Salade verte","150 g"],["Chevre","100 g"],["Miel","1 c.c."],["Huile d'olive","1 c.s."],["Sel","Au gout"],["Poivre","Au gout"]],
   steps:["Prechauffer le four a 200 C.","Preparer les croques avec beurre, jambon et fromage, enfourner 10 min.","Couper le chevre en rondelles, dorer au four.","Assaisonner la salade, servir avec les croques et le chevre chaud."]},
  {id:7,emoji:"🌭",title:"Saucisses et Lentilles",desc:"Saucisses dorees servies sur un lit de lentilles mijotees aux aromates.",tag1:"RAPIDE",tag2:"CLASSIQUE",time:"25 min",grad:"linear-gradient(135deg,#d4fc79,#96e6a1)",
   ing:[["Saucisses","4"],["Lentilles vertes","200 g"],["Carotte","1"],["Oignon","1"],["Ail","1 gousse"],["Bouillon de legumes","400 ml"],["Huile d'olive","1 c.s."],["Sel","Au gout"],["Poivre","Au gout"]],
   steps:["Emincer oignon, carotte et hacher l'ail.","Faire revenir les saucisses a la poele jusqu'a dorure, reserver.","Faire revenir les legumes dans la meme poele, ajouter les lentilles et le bouillon.","Cuire 15 min jusqu'a tendrete, assaisonner.","Servir les lentilles avec les saucisses dorees par-dessus."]}
,
  {id:8,emoji:"🍝",title:"Spaghetti Bolognaise",desc:"Spaghetti avec sauce tomate et viande hachee parfumee aux herbes.",tag1:"RAPIDE",tag2:"CLASSIQUE",time:"25 min",grad:"linear-gradient(135deg,#f093fb,#f5576c)",
   ing:[["Spaghetti","250 g"],["Viande hachee","300 g"],["Tomates concassees","400 g"],["Oignon","1"],["Ail","1 gousse"],["Huile d'olive","1 c.s."],["Sel","Au gout"],["Poivre","Au gout"],["Herbes de Provence","1 c.c."]],
   steps:["Faire revenir l'oignon et l'ail haches dans l'huile.","Ajouter la viande et cuire jusqu'a dorure.","Incorporer les tomates et herbes, laisser mijoter 15 min.","Cuire les spaghetti, servir avec la sauce."]},
  {id:9,emoji:"🍚",title:"Risotto Crémeux aux Champignons",desc:"Risotto italien onctueux au parmesan et champignons sautés.",tag1:"ITALIEN",tag2:"CRÉMEUX",time:"30 min",grad:"linear-gradient(135deg,#d4fc79,#96e6a1)",
   ing:[["Riz arborio","200g"],["Champignons de Paris","250g"],["Bouillon de légumes","1 L"],["Parmesan râpé","60g"],["Oignon","1"],["Beurre","30g"],["Vin blanc","10 cl"],["Huile d'olive","1 c.s."],["Sel","Au gout"],["Poivre","Au gout"]],
   steps:["Chauffer le bouillon dans une casserole et maintenir frémissant.","Faire revenir l'oignon émincé dans l'huile d'olive et la moitié du beurre.","Ajouter le riz et nacrer 2 minutes.","Déglacer avec le vin blanc et laisser évaporer.",
   "Incorporer le bouillon chaud louche par louche en remuant jusqu'à absorption.","Ajouter les champignons sautés à mi-cuisson.","Hors du feu incorporer le reste du beurre et le parmesan.","Assaisonner et servir immédiatement."]},
  {id:10,emoji:"🍝",title:"Pates au Pesto",desc:"Pates rapides avec sauce pesto et parmesan.",tag1:"RAPIDE",tag2:"VEGETARIEN",time:"15 min",grad:"linear-gradient(135deg,#f6d365,#fda085)",
   ing:[["Pates","250 g"],["Pesto","3 c.s."],["Parmesan rape","30 g"],["Sel","Au gout"],["Poivre","Au gout"]],
   steps:["Cuire les pates, egoutter.","Melanger avec le pesto et parmesan.","Servir chaud."]},
  {id:11,emoji:"🥗",title:"Salade de Riz au Thon",desc:"Salade fraîche et rapide de riz avec thon, tomates cerises, mais et mayonnaise.",tag1:"SALADE",tag2:"RAPIDE",time:"15 min",grad:"linear-gradient(135deg,#a8e6cf,#56ab2f)",
   ing:[["Riz cuit","200g"],["Thon en boîte","120g"],["Tomates cerises","150g"],["Mayonnaise","2 c.s."],["MÄIS","250g"],["Sel","Au gout"],["Poivre","Au gout"]],
   steps:["Cuire le riz et laisser refroidir.","Couper les tomates cerises en deux.","Mélanger le riz, le thon émietté et les tomates ainsi que le mÄis.","Ajouter la mayonnaise et assaisonner de sel et poivre.","Bien mélanger et servir frais."]},
   {id:12,emoji:"🧀",title:"Tartiflette Savoyarde",desc:"Gratin de pommes de terre, lardons et reblochon crémeux, plat traditionnel de Savoie.",tag1:"FRANÇAIS",tag2:"CONFORT",time:"45 min",grad:"linear-gradient(135deg,#fceabb,#f8b500)",
   ing:[["Pommes de terre","600g"],["Lardons fumés","200g"],["Reblochon","250g"],["Oignon","1"],["Crème fraîche","10 cl"],["Beurre","20g"],["Sel","Au gout"],["Poivre","Au gout"]],
   steps:["Préchauffer le four à 200°C.","Éplucher et couper les pommes de terre en rondelles, les précuire 10 min à l'eau bouillante.","Faire revenir l'oignon émincé et les lardons dans une poêle.","Beurrer un plat à gratin, disposer une couche de pommes de terre, ajouter les lardons et oignons, répéter.","Verser la crème fraîche, recouvrir de reblochon coupé en deux.","Enfourner 25 min jusqu'à gratinage doré et servir chaud."]},
  {id:13,emoji:"🥞",title:"Galette Bretonne Complète",
desc:"Galette de sarrasin traditionnelle garnie de jambon, œuf et fromage.",
tag1:"FRANÇAIS",tag2:"BRETON",time:"25 min",grad:"linear-gradient(135deg,#fcd3a5,#f9a36c)",
ing:[["Farine de sarrasin","100g"],["Œuf","1"],["Lait","150ml"],["Jambon","1 tranche"],["Fromage râpé","30g"],["Beurre","10g"],["Sel","Au goût"],["Poivre","Au goût"]],
steps:["Préparer la pâte en mélangeant farine, œuf, lait et une pincée de sel.","Faire chauffer une poêle avec un peu de beurre.","Verser une louche de pâte et étaler en cercle.","Cuire 2-3 min puis retourner la galette.","Ajouter le jambon, l'œuf et le fromage, plier et laisser cuire 2-3 min supplémentaires.","Servir chaud."]},

{id:14,emoji:"🍳",title:"Omelette Jambon Fromage",
desc:"Omelette moelleuse au jambon et fromage, servie avec une salade fraîche.",
tag1:"CLASSIQUE",tag2:"RAPIDE",time:"15 min",grad:"linear-gradient(135deg,#fceabb,#f8b500)",
ing:[["Œufs","3"],["Jambon","2 tranches"],["Fromage râpé","50g"],["Beurre","10g"],["Sel","Au goût"],["Poivre","Au goût"],["Salade verte","1 poignée"],["Vinaigrette","Au goût"]],
steps:["Battre les œufs avec sel et poivre.","Faire fondre le beurre dans une poêle.","Verser les œufs battus et cuire à feu moyen.","Ajouter le jambon coupé en dés et le fromage râpé.","Plier l'omelette et cuire encore 1-2 min.","Servir avec la salade assaisonnée."]},

{id:15,emoji:"🥢",title:"Riz aux Poireaux, Carottes et Escalope Marinée",
desc:"Riz crémeux aux poireaux et carottes accompagné d'une escalope marinée à la sauce soja.",
tag1:"ASIE",tag2:"PROTÉINÉ",time:"30 min",grad:"linear-gradient(135deg,#fbd3e9,#bb377d)",
ing:[["Riz","200g"],["Poireaux","2"],["Carottes","2"],["Crème fraîche","15cl"],["Escalope de poulet","1"],["Sauce soja","2 c.s."],["Huile d'olive","1 c.s."],["Sel","Au goût"],["Poivre","Au goût"]],
steps:["Couper les poireaux et carottes en rondelles fines.","Faire revenir les légumes dans l'huile d'olive 5 min.","Ajouter le riz et remuer 2 min, puis verser 50 cl d'eau et cuire 15 min à feu doux.","Pendant ce temps, faire mariner l'escalope dans la sauce soja 10 min.","Poêler l'escalope 5-7 min de chaque côté.","Incorporer la crème aux légumes et riz, assaisonner.","Servir le riz crémeux accompagné de l'escalope marinée."]},

{id:16,emoji:"🍜",title:"Nouilles Sautées au Porc Caramel",
desc:"Nouilles sautées aux champignons, carottes, œufs brouillés et porc caramélisé à la sauce soja.",
tag1:"ASIE",tag2:"ÉPICÉ",time:"30 min",grad:"linear-gradient(135deg,#fceabb,#f8b500)",
ing:[["Nouilles","200g"],["Porc émincé","150g"],["Champignons","150g"],["Carottes","2"],["Œufs","2"],["Sauce soja","3 c.s."],["Sucre","1 c.s."],["Huile","1 c.s."],["Sel","Au goût"],["Poivre","Au goût"]],
steps:["Cuire les nouilles selon les instructions et réserver.","Faire revenir les champignons et carottes émincés dans l'huile 5 min.","Battre les œufs et les brouiller dans une poêle séparée.","Dans une poêle, faire caraméliser le porc avec le sucre et la sauce soja.","Ajouter les légumes sautés et les nouilles, mélanger le tout.","Incorporer les œufs brouillés, assaisonner de sel et poivre.","Servir chaud."]},

{id:17,emoji:"🍝",title:"Lasagnes au Bœuf Classiques",
desc:"Lasagnes traditionnelles à la viande de bœuf hachée, sauce tomate, béchamel et emmental gratiné.",
tag1:"ITALIEN",tag2:"CLASSIQUE",time:"1h10 min",grad:"linear-gradient(135deg,#f6d365,#fda085)",
ing:[["Pâtes à lasagnes","1 paquet"],["Viande de bœuf hachée","1kg"],["Oignon","1"],["Carotte","1"],["Ail","1 gousse"],["Huile d'olive","2 c.s."],["Tomate concentrée","2 c.s."],["Bouillon de volaille","15cl"],["Béchamel","1l"],["Emmental râpé","200g"],["Sel","Au goût"],["Poivre","Au goût"]],
steps:["Préchauffer le four à 180 °C.","Hacher finement l'oignon, la carotte et l'ail.","Faire revenir les légumes dans l'huile d'olive puis ajouter la viande de bœuf et cuire 10 min.","Assaisonner, ajouter le concentré de tomate et le bouillon de volaille.","Dans un plat beurré, étaler un peu de béchamel, ajouter une couche de pâtes puis la viande et de la béchamel.","Répéter les couches jusqu'à épuisement des ingrédients, finir avec la béchamel et l'emmental.","Enfourner 40 min jusqu'à gratinage doré.","Laisser reposer quelques minutes avant de servir."]},
{id:18,emoji:"🥩",title:"Steak haché, haricots verts, riz",desc:"Un classique rapide et équilibré avec une sauce maison simple.",tag1:"VIANDE",tag2:"RAPIDE",time:"20 min",grad:"linear-gradient(135deg,#f6d365,#fda085)",
ing:[["Steak haché","1"],["Riz","100g"],["Haricots verts","150g"],["Crème fraîche","2 càs"],["Moutarde","1 càc"]],
steps:["Cuire le riz selon les instructions.","Cuire les haricots verts 8 à 10 min.","Saisir le steak 2 à 3 min par face.","Mélanger crème et moutarde pour la sauce.","Servir chaud."]},
{id:19,emoji:"🥘",title:"Bœuf sauté aux légumes",desc:"Émincé de bœuf revenu rapidement avec légumes croquants.",tag1:"VIANDE",tag2:"POÊLÉE",time:"20 min",grad:"linear-gradient(135deg,#ff9a9e,#fad0c4)",
ing:[["Bœuf émincé","300g"],["Poivron","1"],["Courgette","1"],["Carotte","1"],["Sauce soja","2 càs"]],
steps:["Couper les légumes en lamelles.","Saisir le bœuf 2 min à feu vif.","Ajouter les légumes et cuire 5 min.","Ajouter la sauce soja.","Servir avec du riz."]},
{id:20,emoji:"🍝",title:"Boulettes sauce tomate et pâtes",desc:"Boulettes fondantes nappées de sauce tomate maison.",tag1:"VIANDE",tag2:"FAMILIAL",time:"30 min",grad:"linear-gradient(135deg,#f093fb,#f5576c)",
ing:[["Boulettes de bœuf","12"],["Pâtes","200g"],["Coulis de tomate","400g"],["Ail","1 gousse"]],
steps:["Cuire les pâtes.","Faire dorer les boulettes 5 min.","Ajouter ail et coulis, mijoter 10 min.","Mélanger avec les pâtes et servir."]},
{id:21,emoji:"🍔",title:"Burger confit d'oignon cheddar chèvre",desc:"Burger gourmand avec fromage fondant et oignons caramélisés.",tag1:"BURGER",tag2:"GOURMAND",time:"25 min",grad:"linear-gradient(135deg,#ffb347,#ffcc33)",
ing:[["Pain burger","2"],["Steak haché","2"],["Oignon","1"],["Cheddar","2 tranches"],["Fromage de chèvre","4 rondelles"]],
steps:["Caraméliser l'oignon avec sucre 10 min.","Cuire les steaks.","Monter le burger avec fromages et oignons.","Passer 3 min au four pour fondre."]},
{id:22,emoji:"🍛",title:"Poulet curry et riz",desc:"Poulet tendre mijoté dans une sauce curry crémeuse.",tag1:"POULET",tag2:"ÉPICÉ",time:"30 min",grad:"linear-gradient(135deg,#fddb92,#d1fdff)",
ing:[["Blanc de poulet","300g"],["Riz","150g"],["Crème","20cl"],["Curry","1 càs"],["Oignon","1"]],
steps:["Cuire le riz.","Faire revenir l'oignon et le poulet.","Ajouter curry et crème.","Mijoter 10 min et servir."]},
{id:23,emoji:"🍗",title:"Escalope de poulet panée",desc:"Escalope croustillante à l'extérieur et tendre à l'intérieur.",tag1:"POULET",tag2:"CROUSTILLANT",time:"20 min",grad:"linear-gradient(135deg,#fbc2eb,#a6c1ee)",
ing:[["Escalopes","2"],["Œufs","2"],["Chapelure","100g"],["Farine","50g"]],
steps:["Passer dans farine, œuf puis chapelure.","Faire frire 4 min par face.","Servir avec salade ou frites."]},
{id:24,emoji:"🐟",title:"Poisson pané et pâtes beurre",desc:"Filet croustillant accompagné de pâtes fondantes.",tag1:"POISSON",tag2:"RAPIDE",time:"20 min",grad:"linear-gradient(135deg,#a1c4fd,#c2e9fb)",
ing:[["Poisson pané","2"],["Pâtes","200g"],["Beurre","30g"]],
steps:["Cuire les pâtes.","Cuire le poisson au four ou poêle.","Mélanger pâtes et beurre.","Servir chaud."]},
{id:25,emoji:"🍣",title:"Saumon, brocolis et riz",desc:"Plat équilibré riche en oméga 3.",tag1:"POISSON",tag2:"SAIN",time:"25 min",grad:"linear-gradient(135deg,#84fab0,#8fd3f4)",
ing:[["Saumon","2 pavés"],["Riz","150g"],["Brocolis","1 tête"],["Citron","1"]],
steps:["Cuire le riz.","Cuire brocolis 8 min.","Cuire saumon 4 min par face.","Servir avec citron."]},
{id:26,emoji:"🍝",title:"Tagliatelles au saumon",desc:"Pâtes crémeuses au saumon fondant.",tag1:"PÂTES",tag2:"CRÉMEUX",time:"20 min",grad:"linear-gradient(135deg,#fccb90,#d57eeb)",
ing:[["Tagliatelles","200g"],["Saumon fumé","150g"],["Crème","20cl"],["Poivre",""]],
steps:["Cuire les pâtes.","Chauffer crème et saumon.","Mélanger et poivrer.","Servir chaud."]},
{id:27,emoji:"🍤",title:"Crevettes sautées ail persil",desc:"Crevettes parfumées prêtes en quelques minutes.",tag1:"FRUITS DE MER",tag2:"RAPIDE",time:"15 min",grad:"linear-gradient(135deg,#f093fb,#f5576c)",
ing:[["Crevettes","300g"],["Ail","2 gousses"],["Persil",""],["Huile d'olive","1 càs"]],
steps:["Faire revenir l'ail.","Ajouter crevettes 3 à 4 min.","Parsemer de persil.","Servir avec riz."]},
{id:28,emoji:"🐟",title:"Filet de cabillaud poêlé",desc:"Poisson blanc léger et savoureux.",tag1:"POISSON",tag2:"LÉGER",time:"15 min",grad:"linear-gradient(135deg,#a8edea,#fed6e3)",
ing:[["Cabillaud","2 filets"],["Beurre","20g"],["Citron","1"]],
steps:["Faire fondre le beurre.","Cuire le cabillaud 3 à 4 min par face.","Ajouter citron et servir."]},
{id:29,emoji:"🍝",title:"Pâtes carbonara",desc:"Recette crémeuse et gourmande.",tag1:"PÂTES",tag2:"CLASSIQUE",time:"20 min",grad:"linear-gradient(135deg,#ffecd2,#fcb69f)",
ing:[["Spaghetti","200g"],["Lardons","150g"],["Œufs","2"],["Parmesan","50g"]],
steps:["Cuire pâtes.","Cuire lardons.","Mélanger œufs et parmesan.","Assembler hors du feu."]},
{id:30,emoji:"🍚",title:"Riz cantonais",desc:"Riz sauté complet et savoureux.",tag1:"RIZ",tag2:"ASIATIQUE",time:"25 min",grad:"linear-gradient(135deg,#cfd9df,#e2ebf0)",
ing:[["Riz cuit","300g"],["Œufs","2"],["Petits pois","100g"],["Jambon","100g"],["Sauce soja","2 càs"]],
steps:["Cuire œufs brouillés.","Ajouter riz et légumes.","Ajouter jambon et soja.","Sauter 5 min."]},
{id:31,emoji:"🥔",title:"Hachis parmentier",desc:"Purée gratinée au bœuf mijoté.",tag1:"FAMILIAL",tag2:"GRATIN",time:"45 min",grad:"linear-gradient(135deg,#eacda3,#d6ae7b)",
ing:[["Bœuf haché","400g"],["Pommes de terre","800g"],["Lait","10cl"],["Beurre","30g"]],
steps:["Faire la purée.","Cuire le bœuf haché.","Assembler en plat.","Gratiner 20 min à 200°C."]},
{id:32,emoji:"🥔",title:"Gratin dauphinois",desc:"Pommes de terre fondantes à la crème.",tag1:"GRATIN",tag2:"TRADITIONNEL",time:"60 min",grad:"linear-gradient(135deg,#f6d365,#fda085)",
ing:[["Pommes de terre","1kg"],["Crème","40cl"],["Ail","1 gousse"]],
steps:["Couper pommes de terre fines.","Ajouter crème et ail.","Cuire 45 min à 180°C."]},
{id:33,emoji:"🍲",title:"Couscous rapide",desc:"Version simple et rapide du classique.",tag1:"TRADITIONNEL",tag2:"FAMILIAL",time:"40 min",grad:"linear-gradient(135deg,#fddb92,#d1fdff)",
ing:[["Semoule","300g"],["Poulet","400g"],["Légumes couscous","400g"],["Épices couscous",""]],
steps:["Cuire poulet et légumes.","Préparer la semoule.","Assembler et servir chaud."]},
{id:34,emoji:"🥧",title:"Quiche lorraine",desc:"Tarte salée aux lardons et crème.",tag1:"TARTE",tag2:"CLASSIQUE",time:"40 min",grad:"linear-gradient(135deg,#ff9a9e,#fecfef)",
ing:[["Pâte brisée","1"],["Lardons","200g"],["Œufs","3"],["Crème","20cl"]],
steps:["Mélanger œufs et crème.","Ajouter les lardons.","Cuire 30 min à 180°C."]},
{id:35,emoji:"🌯",title:"Wrap poulet grillé",desc:"Galette garnie facile à emporter.",tag1:"RAPIDE",tag2:"SANDWICH",time:"15 min",grad:"linear-gradient(135deg,#a18cd1,#fbc2eb)",
ing:[["Galettes","2"],["Poulet grillé","200g"],["Salade",""],["Sauce",""]],
steps:["Garnir la galette.","Rouler fermement.","Servir coupé en deux."]},
{id:36,emoji:"🧆",title:"Falafel et salade composée",desc:"Falafels croustillants avec feta, jambon cru et tomates cerises.",tag1:"VÉGÉTARIEN",tag2:"FRAIS",time:"25 min",grad:"linear-gradient(135deg,#84fab0,#8fd3f4)",
ing:[["Falafels","8"],["Feta","100g"],["Tomates cerises","150g"],["Salade verte","1"],["Jambon cru","4 tranches"]],
steps:["Cuire les falafels.","Couper légumes et feta.","Assembler la salade.","Ajouter falafels chauds dessus."]},
{id:37,emoji:"🍆",title:"Ratatouille provençale",desc:"Légumes mijotés du sud servis avec riz.",tag1:"VÉGÉTARIEN",tag2:"SAIN",time:"35 min",grad:"linear-gradient(135deg,#cfd9df,#e2ebf0)",
ing:[["Courgette","1"],["Aubergine","1"],["Poivron","1"],["Tomate","3"],["Riz","150g"]],
steps:["Couper tous les légumes.","Mijoter 20 min avec huile d'olive.","Cuire le riz.","Servir ensemble."]}
];

/* ═══════════════════════════════════════════
   CUSTOM RECIPES — user-created
═══════════════════════════════════════════ */
var CUSTOM_RECIPES = [];
var _customNextId = 10000; // offset to avoid clashing with built-in IDs

/* ── Form state ── */
var _cfState = {
  emoji: "🍳",
  grad:  "linear-gradient(135deg,#FF6B6B,#FFE66D)",
  tags:  ["MAISON"],
  ingredients: [],   // [{name,qty}]
  photoDataUrl: null,
  editId: null       // null = new, number = editing
};

/* ── Render the "Mes Créations" screen ── */
function renderCreateScreen(){
  var listEl = document.getElementById("cr-list-content");
  if(!listEl) return;
  listEl.innerHTML = "";

  if(CUSTOM_RECIPES.length === 0){
    var em = document.createElement("div");
    em.className = "cr-empty";
    em.innerHTML =
      "<div class='cr-empty-icon'>✏️</div>" +
      "<div class='cr-empty-title'>Pas encore de création</div>" +
      "<div class='cr-empty-sub'>Appuyez sur <b>+ Nouvelle</b> pour créer votre première recette.<br>Elle apparaîtra dans le swipe !</div>";
    listEl.appendChild(em);
    return;
  }

  var card = document.createElement("div");
  card.className = "cr-list cf-card";
  CUSTOM_RECIPES.forEach(function(r){
    var row = document.createElement("div");
    row.className = "cr-recipe-row";
    row.innerHTML =
      "<div class='cr-recipe-emoji' style='background:"+r.grad+";'>" + r.emoji + "</div>" +
      "<div class='cr-recipe-info'>" +
        "<div class='cr-recipe-title'>" + r.title + "</div>" +
        "<div class='cr-recipe-meta'>" + r.tag1 + (r.tag2 ? " · " + r.tag2 : "") + " · " + r.time + "</div>" +
      "</div>" +
      "<button class='cr-recipe-del' data-del='"+r.id+"'>✕</button>";

    // Tap row → detail view
    row.addEventListener("click", function(e){
      if(e.target.closest(".cr-recipe-del")) return;
      openDetail(r.id, "create");
    });
    // Delete button
    row.querySelector(".cr-recipe-del").addEventListener("click", function(e){
      e.stopPropagation();
      deleteCustomRecipe(r.id);
    });
    card.appendChild(row);
  });
  listEl.appendChild(card);
}

/* ── Switch tabs ── */
function switchCreateTab(tab){
  var listPanel = document.getElementById("cr-panel-list");
  var formPanel = document.getElementById("cr-panel-form");
  var tabList  = document.getElementById("cr-tab-list");
  var tabForm  = document.getElementById("cr-tab-form");
  if(tab === "list"){
    listPanel.style.display = ""; formPanel.style.display = "none";
    tabList.classList.add("active"); tabForm.classList.remove("active");
    renderCreateScreen();
  } else {
    listPanel.style.display = "none"; formPanel.style.display = "";
    tabList.classList.remove("active"); tabForm.classList.add("active");
  }
}

/* ── Build an ingredient row ── */
function buildIngRow(ing, index){
  var row = document.createElement("div");
  row.className = "cf-ing-item";
  row.setAttribute("data-idx", index);
  var nameInp = document.createElement("input");
  nameInp.className = "cf-ing-name"; nameInp.type="text";
  nameInp.placeholder = "Ingrédient"; nameInp.value = ing.name||"";
  nameInp.addEventListener("input", function(){ _cfState.ingredients[index].name = this.value; });
  var qtyInp = document.createElement("input");
  qtyInp.className = "cf-ing-qty"; qtyInp.type="text";
  qtyInp.placeholder = "Qté"; qtyInp.value = ing.qty||"";
  qtyInp.addEventListener("input", function(){ _cfState.ingredients[index].qty = this.value; });
  var del = document.createElement("button");
  del.className = "cf-ing-del"; del.textContent = "−";
  del.addEventListener("click", function(){
    _cfState.ingredients.splice(index, 1);
    refreshIngList();
  });
  row.appendChild(nameInp); row.appendChild(qtyInp); row.appendChild(del);
  return row;
}

function refreshIngList(){
  var list = document.getElementById("cf-ing-list");
  if(!list) return;
  list.innerHTML = "";
  _cfState.ingredients.forEach(function(ing, i){
    list.appendChild(buildIngRow(ing, i));
  });
}

/* ── Add an ingredient slot ── */
function addIngSlot(){
  _cfState.ingredients.push({name:"", qty:""});
  refreshIngList();
  // Focus last name input
  var inputs = document.querySelectorAll(".cf-ing-name");
  if(inputs.length) inputs[inputs.length-1].focus();
}

/* ── Delete custom recipe ── */
function deleteCustomRecipe(id){
  var idx = CUSTOM_RECIPES.findIndex(function(r){ return r.id === id; });
  if(idx === -1) return;
  // Remove from planning too
  Object.keys(state.weekPlanning).forEach(function(k){
    if(state.weekPlanning[k] === id) delete state.weekPlanning[k];
  });
  // Remove from liked
  var li = state.likedIds.indexOf(id);
  if(li !== -1) state.likedIds.splice(li, 1);
  CUSTOM_RECIPES.splice(idx, 1);
  updateBadges(false);
  renderCreateScreen();
  toast("Recette supprimée");
}

/* ── Reset form ── */
function resetCreateForm(){
  _cfState.emoji = "🍳";
  _cfState.grad  = "linear-gradient(135deg,#FF6B6B,#FFE66D)";
  _cfState.tags  = ["MAISON"];
  _cfState.ingredients = [];
  _cfState.photoDataUrl = null;
  _cfState.editId = null;

  var t = document.getElementById("cf-title"); if(t) t.value="";
  var d = document.getElementById("cf-desc");  if(d) d.value="";
  var ti = document.getElementById("cf-time"); if(ti) ti.value="";
  var po = document.getElementById("cf-portions"); if(po) po.value="";
  var pe = document.getElementById("cf-persons"); if(pe) pe.value="";
  var st = document.getElementById("cf-steps"); if(st) st.value="";

  // Photo zone
  var pz = document.getElementById("cf-photo-zone");
  if(pz){ pz.innerHTML="<div class='cf-photo-icon'>📷</div><div class='cf-photo-lbl'>Ajouter une photo (optionnel)</div><input type='file' id='cf-photo-input' accept='image/*' style='display:none;'>"; pz.classList.remove("filled"); bindPhotoInput(); }

  // Emoji picker
  document.querySelectorAll(".cf-emoji-btn").forEach(function(b){
    b.classList.toggle("sel", b.getAttribute("data-emoji") === "🍳");
  });

  // Gradient picker
  document.querySelectorAll(".cf-swatch").forEach(function(s, i){
    s.classList.toggle("sel", i === 0);
  });

  // Tags
  document.querySelectorAll("#cf-tags-preset .cf-tag").forEach(function(t){
    t.classList.toggle("sel", t.getAttribute("data-tag") === "MAISON");
  });

  refreshIngList();
}

/* ── Bind photo input ── */
function bindPhotoInput(){
  var pz = document.getElementById("cf-photo-zone");
  var pi = document.getElementById("cf-photo-input");
  if(!pz || !pi) return;
  pz.addEventListener("click", function(e){
    if(e.target === pi) return;
    pi.click();
  });
  pi.addEventListener("change", function(){
    var file = pi.files[0];
    if(!file) return;
    var reader = new FileReader();
    reader.onload = function(ev){
      _cfState.photoDataUrl = ev.target.result;
      pz.classList.add("filled");
      pz.innerHTML =
        "<img src='" + ev.target.result + "' alt='photo'>" +
        "<div class='cf-photo-overlay'><button class='cf-photo-change' id='cf-photo-change'>Changer</button></div>" +
        "<input type='file' id='cf-photo-input' accept='image/*' style='display:none;'>";
      bindPhotoInput();
    };
    reader.readAsDataURL(file);
  });
}

/* ── Save recipe ── */
function saveCustomRecipe(){
  var title = (document.getElementById("cf-title")||{}).value||"";
  if(!title.trim()){ toast("Donne un titre à ta recette !"); return; }

  var desc  = (document.getElementById("cf-desc")||{}).value||"";
  var time  = (document.getElementById("cf-time")||{}).value||"30 min";
  var portions = parseInt((document.getElementById("cf-portions")||{}).value)||2;
  var stepsRaw = (document.getElementById("cf-steps")||{}).value||"";

  // Build steps array from textarea (one per line, skip blanks)
  var steps = stepsRaw.split("\n").map(function(s){return s.trim();}).filter(Boolean);
  if(!steps.length) steps = ["Préparer selon votre recette."];

  // Build ing array (filter empty rows)
  var ing = _cfState.ingredients.filter(function(i){return i.name.trim();}).map(function(i){
    return [i.name.trim(), i.qty.trim()||""];
  });

  // Pick up to 2 tags
  var t1 = _cfState.tags[0]||"MAISON";
  var t2 = _cfState.tags[1]||"";

  var id = (_cfState.editId !== null) ? _cfState.editId : _customNextId++;

  var recipe = {
    id:     id,
    emoji:  _cfState.emoji,
    title:  title.trim(),
    desc:   desc.trim() || "Recette maison.",
    tag1:   t1,
    tag2:   t2,
    time:   time.trim(),
    grad:   _cfState.grad,
    ing:    ing,
    steps:  steps,
    portions: portions,
    custom: true,
    photoUrl: _cfState.photoDataUrl || null
  };

  if(_cfState.editId !== null){
    var idx = CUSTOM_RECIPES.findIndex(function(r){return r.id===id;});
    if(idx !== -1) CUSTOM_RECIPES[idx] = recipe;
  } else {
    CUSTOM_RECIPES.push(recipe);
  }

  toast("✅ Recette ajoutée au swipe !");
  saveToStorage();
  resetCreateForm();
  switchCreateTab("list");
}

/* ── Init create screen (called once) ── */
function initCreateScreen(){
  // Tab switching
  var tabList = document.getElementById("cr-tab-list");
  var tabForm = document.getElementById("cr-tab-form");
  var btnNew  = document.getElementById("btn-show-form");

  if(tabList) tabList.addEventListener("click", function(){ switchCreateTab("list"); });
  if(tabForm) tabForm.addEventListener("click", function(){ switchCreateTab("form"); });
  if(btnNew)  btnNew.addEventListener("click",  function(){ switchCreateTab("form"); });

  // Emoji picker
  var emojiPicker = document.getElementById("cf-emoji-picker");
  if(emojiPicker){
    emojiPicker.addEventListener("click", function(e){
      var btn = e.target.closest(".cf-emoji-btn");
      if(!btn) return;
      document.querySelectorAll(".cf-emoji-btn").forEach(function(b){b.classList.remove("sel");});
      btn.classList.add("sel");
      _cfState.emoji = btn.getAttribute("data-emoji");
    });
  }

  // Gradient picker
  var gradPicker = document.getElementById("cf-grad-picker");
  if(gradPicker){
    gradPicker.addEventListener("click", function(e){
      var sw = e.target.closest(".cf-swatch");
      if(!sw) return;
      document.querySelectorAll(".cf-swatch").forEach(function(s){s.classList.remove("sel");});
      sw.classList.add("sel");
      _cfState.grad = sw.getAttribute("data-grad");
    });
  }

  // Tag preset buttons
  var tagsWrap = document.getElementById("cf-tags-preset");
  if(tagsWrap){
    tagsWrap.addEventListener("click", function(e){
      var btn = e.target.closest(".cf-tag");
      if(!btn) return;
      var tag = btn.getAttribute("data-tag");
      var idx = _cfState.tags.indexOf(tag);
      if(idx === -1){
        _cfState.tags.push(tag);
        btn.classList.add("sel");
      } else {
        _cfState.tags.splice(idx, 1);
        btn.classList.remove("sel");
      }
    });
  }

  // Custom tag add
  var tagInp = document.getElementById("cf-tag-custom");
  var tagAddBtn = document.getElementById("cf-tag-add-btn");
  function addCustomTag(){
    if(!tagInp) return;
    var v = tagInp.value.trim().toUpperCase();
    if(!v || _cfState.tags.indexOf(v) !== -1){ tagInp.value=""; return; }
    _cfState.tags.push(v);
    // Add a new tag chip
    var newTag = document.createElement("button");
    newTag.className = "cf-tag sel";
    newTag.setAttribute("data-tag", v);
    newTag.textContent = v;
    newTag.addEventListener("click", function(){
      var ti = _cfState.tags.indexOf(v);
      if(ti !== -1){ _cfState.tags.splice(ti,1); newTag.remove(); }
    });
    if(tagsWrap) tagsWrap.appendChild(newTag);
    tagInp.value = "";
  }
  if(tagAddBtn) tagAddBtn.addEventListener("click", addCustomTag);
  if(tagInp) tagInp.addEventListener("keydown", function(e){ if(e.key==="Enter"){ e.preventDefault(); addCustomTag(); } });

  // Add ingredient row
  var addIngBtn = document.getElementById("cf-add-ing");
  if(addIngBtn) addIngBtn.addEventListener("click", function(){ addIngSlot(); });
  // Start with 2 empty slots
  _cfState.ingredients = [{name:"",qty:""},{name:"",qty:""}];
  refreshIngList();

  // Photo
  bindPhotoInput();

  // Submit
  var submitBtn = document.getElementById("cf-submit");
  if(submitBtn) submitBtn.addEventListener("click", saveCustomRecipe);
}


/* ═══════════════════════════════════════════
   INGREDIENT CATEGORIES MAP
═══════════════════════════════════════════ */
var ING_CATEGORIES={
  "🥦 Fruits & Légumes":["courgette","aubergine","poivron","tomate","oignon","ail","haricot","epinard","roquette","concombre","carotte","poireau","champignon","shiitake","ciboule","brocoli","chou","salade","laitue","celeri","fenouil","artichaut","asperge","navet","radis","pomme","orange","citron","avocat","prune","amande","noix","olives","banane","fraise","framboise","mangue","ananas","peche","abricot","raisin","figue","kiwi"],
  "🥩 Viandes & Poissons":["entrecote","agneau","jambon","thon","saumon","gambas","anchois","poulet","boeuf","veau","canard","porc","escalope","steak","filet","lardons","merguez","chorizo","bacon","dinde","lapin","crevette","cabillaud","lieu","dorade","bar","sole","sardine","maquereau","moule","coquille","homard"],
  "🧀 Fromages & Crèmerie":["beurre","creme","gruyere","burrata","mascarpone","lait","parmesan","fromage","mozzarella","chevre","roquefort","emmental","reblochon","comté","brie","camembert","feta","ricotta","yaourt","oeuf"],
  "🍚 Épicerie salée":["farine","huile","sauce soja","vinaigre","miso","curry","ras el-hanout","cannelle","sesame","moutarde","capres","thym","estragon","persil","basilic","safran","piment","sel","poivre","bouillon","pate","riz","semoule","raviole","ramen","lentille","boite","conserve","harissa","mayonnaise","ketchup","tabasco","worcestershire","tahini","coulis","concentre"],
  "🍬 Épicerie sucrée":["sucre","miel","chocolat","confiture","sirop","caramel","vanille","levure","fecule","cacao","biscuit","cereale","compote","nutella"],
  "🥖 Pains & Pâtisseries":["pain","baguette","brioche","wrap","tortilla","pita","naan","feuillet","pate à pizza","pate brisee","pate feuilletee","crouton"],
  "❄️ Surgelés":["surgele","glace","sorbet"],
  "🥤 Boissons":["lait de coco","grand marnier","cognac","vin","eau","jus","soda","biere","limonade","sirop"],
  "🧴 Hygiène & Entretien":["savon","shampooing","dentifrice","deodorant","lessive","liquide","eponge","sac poubelle","papier","sopalin","pq","cafe","the","tisane"]
};

var MANUAL_CATEGORIES = [
  "🥦 Fruits & Légumes",
  "🥩 Viandes & Poissons",
  "🧀 Fromages & Crèmerie",
  "🍚 Épicerie salée",
  "🍬 Épicerie sucrée",
  "🥖 Pains & Pâtisseries",
  "❄️ Surgelés",
  "🥤 Boissons",
  "🧴 Hygiène & Entretien",
  "📦 Autres"
];

function categorizeIngredient(name){
  var n=name.toLowerCase();
  var cats=Object.keys(ING_CATEGORIES);
  for(var i=0;i<cats.length;i++){
    var words=ING_CATEGORIES[cats[i]];
    for(var j=0;j<words.length;j++){
      if(n.indexOf(words[j])!==-1) return cats[i];
    }
  }
  return "epicerie";
}

/* ═══════════════════════════════════════════
   UNIT NORMALIZATION — convert to canonical
═══════════════════════════════════════════ */
var UNIT_NORM={
  "ml":1,"cl":10,"dl":100,"l":1000,
  "g":1,"kg":1000,"mg":0.001,
  "c.s.":15,"c.c.":5,"tasse":250
};
// Returns {value, unit} where unit is canonical (ml or g or piece)
function parseQty(qtyStr){
  if(!qtyStr) return null;
  var s=qtyStr.trim().toLowerCase();
  // Match patterns like "20cl", "2 c.s.", "3", "½ bouquet"
  var m=s.match(/^([\d\/½¼¾,.]+)\s*(.*)$/);
  if(!m) return {value:1,unit:s||"pce",raw:qtyStr};
  var numStr=m[1].replace(",",".").replace("½","0.5").replace("¼","0.25").replace("¾","0.75");
  // handle fractions like "1/2"
  if(numStr.indexOf("/")!==-1){
    var parts=numStr.split("/");
    numStr=(parseFloat(parts[0])/parseFloat(parts[1])).toString();
  }
  var num=parseFloat(numStr)||1;
  var unit=m[2].trim();
  return {value:num,unit:unit||"pce",raw:qtyStr};
}

function normalizeToBase(parsed){
  if(!parsed) return {value:1,baseUnit:"pce"};
  var u=parsed.unit.toLowerCase();
  // volume in ml
  if(UNIT_NORM[u]!==undefined){
    return{value:parsed.value*UNIT_NORM[u],baseUnit:isVolumeUnit(u)?"ml":"g"};
  }
  return{value:parsed.value,baseUnit:u};
}

function isVolumeUnit(u){
  return ["ml","cl","dl","l","c.s.","c.c.","tasse"].indexOf(u)!==-1;
}

function formatQty(value,baseUnit){
  if(baseUnit==="ml"){
    if(value>=1000) return (value/1000).toFixed(1).replace(".0","")+"l";
    if(value>=100)  return (value/100).toFixed(1).replace(".0","")+"dl";
    if(value>=10)   return (value/10).toFixed(0)+"cl";
    return value.toFixed(0)+"ml";
  }
  if(baseUnit==="g"){
    if(value>=1000) return (value/1000).toFixed(1).replace(".0","")+"kg";
    return value.toFixed(0)+"g";
  }
  // pce: show just the number (or raw qty string if value is clean)
  if(isNaN(value) || value <= 0) return baseUnit||"";
  var n = value%1===0 ? value.toFixed(0) : value.toFixed(1);
  return baseUnit && baseUnit !== "pce" ? n+" "+baseUnit : n+" pce";
}

/* ═══════════════════════════════════════════
   STATE — single source of truth
═══════════════════════════════════════════ */
/* ── Real-week helpers ── */
function getMonday(offset){
  var d=new Date();
  var day=d.getDay();
  var diff=(day===0)?-6:1-day;
  d.setDate(d.getDate()+diff+((offset||0)*7));
  d.setHours(0,0,0,0);
  return d;
}

function getWeekKey(offset){
  var mon = getMonday(offset);
  var y = mon.getFullYear();
  // ISO week number
  var tmp = new Date(Date.UTC(mon.getFullYear(), mon.getMonth(), mon.getDate()));
  var dayNum = tmp.getUTCDay() || 7;
  tmp.setUTCDate(tmp.getUTCDate() + 4 - dayNum);
  var yearStart = new Date(Date.UTC(tmp.getUTCFullYear(),0,1));
  var weekNo = Math.ceil((((tmp - yearStart) / 86400000) + 1)/7);
  return y+"-W"+(weekNo<10?"0":"")+weekNo;
}

function getCurrentWeekPlanning(){
  var key = getWeekKey(state.weekOffset);
  if(!state.allWeeks[key]){
    // Migration : si weekOffset==0 et allWeeks vide, migrer weekPlanning
    if(state.weekOffset===0 && Object.keys(state.weekPlanning).length>0 && Object.keys(state.allWeeks).length===0){
      state.allWeeks[key] = Object.assign({}, state.weekPlanning);
    } else {
      state.allWeeks[key] = {};
    }
  }
  return state.allWeeks[key];
}
function addDays(d,n){var r=new Date(d);r.setDate(r.getDate()+n);return r;}
function fmtDay(d){return d.getDate();}
function fmtShort(d){
  var months=["jan.","fév.","mar.","avr.","mai","juin","juil.","août","sep.","oct.","nov.","déc."];
  return d.getDate()+" "+months[d.getMonth()];
}
function fmtFull(d){
  var months=["jan.","fév.","mar.","avr.","mai","juin","juil.","août","sep.","oct.","nov.","déc."];
  return d.getDate()+" "+months[d.getMonth()]+" "+d.getFullYear();
}
function getWeekLabel(){
  var offset = state.weekOffset||0;
  var mon=getMonday(offset);
  var sun=addDays(mon,6);
  var base = "Semaine du "+fmtShort(mon)+" au "+fmtFull(sun);
  if(offset===0) return "Cette semaine — "+base;
  if(offset===1) return "Semaine prochaine — "+base;
  if(offset===-1) return "Semaine dernière — "+base;
  if(offset>0) return "Dans "+offset+" semaines — "+base;
  return "Il y a "+Math.abs(offset)+" semaines — "+base;
}

var DAYS=["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"];
var DAYS_FULL=["Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi","Dimanche"];

var state={
  likedIds:[],        // recipe IDs liked
  selectedIds:[],     // IDs selected in cart
  selectMode:false,

  // weekPlanning: { "2024-W10": {"0-midi": recipeId, ...}, ... }
  // On garde aussi l'ancien format pour compatibilité
  weekPlanning:{},
  allWeeks:{},        // { "YYYY-WNN": {planning} }
  weekOffset:0,       // 0=cette semaine, 1=semaine prochaine, -1=semaine passée

  // checkedItems: Set of item keys that user has checked off in shopping
  checkedItems:{},    // key -> true
  manualItems:[],
  boughtRecipes:{},
  shoppingHistory:[],     // [{id, name, category, checked}]

  portions:2,
  cardIndex:0,
  detailFrom:"main",
  detailRecipeId:0,

  // planning picker state
  pickerRecipeId:null,
  pickerDay:0,
  pickerTime:"midi",

  // User profile
  profile:{
    email:"",
    diet:"Omnivore",      // Omnivore | Végétarien | Vegan | Keto
    allergies:[],         // ["Lactose", "Gluten", ...]
    disliked:[],          // ["coriandre", "anchois", ...]
    notifications:true,
    darkMode:false
  },

  // Swipe session — IDs seen this session (like OR pass), reset on restart
  seenIds:{}
};

/* ═══════════════════════════════════════════
   LOCALSTORAGE PERSISTENCE
═══════════════════════════════════════════ */
var LS_KEY = "recipy_v1";

/* Stockage avec fallback : localStorage → sessionStorage → cookie */
function _getStorage(){
  try { localStorage.setItem("_t","1"); localStorage.removeItem("_t"); return localStorage; } catch(e){}
  try { sessionStorage.setItem("_t","1"); sessionStorage.removeItem("_t"); return sessionStorage; } catch(e){}
  return null;
}

function _saveCookie(val){
  try {
    var exp = new Date(); exp.setFullYear(exp.getFullYear()+1);
    // On stocke seulement likedIds et weekPlanning dans le cookie (taille limitée)
    var small = {likedIds:val.likedIds, weekPlanning:val.weekPlanning};
    document.cookie = LS_KEY+"="+encodeURIComponent(JSON.stringify(small))+";expires="+exp.toUTCString()+";path=/;SameSite=Lax";
  } catch(e){}
}

function _loadCookie(){
  try {
    var match = document.cookie.match(new RegExp('(?:^|; )'+LS_KEY+'=([^;]*)'));
    return match ? JSON.parse(decodeURIComponent(match[1])) : null;
  } catch(e){ return null; }
}

function saveToStorage(){
  try {
    var data = {
      likedIds:      state.likedIds.slice(),
      weekPlanning:  Object.assign({}, state.weekPlanning),
      allWeeks:      JSON.parse(JSON.stringify(state.allWeeks)),
      checkedItems:  Object.assign({}, state.checkedItems),
      profile:       Object.assign({}, state.profile),
      customRecipes: CUSTOM_RECIPES.map(function(r){ return Object.assign({},r); }),
      manualItems:   state.manualItems.slice(),
      boughtRecipes: Object.assign({}, state.boughtRecipes),
      shoppingHistory: state.shoppingHistory.slice()
    };
    var store = _getStorage();
    if(store){
      store.setItem(LS_KEY, JSON.stringify(data));
    } else {
      _saveCookie(data);
    }
  } catch(e){ console.warn("Save error:", e); }
}

function loadFromStorage(){
  try {
    var store = _getStorage();
    var raw = store ? store.getItem(LS_KEY) : null;
    var d = raw ? JSON.parse(raw) : _loadCookie();
    if(!d) return;
    if(d.likedIds)     state.likedIds     = d.likedIds;
    if(d.weekPlanning) state.weekPlanning = d.weekPlanning;
    if(d.allWeeks)     state.allWeeks     = d.allWeeks;
    if(d.checkedItems) state.checkedItems = d.checkedItems;
    if(d.profile)      state.profile      = Object.assign(state.profile, d.profile);
    if(d.manualItems)    state.manualItems    = d.manualItems;
    if(d.boughtRecipes)  state.boughtRecipes  = d.boughtRecipes;
    if(d.shoppingHistory) state.shoppingHistory = d.shoppingHistory;
    if(d.customRecipes && d.customRecipes.length){
      CUSTOM_RECIPES.splice(0, CUSTOM_RECIPES.length);
      d.customRecipes.forEach(function(r){ CUSTOM_RECIPES.push(r); });
      var mx = d.customRecipes.reduce(function(m,r){ return Math.max(m,r.id||0); }, 9999);
      _customNextId = mx + 1;
    }
  } catch(e){ console.warn("Load error:", e); }
}


// shoppingList is DERIVED — never stored
function computeShoppingListForWeek(wp){
  // Compute shopping list for a single week planning object
  var recipeIds={};
  Object.keys(wp).forEach(function(k){
    var id=wp[k];
    recipeIds[id]=(recipeIds[id]||0)+1;
  });
  // 2. Aggregate ingredients
  // accumulated[normName] = {value, baseUnit, rawUnit, count}
  var accumulated={};
  Object.keys(recipeIds).forEach(function(id){
    var r=getRecipe(parseInt(id));
    if(!r) return;
    var mult=recipeIds[id];
    r.ing.forEach(function(pair){
      var name=pair[0];
      var normName=name.toLowerCase().trim();
      var parsed=parseQty(pair[1]);
      var normed=normalizeToBase(parsed);
      if(!accumulated[normName]){
        accumulated[normName]={
          name:name,
          value:normed.value*mult,
          baseUnit:normed.baseUnit,
          rawUnit:parsed?parsed.unit:"pce",
          category:categorizeIngredient(name)
        };
      } else {
        // Only add if same base unit
        if(accumulated[normName].baseUnit===normed.baseUnit){
          accumulated[normName].value+=normed.value*mult;
        } else {
          // different units — just append as separate
          var altKey=normName+"_alt";
          if(!accumulated[altKey]){
            accumulated[altKey]={name:name,value:normed.value*mult,baseUnit:normed.baseUnit,rawUnit:parsed?parsed.unit:"pce",category:categorizeIngredient(name)};
          } else {
            accumulated[altKey].value+=normed.value*mult;
          }
        }
      }
    });
  });
  // 3. Group by category
  var grouped={};
  Object.keys(accumulated).forEach(function(k){
    var item=accumulated[k];
    var cat=item.category;
    if(!grouped[cat]) grouped[cat]=[];
    grouped[cat].push({
      key:k,
      name:item.name,
      qty:(item.baseUnit==="ml"||item.baseUnit==="g"||item.baseUnit==="pce")
            ? formatQty(item.value,item.baseUnit)
            : (item.rawUnit||item.baseUnit||""),
      category:cat
    });
  });
  return grouped;
}

/* ═══════════════════════════════════════════
   NAV — single source of truth
═══════════════════════════════════════════ */
var SCREEN_TAB={main:0,detail:0,saved:1,calendar:2,shopping:3,prefs:3,create:4,profile:0};

function updateNavIndicator(nav){
  var btns=nav.querySelectorAll(".nav-btn");
  var n=btns.length;
  var activeIdx=0;
  for(var i=0;i<n;i++) if(btns[i].classList.contains("active")){activeIdx=i;break;}
  nav.style.setProperty("--ind-l",(activeIdx/n*100).toFixed(3)+"%");
  nav.style.setProperty("--ind-w",(100/n).toFixed(3)+"%");
}

function setActiveNav(tabIdx){
  var navBars=document.querySelectorAll(".bottom-nav");
  for(var n=0;n<navBars.length;n++){
    var nav=navBars[n];
    var btns=nav.querySelectorAll(".nav-btn");
    for(var i=0;i<btns.length;i++) btns[i].classList.remove("active");
    if(btns[tabIdx]) btns[tabIdx].classList.add("active");
    updateNavIndicator(nav);
  }
}

function showScreen(id){
  // Gérer visibilité du bouton FAB courses
  var fab = document.getElementById("btn-add-manual");
  if(fab) fab.style.display = (id === "shopping") ? "flex" : "none";
  var all=document.querySelectorAll(".screen");
  for(var i=0;i<all.length;i++){all[i].classList.remove("active");all[i].style.display="none";}
  var t=document.getElementById(id);
  if(t){t.style.display="flex";requestAnimationFrame(function(){t.classList.add("active");});}
}

/* ── Navigation history stack ── */
var _navHistory = [];
var _NAV_TAB_SCREENS = ['main','saved','calendar','shopping','create'];

function navigateTo(screenId){
  closeModal();
  var current = document.querySelector('.screen.active');
  var currentId = current ? current.id : null;
  if(currentId && currentId !== screenId){
    var fromTab = _NAV_TAB_SCREENS.indexOf(currentId) !== -1;
    var toTab   = _NAV_TAB_SCREENS.indexOf(screenId)  !== -1;
    if(!(fromTab && toTab)){
      _navHistory.push(currentId);
      if(_navHistory.length > 20) _navHistory.shift();
    } else {
      _navHistory = [];
    }
  }
  if(screenId==="saved")    renderSavedScreen();
  if(screenId==="calendar") renderCalendar();
  if(screenId==="shopping") renderShoppingList();
  if(screenId==="create")   renderCreateScreen();
  var tabIdx=SCREEN_TAB[screenId];
  if(tabIdx!==undefined) setActiveNav(tabIdx);
  showScreen(screenId);
}

function navigateBack(){
  if(_navHistory.length === 0) return false;
  var prev = _navHistory.pop();
  if(prev==="saved")    renderSavedScreen();
  if(prev==="calendar") renderCalendar();
  if(prev==="shopping") renderShoppingList();
  if(prev==="create")   renderCreateScreen();
  var tabIdx=SCREEN_TAB[prev];
  if(tabIdx!==undefined) setActiveNav(tabIdx);
  showScreen(prev);
  return true;
}
function goTo(id){navigateTo(id);}

function initNavBars(){
  var navBars=document.querySelectorAll(".bottom-nav");
  for(var n=0;n<navBars.length;n++){
    (function(nav){
      updateNavIndicator(nav);
      var btns=nav.querySelectorAll(".nav-btn");
      for(var i=0;i<btns.length;i++){
        (function(btn){
          btn.addEventListener("click",function(){
            btn.classList.add("tap");
            setTimeout(function(){btn.classList.remove("tap");},280);
            navigateTo(btn.getAttribute("data-goto"));
          });
        })(btns[i]);
      }
    })(navBars[n]);
  }
}

/* ═══════════════════════════════════════════
   MODAL SYSTEM
═══════════════════════════════════════════ */
function openModal(id){
  document.getElementById("overlay").classList.add("show");
  document.getElementById(id).classList.add("open");
}
function closeModal(){
  document.getElementById("overlay").classList.remove("show");
  document.querySelectorAll(".modal").forEach(function(m){m.classList.remove("open");});
}

/* ═══════════════════════════════════════════
   BADGES
═══════════════════════════════════════════ */
function updateBadges(pop){
  var n=state.likedIds.length;
  var mealN=Object.keys(getCurrentWeekPlanning()).length;

  // Each nav has buttons: tab0=home, tab1=saved(liked), tab2=calendar, tab3=shopping
  document.querySelectorAll(".bottom-nav").forEach(function(nav){
    var btns=nav.querySelectorAll(".nav-btn");
    // Tab 1 (liked) badge
    var b1=btns[1]?btns[1].querySelector(".nav-badge"):null;
    if(b1){
      b1.textContent=n>0?n:"";
      if(n>0){
        if(!b1.classList.contains("show")) b1.classList.add("show");
        if(pop){b1.classList.remove("pop");void b1.offsetWidth;b1.classList.add("pop");}
      } else {
        b1.classList.remove("show","pop");
      }
    }
    // Tab 2 (calendar) badge
    var b2=btns[2]?btns[2].querySelector(".nav-badge"):null;
    if(b2){
      b2.textContent=mealN>0?mealN:"";
      if(mealN>0){
        if(!b2.classList.contains("show")) b2.classList.add("show");
      } else {
        b2.classList.remove("show","pop");
      }
    }
  });
}

/* ═══════════════════════════════════════════
   LIKE / UNLIKE
═══════════════════════════════════════════ */
function isLiked(id){return state.likedIds.indexOf(id)!==-1;}
function likeRecipe(id){
  if(isLiked(id)) return false;
  state.likedIds.push(id);
  updateBadges(true);
  saveToStorage();
  return true;
}
function unlikeRecipe(id){
  var i=state.likedIds.indexOf(id);
  if(i===-1) return;
  state.likedIds.splice(i,1);
  var si=state.selectedIds.indexOf(id);
  if(si!==-1) state.selectedIds.splice(si,1);
  updateBadges(false);
  saveToStorage();
}
function getRecipe(id){
  var all=RECIPES.concat(CUSTOM_RECIPES);
  for(var i=0;i<all.length;i++) if(all[i].id===id) return all[i];
  return null;
}

/* ═══════════════════════════════════════════
   TOAST
═══════════════════════════════════════════ */
var _toastT=null;
function toast(msg){
  clearTimeout(_toastT);
  var t=document.getElementById("toast");
  t.textContent=msg;t.classList.add("show");
  _toastT=setTimeout(function(){t.classList.remove("show");},2400);
}

/* ═══════════════════════════════════════════
   SWIPE CARD
═══════════════════════════════════════════ */
/* Shuffled deck — reshuffled each time it's exhausted */
var _deck=[];
var _deckPos=0;
function _recipeMatchesProfile(r){
  var p=state.profile;
  var tags=[r.tag1||"", r.tag2||""];
  // Diet filter
  if(p.diet==="Végétarien"){
    var meatTags=["VIANDE","BOEUF","PORC","AGNEAU","POULET","CANARD"];
    for(var m=0;m<meatTags.length;m++) if(tags.indexOf(meatTags[m])!==-1) return false;
    var meatWords=["boeuf","porc","agneau","poulet","lardons","jambon","veau","canard","saucisse","steak","entrecote","hache"];
    if(r.ing) for(var i=0;i<r.ing.length;i++){
      var n=r.ing[i][0].toLowerCase();
      for(var m2=0;m2<meatWords.length;m2++) if(n.indexOf(meatWords[m2])!==-1) return false;
    }
  }
  if(p.diet==="Vegan"){
    var animalWords=["boeuf","porc","agneau","poulet","saumon","thon","crevette","oeuf","beurre","creme","fromage","lait","gruyere","parmesan","mozzarella","chevre","lardons","jambon","veau","canard","saucisse","steak"];
    if(r.ing) for(var i=0;i<r.ing.length;i++){
      var n=r.ing[i][0].toLowerCase();
      for(var a=0;a<animalWords.length;a++) if(n.indexOf(animalWords[a])!==-1) return false;
    }
  }
  if(p.diet==="Keto"){
    var carbTags=["PASTA","PIZZA","RIZ","CÉRÉALES"];
    for(var m=0;m<carbTags.length;m++) if(tags.indexOf(carbTags[m])!==-1) return false;
    var carbWords=["pate","riz","farine","pain","semoule","pomme de terre","lentille","haricot","tortellini","raviole","pizza","couscous"];
    if(r.ing) for(var i=0;i<r.ing.length;i++){
      var n=r.ing[i][0].toLowerCase();
      for(var c=0;c<carbWords.length;c++) if(n.indexOf(carbWords[c])!==-1) return false;
    }
  }
  // Allergy filter — match allergy keyword in ingredient names
  var allergyMap={
    "Lactose":["lait","beurre","creme","fromage","gruyere","parmesan","mozzarella","chevre","yaourt","lactose"],
    "Gluten":["farine","pain","pate","tortellini","raviole","couscous","semoule","gluten"],
    "Arachides":["arachide","cacahuete","beurre de cacahuete"],
    "Crustaces":["crevette","homard","crabe","langouste","gambas"],
    "Oeufs":["oeuf","mayo"],
    "Poisson":["saumon","thon","cabillaud","sole","dorade","sardine","anchois","poisson"],
    "Noix":["noix","noisette","amande","cajou","pistache","pecan"],
    "Soja":["soja","tofu","miso","sauce soja","edamame"]
  };
  for(var ai=0;ai<p.allergies.length;ai++){
    var words=allergyMap[p.allergies[ai]]||[];
    if(r.ing) for(var i=0;i<r.ing.length;i++){
      var n=r.ing[i][0].toLowerCase();
      for(var w=0;w<words.length;w++) if(n.indexOf(words[w])!==-1) return false;
    }
  }
  return true;
}

function _buildDeck(keepSeen){
  var all=RECIPES.concat(CUSTOM_RECIPES);
  // Filter by profile
  var filtered=all.filter(function(r){ return _recipeMatchesProfile(r); });
  // If keepSeen=false (normal mode): exclude already seen in this session
  if(!keepSeen){
    var unseen=filtered.filter(function(r){ return !state.seenIds[r.id]; });
    // If all filtered recipes have been seen → show end screen
    if(unseen.length===0){
      showSwipeEnd(filtered.length===0);
      return;
    }
    filtered=unseen;
  }
  // Shuffle
  _deck=filtered.slice();
  for(var i=_deck.length-1;i>0;i--){
    var j=Math.floor(Math.random()*(i+1));
    var t=_deck[i];_deck[i]=_deck[j];_deck[j]=t;
  }
  _deckPos=0;
  // Make sure swipe-end is hidden
  var se=document.getElementById("swipe-end");
  if(se) se.style.display="none";
}

function showSwipeEnd(noRecipes){
  var se=document.getElementById("swipe-end");
  if(!se) return;
  var title=se.querySelector(".swipe-end-title");
  var sub=se.querySelector(".swipe-end-sub");
  if(noRecipes){
    if(title) title.textContent="Aucune recette pour votre profil";
    if(sub) sub.textContent="Essayez d'ajuster vos préférences dans votre profil.";
  } else {
    if(title) title.textContent="Vous avez tout vu !";
    if(sub) sub.textContent="Vous avez exploré toutes les recettes disponibles pour votre profil.";
  }
  se.style.display="flex";
}
function currentRecipe(){
  if(_deck.length===0) _buildDeck();
  return _deck[_deckPos%_deck.length];
}

// Returns array of disliked ingredient names found in a recipe (for badge display)
function getDislikedMatches(r){
  var matches=[];
  var disliked=state.profile.disliked;
  if(!disliked.length || !r.ing) return matches;
  for(var di=0;di<disliked.length;di++){
    var dw=disliked[di].toLowerCase();
    for(var i=0;i<r.ing.length;i++){
      if(r.ing[i][0].toLowerCase().indexOf(dw)!==-1){
        if(matches.indexOf(disliked[di])===-1) matches.push(disliked[di]);
      }
    }
    if((r.title||"").toLowerCase().indexOf(dw)!==-1){
      if(matches.indexOf(disliked[di])===-1) matches.push(disliked[di]);
    }
  }
  return matches;
}

function renderCard(){
  var r=currentRecipe();
  var card=document.getElementById("swipe-card");
  card.style.cssText="";
  var img=document.getElementById("card-img");
  img.style.background=r.grad;
  if(r.photoUrl){
    img.innerHTML="<img src='"+r.photoUrl+"' style='width:100%;height:100%;object-fit:cover;position:absolute;inset:0;border-radius:inherit;'><div class='card-ov'></div>";
  } else {
    img.innerHTML="<span style='font-size:78px;position:relative;z-index:1'>"+r.emoji+"</span><div class='card-ov'></div>";
  }
  document.getElementById("ctitle").textContent=r.title;
  document.getElementById("cdesc").textContent=r.desc;
  document.getElementById("ctag1").textContent=r.tag1;
  document.getElementById("ctag2").textContent=r.tag2||"";
  document.getElementById("ctime").textContent=r.time;
  var _rp = estimateRecipePrice(r);
  document.getElementById("cprice").textContent = _rp ? ("~"+_rp.lo+"-"+_rp.hi+"€") : "";

  // Disliked badge
  var existing=document.getElementById("dislike-badge");
  if(existing) existing.remove();
  var matches=getDislikedMatches(r);
  if(matches.length){
    var badge=document.createElement("div");
    badge.id="dislike-badge";
    badge.style.cssText="position:absolute;top:12px;left:12px;z-index:10;background:rgba(0,0,0,.62);color:#fff;font-size:10px;font-weight:700;padding:4px 9px;border-radius:20px;backdrop-filter:blur(4px);display:flex;align-items:center;gap:4px;";
    badge.innerHTML="⚠️ Contient : "+matches.join(", ");
    card.appendChild(badge);
  }
}

function doSwipe(dir){
  var r=currentRecipe();
  var card=document.getElementById("swipe-card");
  var tx=dir==="left"?"-150%":"150%";
  var rot=dir==="left"?"-20deg":"20deg";
  document.getElementById("badge-left").style.opacity="0";
  document.getElementById("badge-right").style.opacity="0";
  card.style.transition="transform .36s ease,opacity .36s ease";
  card.style.transform="translateX("+tx+") rotate("+rot+")";
  card.style.opacity="0";
  if(dir==="right"){
    var added=likeRecipe(r.id);
    var sb=document.getElementById("btn-save");
    sb.classList.add("heart-burst");
    setTimeout(function(){sb.classList.remove("heart-burst");},420);
    toast(added?"✓ Recette sauvegardée !":"Déjà dans vos recettes");
  } else {
    toast("Recette passée");
  }
  setTimeout(function(){
    state.seenIds[r.id]=true;
    _deckPos++;
    if(_deckPos>=_deck.length) _buildDeck(false);
    card.style.transition="none";
    card.style.transform="scale(.82)";
    card.style.opacity="0";
    renderCard();
    requestAnimationFrame(function(){requestAnimationFrame(function(){
      card.style.transition="transform .3s cubic-bezier(.34,1.56,.64,1),opacity .26s ease";
      card.style.transform="";card.style.opacity="1";
    });});
  },380);
}

/* ═══════════════════════════════════════════
   DETAIL VIEW
═══════════════════════════════════════════ */
function openDetail(recipeId,fromScreen){
  var r=getRecipe(recipeId);
  if(!r) return;
  state.detailFrom=fromScreen||"main";
  state.detailRecipeId=recipeId;
  var di=document.getElementById("det-img");
  di.style.background=r.grad;
  var back=document.getElementById("btn-det-back");
  var fav=document.getElementById("btn-det-fav");
  di.textContent="";
  if(r.photoUrl){
    // Custom recipe with photo
    var img=document.createElement("img");
    img.src=r.photoUrl;
    img.style.cssText="width:100%;height:100%;object-fit:cover;position:absolute;inset:0;";
    di.appendChild(img);
  } else {
    var es=document.createElement("span");
    es.style.cssText="font-size:100px;position:relative;z-index:1";
    es.textContent=r.emoji;
    di.appendChild(es);
  }
  di.appendChild(back);di.appendChild(fav);
  fav.textContent=isLiked(r.id)?"♥":"★";
  document.getElementById("det-title").textContent=r.title;
  document.getElementById("det-desc").textContent=r.desc;
  document.getElementById("det-tag1").textContent=r.tag1;
  document.getElementById("det-tag2").textContent=r.time;
  var ingEl=document.getElementById("det-ing");
  ingEl.innerHTML="";
  r.ing.forEach(function(pair){
    var d=document.createElement("div");d.className="ing-item";
    d.innerHTML="<span class='ing-name'>"+pair[0]+"</span><span class='ing-qty'>"+pair[1]+"</span>";
    ingEl.appendChild(d);
  });
  var stEl=document.getElementById("det-steps");
  stEl.innerHTML="";
  r.steps.forEach(function(s,i){
    var d=document.createElement("div");d.className="step";
    d.innerHTML="<div class='step-n'>"+(i+1)+"</div><div class='step-t'>"+s+"</div>";
    stEl.appendChild(d);
  });
  setActiveNav(SCREEN_TAB["main"]);
  showScreen("detail");
}

/* ═══════════════════════════════════════════
   SAVED SCREEN
═══════════════════════════════════════════ */
function exitSelectMode(){
  state.selectMode=false;state.selectedIds=[];
  document.getElementById("sel-toolbar").classList.remove("visible");
  document.getElementById("btn-select-mode").style.display="none";
  renderSavedScreen();
}
/* ─── renderSavedScreen — iOS vertical list ──────────────────── */
/* ── Edit mode state ── */
var _editMode = false;
var _selectedIds = {};

function _updateEditToolbar(){
  var count = Object.keys(_selectedIds).length;
  var countEl = document.getElementById("edit-sel-count");
  var delBtn  = document.getElementById("btn-del-sel");
  if(countEl) countEl.textContent = count + " sélectionnée" + (count > 1 ? "s" : "");
  if(delBtn)  delBtn.disabled = count === 0;
}

function renderSavedScreen(){
  var container = document.getElementById("saved-content");
  container.innerHTML = "";

  // Recettes planifiées (toutes semaines)
  var allPlannedIds = {};
  Object.values(state.allWeeks).forEach(function(wp){
    Object.values(wp).forEach(function(rid){ allPlannedIds[rid]=true; });
  });
  Object.values(state.weekPlanning).forEach(function(rid){ allPlannedIds[rid]=true; });

  // Filtrer selon recherche
  var q = (state._savedSearch||"").toLowerCase().trim();
  var visibleIds = state.likedIds.filter(function(id){ return !allPlannedIds[id]; });
  if(q) visibleIds = visibleIds.filter(function(id){
    var r=getRecipe(id); if(!r) return false;
    return r.title.toLowerCase().indexOf(q)!==-1||r.tag1.toLowerCase().indexOf(q)!==-1||(r.tag2&&r.tag2.toLowerCase().indexOf(q)!==-1);
  });

  var n = state.likedIds.length;
  var plannedCount = Object.keys(allPlannedIds).filter(function(id){ return state.likedIds.indexOf(parseInt(id))!==-1; }).length;
  var countEl = document.getElementById("saved-count-label");
  if(countEl) countEl.textContent = n + (n<=1?" recette sauvegardée":" recettes sauvegardées") + (plannedCount>0?" · "+plannedCount+" en cours 📅":"");

  /* Sync edit toolbar visibility */
  var toolbar = document.getElementById("edit-toolbar");
  var editBtn  = document.getElementById("btn-toggle-edit");
  if(toolbar) toolbar.classList.toggle("show", _editMode);
  if(editBtn) { editBtn.textContent = _editMode ? "Terminer" : "Modifier"; editBtn.classList.toggle("active", _editMode); }
  _updateEditToolbar();

  if(visibleIds.length === 0){
    _editMode = false;
    var empty = document.createElement("div");
    empty.className = "empty-state";
    empty.innerHTML = "<div class='ei'>♥</div><h3>Aucune recette</h3><p>Swipez à droite pour sauvegarder des recettes ici.</p>";
    container.appendChild(empty);
    return;
  }

  var list = document.createElement("div");
  list.className = "saved-list" + (_editMode ? " edit-mode" : "");
  var section = document.createElement("div");
  section.className = "saved-section";

  visibleIds.forEach(function(id, idx){
    var r = getRecipe(id);
    if(!r) return;
    var isChecked = !!_selectedIds[id];

    var row = document.createElement("div");
    row.className = "rc-row" + (isChecked ? " sel-checked" : "");
    row.setAttribute("data-recipe-id", id);
    row.style.animationDelay = (idx * 45) + "ms";

    row.innerHTML =
      "<div class='rc-main'>" +
        "<div class='rc-checkbox'>" + (isChecked ? "✓" : "") + "</div>" +
        "<div class='rc-photo' style='background:" + r.grad + "'>" +
          "<span>" + r.emoji + "</span>" +
        "</div>" +
        "<div class='rc-info'>" +
          "<div class='rc-title'>" + r.title + "</div>" +
          "<div class='rc-meta'>" + r.time + " · " + r.tag1 + "</div>" +
        "</div>" +
        "<div class='rc-portions'>" +
          "<span class='rc-portions-icon'>👤</span>" +
          "<span>1 prs.</span>" +
        "</div>" +
        "<div class='rc-chevron'>›</div>" +
      "</div>" +
      "<div class='rc-actions'>" +
        "<button class='rc-action-btn del' data-del='" + id + "'>🗑 Supprimer</button>" +
        "<button class='rc-action-btn detail' data-detail='" + id + "'>📖 Détails</button>" +
        "<button class='rc-action-btn plan' data-plan='" + id + "'>📅 Planning</button>" +
      "</div>";

    var mainLine = row.querySelector(".rc-main");
    mainLine.addEventListener("click", function(){
      if(_editMode){
        /* Toggle selection */
        if(_selectedIds[id]){ delete _selectedIds[id]; row.classList.remove("sel-checked"); row.querySelector(".rc-checkbox").textContent = ""; }
        else { _selectedIds[id] = true; row.classList.add("sel-checked"); row.querySelector(".rc-checkbox").textContent = "✓"; }
        _updateEditToolbar();
        return;
      }
      /* Normal expand */
      var wasExpanded = row.classList.contains("expanded");
      section.querySelectorAll(".rc-row.expanded").forEach(function(r2){ r2.classList.remove("expanded"); });
      if(!wasExpanded) row.classList.add("expanded");
    });

    row.querySelector("[data-del]").addEventListener("click", function(e){
      e.stopPropagation();
      row.classList.add("card-exit");
      setTimeout(function(){ unlikeRecipe(id); renderSavedScreen(); }, 220);
      toast("Recette retirée");
    });
    row.querySelector("[data-detail]").addEventListener("click", function(e){
      e.stopPropagation(); openDetail(id, "saved");
    });
    row.querySelector("[data-plan]").addEventListener("click", function(e){
      e.stopPropagation(); openPlanningPicker(id);
    });

    section.appendChild(row);
  });

  list.appendChild(section);
  container.appendChild(list);
}


function toggleSelectCard(id, cardEl){ /* noop — select mode removed */ }
function exitSelectMode(){ state.selectMode=false; state.selectedIds=[]; }


function openPlanningPicker(recipeId){
  resetPlanModal();
  state.pickerRecipeId=recipeId;
  state.pickerDay=0;
  state.pickerTime="midi";
  // Build day grid
  var grid=document.getElementById("plan-day-grid");
  grid.innerHTML="";
  DAYS.forEach(function(d,i){
    var btn=document.createElement("button");
    btn.className="plan-day-btn"+(i===0?" selected":"");
    btn.textContent=d;
    btn.addEventListener("click",function(){
      grid.querySelectorAll(".plan-day-btn").forEach(function(b){b.classList.remove("selected");});
      btn.classList.add("selected");
      state.pickerDay=i;
    });
    grid.appendChild(btn);
  });
  // Time buttons
  document.getElementById("pt-midi").classList.add("selected");
  document.getElementById("pt-soir").classList.remove("selected");
  state.pickerTime="midi";
  openModal("plan-modal");
}

function confirmPlanning(){
  // Null-guard: pickerRecipeId must be a valid number
  if(state.pickerRecipeId===null || state.pickerRecipeId===undefined) return;
  var r=getRecipe(state.pickerRecipeId);
  if(!r){ toast("Recette introuvable"); return; }
  var key=state.pickerDay+"-"+state.pickerTime;
  var wp = getCurrentWeekPlanning();
  wp[key]=state.pickerRecipeId;
  // Reset statut acheté pour cette recette
  var wk=getWeekKey(state.weekOffset||0);
  delete state.boughtRecipes[wk+"_"+state.pickerRecipeId];
  delete state.boughtRecipes["current_"+state.pickerRecipeId];
  state.checkedItems={};
  updateBadges(false);
  closeModal();
  // Always keep calendar + shopping in sync
  renderCalendar();
  renderShoppingList();
  var dayName=DAYS_FULL[state.pickerDay];
  var moment=state.pickerTime==="midi"?"à midi":"le soir";
  saveToStorage();
  toast("📅 "+r.title+" ajoutée "+moment+" ("+dayName+")");
}

/* ═══════════════════════════════════════════
   CALENDAR SCREEN
═══════════════════════════════════════════ */
function renderCalendar(){
  var strip=document.getElementById("week-strip");
  strip.innerHTML="";
  strip.style.cssText="display:flex!important;flex-direction:row!important;width:100%;padding:0 12px 10px;box-sizing:border-box;flex-shrink:0;";
  var offset = state.weekOffset||0;
  var isPast = offset < 0;
  var today=new Date().getDay();
  var todayIdx=(today===0)?6:today-1;
  var monday=getMonday(offset);
  var wp = getCurrentWeekPlanning(); // planning de la semaine affichée
  DAYS.forEach(function(d,i){
    var dayDate=addDays(monday,i);
    var col=document.createElement("div");
    col.style.cssText="flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;min-width:0;";
    var lbl=document.createElement("div");
    lbl.style.cssText="font-size:9px;font-weight:700;color:#6B7280;letter-spacing:.5px;text-transform:uppercase;";
    lbl.textContent=d;
    var num=document.createElement("div");
    var isToday=(i===todayIdx);
    num.style.cssText="width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;"+(isToday?"background:#FF3E7F;color:#fff;":"color:#1A1A2E;");
    num.textContent=fmtDay(dayDate);
    col.appendChild(lbl);col.appendChild(num);
    strip.appendChild(col);
  });

  var body=document.getElementById("cal-body");
  body.innerHTML="";
  var moments=["midi","soir"];
  var hasAny=false;

  DAYS_FULL.forEach(function(dayFull,dayIdx){
    var dayHasMeal=false;
    moments.forEach(function(m){
      if(wp[dayIdx+"-"+m]) dayHasMeal=true;
    });

    var sec=document.createElement("div");
    sec.className="cal-day-section";
    if(isPast) sec.style.opacity="0.55";

    // Calculer si c'est aujourd'hui
    var todayDate = new Date();
    var dayDate2 = addDays(monday, dayIdx);
    var isThisDay = (dayDate2.getFullYear()===todayDate.getFullYear() &&
                     dayDate2.getMonth()===todayDate.getMonth() &&
                     dayDate2.getDate()===todayDate.getDate());
    if(isThisDay){
      sec.style.borderLeft = "3px solid #FF3E7F";
      sec.style.paddingLeft = "8px";
      sec.style.marginLeft = "-8px";
    }

    var titleEl=document.createElement("div");
    titleEl.className="cal-day-title";
    titleEl.style.cssText = isThisDay
      ? "display:flex;align-items:center;gap:8px;"
      : "";
    titleEl.innerHTML = dayFull + (isThisDay
      ? "<span style='font-size:10px;font-weight:700;color:#fff;background:#FF3E7F;padding:2px 8px;border-radius:20px;'>Aujourd'hui</span>"
      : "");
    sec.appendChild(titleEl);

    moments.forEach(function(moment){
      var key=dayIdx+"-"+moment;
      var rid=wp[key];
      if(rid!==undefined){
        hasAny=true;
        var r=getRecipe(rid);
        if(!r) return;
        var slot=document.createElement("div");
        slot.className="meal-slot";
        slot.setAttribute("draggable","true");
        slot.setAttribute("data-key",key);
        slot.innerHTML=
          "<div class='meal-emoji'>"+r.emoji+"</div>"+
          "<div class='meal-info'>"+
            "<span class='meal-time-badge "+moment+"'>"+moment.toUpperCase()+"</span>"+
            "<div class='meal-title'>"+r.title+"</div>"+
            "<div class='meal-meta'>"+r.time+" • "+r.tag1+
              (function(){ var wk=getWeekKey(offset); var bk=wk+"_"+rid; return (state.boughtRecipes[bk]||state.boughtRecipes["current_"+rid]) ? " <span style='color:#10B981;font-weight:700;'>· 🛒 Acheté</span>" : ""; }())+
            "</div>"+
          "</div>"+
          (!isPast ? "<button class='meal-remove' data-key='"+key+"'>✕</button>" : "");
        // Click to detail
        slot.addEventListener("click",function(e){
          if(e.target.closest(".meal-remove")) return;
          openDetail(rid,"calendar");
        });
        // Remove
        slot.querySelector(".meal-remove").addEventListener("click",function(e){
          e.stopPropagation();
          delete wp[key];
          renderCalendar();
          renderShoppingList();
          state.checkedItems={};
        updateBadges(false);
        saveToStorage();
              toast("Repas retiré du planning");
        });
        // Drag start
        slot.addEventListener("dragstart",function(e){
          e.dataTransfer.setData("text/plain",key);
          slot.style.opacity=".5";
        });
        slot.addEventListener("dragend",function(){slot.style.opacity="";});
        sec.appendChild(slot);
      } else {
        // Empty slot — click to add
        var empty=document.createElement("div");
        empty.className="meal-slot-empty";
        empty.innerHTML="<span style='font-size:16px'>"+(moment==="midi"?"🌤️":"🌙")+"</span><span>Ajouter un repas du "+moment+"…</span>";
        empty.addEventListener("click",function(){
          if(isPast){toast("Semaine passée — consultation uniquement");return;}
          if(state.likedIds.length===0){toast("Sauvegardez des recettes d'abord");return;}
          state.pickerDay=dayIdx;
          state.pickerTime=moment;
          // Show a simple recipe picker
          openQuickAddPicker(dayIdx,moment);
        });
        // Drop target
        empty.addEventListener("dragover",function(e){e.preventDefault();empty.classList.add("drag-over");});
        empty.addEventListener("dragleave",function(){empty.classList.remove("drag-over");});
        empty.addEventListener("drop",function(e){
          e.preventDefault();
          empty.classList.remove("drag-over");
          var fromKey=e.dataTransfer.getData("text/plain");
          var rid2=state.weekPlanning[fromKey];
          if(rid2!==undefined){
            if(fromKey === key){ toast("Même emplacement"); return; }
            delete wp[fromKey];
            wp[key]=rid2;
            state.checkedItems={};
            updateBadges(false);
            saveToStorage();
            renderCalendar();
            renderShoppingList();
            toast("Repas déplacé !");
          }
        });
        sec.appendChild(empty);
      }
    });
    body.appendChild(sec);
  });

  if(!hasAny){
    var hint=document.createElement("div");
    hint.style.cssText="text-align:center;padding:24px 20px;color:var(--gray);font-size:13px;line-height:1.7;";
    hint.innerHTML="<div style='font-size:42px;margin-bottom:10px;opacity:.3;'>📅</div>Ajoutez des recettes depuis<br><b>Mes Recettes</b> ou via le swipe";
    body.appendChild(hint);
  }

  // Week label
  updateWeekLabel();

  // Planning indicator
  var indic = document.getElementById("cal-shop-indicator");
  if(indic){
    var mealCount = Object.keys(wp).length;
    if(mealCount === 0){
      indic.style.display = "none";
    } else {
      var slots = mealCount;
      indic.style.display = "flex";
      indic.innerHTML =
        "<span style='font-size:12px;color:#FF3E7F;font-weight:600;'>"+slots+" repas planifié"+(slots>1?"s":"")+" cette semaine</span>"+
        "<button style='background:none;border:none;font-size:11px;font-weight:700;color:#FF3E7F;cursor:pointer;white-space:nowrap;padding:0;text-decoration:underline;' id='cal-go-shop'>Voir les courses →</button>";
      var goBtn = document.getElementById("cal-go-shop");
      if(goBtn) goBtn.addEventListener("click", function(){ navigateTo("shopping"); });
    }
  }
}

/* Quick add picker — shows liked recipes list inline in a modal */
function resetPlanModal(){
  // Restore all controls to default state before opening either picker
  document.querySelector("#plan-modal .modal-title").textContent="Ajouter au planning";
  document.getElementById("pt-midi").style.display="";
  document.getElementById("pt-soir").style.display="";
  document.getElementById("btn-confirm-plan").style.display="";
  document.getElementById("plan-day-grid").innerHTML="";
}

function openQuickAddPicker(dayIdx,moment){
  resetPlanModal();
  state.pickerDay=dayIdx;state.pickerTime=moment;
  var modal=document.getElementById("plan-modal");
  modal.querySelector(".modal-title").textContent=DAYS_FULL[dayIdx]+" — "+moment;
  // Hide day/time row and confirm; show recipe list instead
  document.getElementById("pt-midi").style.display="none";
  document.getElementById("pt-soir").style.display="none";
  document.getElementById("btn-confirm-plan").style.display="none";
  // Recipe list
  var grid=document.getElementById("plan-day-grid");
  grid.innerHTML="";
  if(state.likedIds.length===0){
    var hint=document.createElement("p");
    hint.style.cssText="color:var(--gray);font-size:13px;grid-column:span 7;padding:8px 0;";
    hint.textContent="Sauvegardez d'abord des recettes via le swipe.";
    grid.appendChild(hint);
  } else {
    /* Search bar */
    var searchWrap = document.createElement("div");
    searchWrap.className = "plan-search-wrap";
    searchWrap.style.cssText = "grid-column:span 7;margin-bottom:10px;";
    searchWrap.innerHTML =
      "<span class='plan-search-icon'>🔍</span>" +
      "<input class='plan-search-inp' id='plan-search-inp' type='text' placeholder='Rechercher une recette…' autocomplete='off'>" +
      "<button class='plan-search-clear' id='plan-search-clear'>✕</button>";
    grid.appendChild(searchWrap);

    /* Recipe list container */
    var recipeList = document.createElement("div");
    recipeList.style.cssText = "grid-column:span 7;";
    grid.appendChild(recipeList);

    function buildRecipeList(filter){
      recipeList.innerHTML = "";
      var ids = state.likedIds;
      var q = (filter||"").toLowerCase().trim();
      var found = 0;
      // Griser les recettes planifiées sur TOUTES les semaines (période glissante)
      var plannedIds = {};
      Object.values(state.allWeeks).forEach(function(wp){
        Object.values(wp).forEach(function(rid){ plannedIds[rid]=true; });
      });
      // Inclure aussi weekPlanning legacy
      Object.values(state.weekPlanning).forEach(function(rid){ plannedIds[rid]=true; });
      ids.forEach(function(id){
        var r=getRecipe(id);if(!r) return;
        if(q && r.title.toLowerCase().indexOf(q)===-1 && r.tag1.toLowerCase().indexOf(q)===-1) return;
        found++;
        var alreadyPlanned = !!plannedIds[id];
        var btn=document.createElement("button");
        btn.style.cssText="width:100%;text-align:left;padding:10px 12px;border-radius:12px;border:2px solid var(--gray-light);background:transparent;font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;margin-bottom:6px;transition:all .15s;"+(alreadyPlanned?"opacity:0.35;filter:grayscale(1);":"");
        btn.innerHTML="<span style='font-size:22px'>"+r.emoji+"</span><div><div style='color:var(--dark)'>"+r.title+(alreadyPlanned?" <span style='font-size:9px;color:var(--gray);font-weight:400'>déjà planifié</span>":"")+"</div><div style='color:var(--gray);font-size:10px;font-weight:400'>"+r.time+" • "+r.tag1+"</div></div>";
        btn.addEventListener("mouseenter",function(){btn.style.borderColor="var(--pink)";btn.style.background="var(--pink-soft)";});
        btn.addEventListener("mouseleave",function(){btn.style.borderColor="var(--gray-light)";btn.style.background="transparent";});
        btn.addEventListener("click",function(){
          var wp2=getCurrentWeekPlanning();
          wp2[dayIdx+"-"+moment]=id;
          state.checkedItems={};
          updateBadges(false);
          saveToStorage();
          closeModal();
          renderCalendar();
          renderShoppingList();
          toast("📅 "+r.title+" ajoutée !");
        });
        recipeList.appendChild(btn);
      });
      if(found===0){
        var msg=document.createElement("div");
        msg.style.cssText="padding:14px 0;color:var(--gray);font-size:13px;text-align:center;";
        msg.textContent="Aucune recette trouvée";
        recipeList.appendChild(msg);
      }
    }

    buildRecipeList("");

    /* Search events */
    setTimeout(function(){
      var inp = document.getElementById("plan-search-inp");
      var clr = document.getElementById("plan-search-clear");
      if(inp){
        inp.addEventListener("input", function(){
          buildRecipeList(inp.value);
          if(clr) clr.style.display = inp.value ? "block" : "none";
        });
      }
      if(clr){
        clr.addEventListener("click", function(){
          inp.value = "";
          clr.style.display = "none";
          buildRecipeList("");
          inp.focus();
        });
      }
    }, 80);
  }
  openModal("plan-modal");
}

/* ═══════════════════════════════════════════
   SHOPPING LIST SCREEN
═══════════════════════════════════════════ */
/* ═══════════════════════════════════════════
   COST ESTIMATION — prix indicatifs (€/kg ou €/pièce)
═══════════════════════════════════════════ */
/* Prix au kilo (€/kg) — pour ingrédients pesés */
var PRICE_DB = {
  // légumes €/kg GMS France 2024-2025
  tomate:2.5, courgette:2.0, aubergine:2.8, poivron:3.5, carotte:1.5,
  oignon:1.5, epinard:4.0, champignon:6.0, pomme_de_terre:1.2,
  // viandes & poissons €/kg
  boeuf:16.0, veau:20.0, porc:9.0, poulet:7.5, agneau:22.0,
  saumon:22.0, thon:16.0, crevette:22.0, jambon:12.0,
  entrecote:28.0, hache:10.0, saucisse:8.0, lardons:7.0, gambas:28.0,
  // laitiers €/kg ou €/l
  beurre:12.0, creme:4.0, lait:1.2, gruyere:14.0,
  parmesan:22.0, mozzarella:12.0, chevre:18.0,
  // féculents €/kg
  pate:2.0, riz:2.5, semoule:2.0, lentille:3.0,
  raviole:8.0, tortellini:9.0, farine:1.2,
  // épicerie €/kg ou €/l
  huile:7.0, sauce_soja:8.0, miso:12.0, curry:20.0,
  tomate_concassee:1.8, haricot:1.5, pesto:12.0, bouillon:3.0,
  miel:12.0, sucre:1.5,
  // fruits €/kg
  citron:2.5, orange:2.0, pomme:2.5, prune:4.0
};

/* Prix à la pièce (€/pièce) — pour ingrédients achetés à l'unité */
var PRICE_UNIT = {
  // légumes pièce
  tomate:0.40, courgette:0.80, aubergine:1.10, poivron:0.90, carotte:0.25,
  oignon:0.35, concombre:0.85, laitue:1.20, salade:1.20, avocat:1.10,
  // fruits pièce
  citron:0.35, orange:0.55, pomme:0.45,
  // viandes pièce
  poulet:8.50,  // poulet entier ~1,2 kg à 7,5€/kg
  steak:3.50,   // steak ~200g
  saucisse:0.80,
  gambas:1.20,  // grosse gambas royale
  // laitiers pièce
  oeuf:0.25,
  fromage:4.50, // portion fromage
  chevre:2.20,  // rondelle de chèvre
  // épicerie pièce
  pain:1.80     // pain de mie (paquet)
};

// Normalize ingredient name → lookup key
function normIngName(raw){
  return raw.toLowerCase()
    .replace(/fraîche?s?|râpé[es]?|concassé[es]?|haché[es]?|grillé[es]?|entier[es]?|décortiqué[es]?|en conserve|en boîte/g,"")
    .replace(/[^a-záéèêîùàôûç\s]/g,"")
    .replace(/\s+/g," ").trim()
    .replace(/ /g,"_")
    .replace(/s$/,""); // crude singular
}

// Parse quantity string → grams or pieces (float)
function parseCostQty(qtyStr){
  if(!qtyStr) return {val:1, unit:"pce"};
  var s = qtyStr.toLowerCase().trim();
  if(/goût|qs|selon|facultatif|pincée|pincee|gousse|bouquet/.test(s)) return {val:0.01, unit:"pce"};
  var m = s.match(/^([0-9]+\/[0-9]+|[0-9]+[,.][0-9]+|[0-9]+)/);
  var num = 1;
  if(m){
    var raw = m[1];
    if(raw.indexOf("/")!==-1){ var p=raw.split("/"); num=parseFloat(p[0])/parseFloat(p[1]); }
    else num = parseFloat(raw.replace(",",".")) || 1;
  }
  if(isNaN(num) || num<=0) num=1;
  if(/kg/.test(s))               return {val:num*1000, unit:"g"};
  if(/cl/.test(s))               return {val:num*10,   unit:"ml"};
  if(/dl/.test(s))               return {val:num*100,  unit:"ml"};
  if(/ml/.test(s))               return {val:num,      unit:"ml"};
  if(/c\.s\.|cuill|tbsp/.test(s)) return {val:num*15, unit:"ml"};
  if(/c\.c\.|tsp/.test(s))     return {val:num*5,    unit:"ml"};
  if(/[0-9]g|^g | g$/.test(s))  return {val:num,      unit:"g"};
  if(/ l$|^l /.test(s))         return {val:num*1000,  unit:"ml"};
  return {val:num, unit:"pce"};
}

// Estimate cost for one item: {name, qty}
function estimateItemCost(name, qty){
  var key = normIngName(name);
  var keys = Object.keys(PRICE_DB);
  var pricePerKg = null;
  if(PRICE_DB[key] !== undefined) pricePerKg = PRICE_DB[key];
  else {
    var best = "";
    for(var i=0;i<keys.length;i++){
      if(key.indexOf(keys[i]) !== -1 && keys[i].length > best.length) best = keys[i];
    }
    if(best) pricePerKg = PRICE_DB[best];
  }
  if(pricePerKg === null) pricePerKg = 3.0;

  var q = parseCostQty(qty);
  if(q.unit === "g")   return pricePerKg * q.val / 1000;
  if(q.unit === "ml")  return pricePerKg * q.val / 1000;
  // piece: check PRICE_UNIT first (real unit prices), then fall back to kg × estimated weight
  if(PRICE_UNIT[key] !== undefined) return PRICE_UNIT[key] * q.val;
  // fuzzy match in PRICE_UNIT
  var ukeys = Object.keys(PRICE_UNIT);
  for(var u=0;u<ukeys.length;u++){
    if(key.indexOf(ukeys[u])!==-1 || ukeys[u].indexOf(key)!==-1){
      return PRICE_UNIT[ukeys[u]] * q.val;
    }
  }
  // last resort: kg price × typical weight per piece (0.15 kg default)
  var pieceWeights = {oeuf:0.06,oignon:0.15,ail:0.03,carotte:0.12,courgette:0.25,
    aubergine:0.35,poivron:0.20,tomate:0.18,citron:0.12,avocat:0.22,pomme:0.20,
    concombre:0.35,champignon:0.10,pomme_de_terre:0.15};
  var w = pieceWeights[key] || 0.15;
  return pricePerKg * w * q.val;
}

// Main: estimate total from grouped shopping list
function estimateShoppingCost(grouped){
  var total = 0;
  Object.values(grouped).forEach(function(items){
    items.forEach(function(item){
      total += estimateItemCost(item.name, item.qty);
    });
  });
  return total;
}

// Estimation fourchette prix par recette (pour 2 personnes)
function estimateRecipePrice(recipe){
  if(!recipe) return null;
  // Base selon tags
  var base = 6;
  var tag = (recipe.tag1||"").toUpperCase();
  var title = (recipe.title||"").toLowerCase();
  if(tag==="POISSON" || tag==="FRUITS DE MER") base = 9;
  else if(tag==="VIANDE") base = 8;
  else if(tag==="POULET") base = 7;
  else if(tag==="VÉGÉTARIEN" || tag==="VEGETARIEN") base = 5;
  else if(tag==="PÂTES" || tag==="PATES") base = 5;
  else if(tag==="BURGER") base = 7;
  else if(tag==="GRATIN" || tag==="TRADITIONNEL") base = 6;
  // Ajuster selon nb ingrédients
  var ing = recipe.ing ? recipe.ing.length : 4;
  if(ing > 7) base += 2;
  else if(ing < 4) base -= 1;
  var lo = Math.max(3, base - 2);
  var hi = base + 3;
  return {lo: lo, hi: hi};
}

function renderShoppingList(){
  var body = document.getElementById("shop-body");
  body.innerHTML = "";

  var weekLbl = document.getElementById("shop-week-label");
  if(weekLbl) weekLbl.textContent = "";

  // Collecter toutes les semaines planifiées
  var allWeekKeys = Object.keys(state.allWeeks).filter(function(k){
    return Object.keys(state.allWeeks[k]).length > 0;
  }).sort();

  // Migration : inclure weekPlanning si allWeeks vide
  if(allWeekKeys.length === 0 && Object.keys(state.weekPlanning).length > 0){
    allWeekKeys = ["current"];
  }

  var totalMeals = allWeekKeys.reduce(function(acc, k){
    var wp = filteredWeeks[k] || {};
    return acc + Object.keys(wp).length;
  }, 0);

  var countEl = document.getElementById("shop-count-label");
  var summaryEl = document.getElementById("shop-recipes-summary");

  if(totalMeals === 0){
    if(countEl) countEl.textContent = "Planifiez des repas pour générer la liste";
    var _ce = document.getElementById("shop-cost-label"); if(_ce) _ce.style.display = "none";
    if(summaryEl) summaryEl.style.display = "none";
    var em = document.createElement("div");
    em.style.cssText = "display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 30px;text-align:center;";
    em.innerHTML = "<div style='font-size:52px;opacity:.3;margin-bottom:14px;'>🛒</div><div style='font-family:Playfair Display,Georgia,serif;font-size:18px;font-weight:700;color:#1A1A2E;margin-bottom:8px;'>Liste vide</div><div style='font-size:12px;color:#6B7280;line-height:1.7;'>Ajoutez des recettes à votre planning<br>pour générer la liste automatiquement.</div>";
    body.appendChild(em);
    return;
  }

  // Récapitulatif recettes (toutes semaines)
  if(summaryEl){
    var recipeCount = {};
    allWeekKeys.forEach(function(k){
      var wp = k === "current" ? state.weekPlanning : state.allWeeks[k];
      Object.values(wp).forEach(function(rid){
        recipeCount[rid] = (recipeCount[rid]||0)+1;
      });
    });
    var totalRecipes = Object.values(recipeCount).reduce(function(a,b){return a+b;},0);
    var sumLo = 0, sumHi = 0;
    var inner = "<div style='font-size:11px;font-weight:700;color:#6B7280;letter-spacing:.4px;text-transform:uppercase;margin-bottom:6px;'>"+totalRecipes+" repas planifiés :</div>";
    Object.keys(recipeCount).forEach(function(rid){
      var r = getRecipe(parseInt(rid)); if(!r) return;
      var cnt = recipeCount[rid];
      var rp = estimateRecipePrice(r);
      if(rp){ sumLo += rp.lo * cnt; sumHi += rp.hi * cnt; }
      var priceStr = rp ? "<span style='color:#FF3E7F;font-weight:600;'>~"+rp.lo+"-"+rp.hi+"€</span>" : "";
      inner += "<div style='font-size:12px;color:#1A1A2E;padding:2px 0 2px 10px;border-left:2px solid #FF3E7F;margin-bottom:3px;display:flex;justify-content:space-between;align-items:center;'>"+
        "<span>"+r.title+(cnt>1?" <span style='color:#FF3E7F;font-weight:700;'>×"+cnt+"</span>":"")+"</span>"+
        priceStr+
        "</div>";
    });
    if(sumLo > 0){
      inner += "<div style='margin-top:8px;padding-top:8px;border-top:1px solid #F0F0F5;display:flex;justify-content:space-between;align-items:center;'>"+
        "<span style='font-size:12px;font-weight:700;color:#1A1A2E;'>Total estimé</span>"+
        "<span style='font-size:14px;font-weight:700;color:#FF3E7F;'>~"+sumLo+"-"+sumHi+" €</span>"+
        "</div>";
    }
    summaryEl.innerHTML = inner;
    summaryEl.style.display = "block";
  }

  var totalItems = 0, checkedCount = 0;
  var totalCost = 0;

  // ── Afficher par semaine ──────────────────────────────────
  allWeekKeys.forEach(function(wkey){
    var wp = wkey === "current" ? state.weekPlanning : state.allWeeks[wkey];
    if(!Object.keys(wp).length) return;

    // Header semaine
    var weekHeader = document.createElement("div");
    weekHeader.style.cssText = "margin:16px 0 10px;background:#FFF5F8;border-radius:14px;padding:12px 14px;border-left:3px solid #FF3E7F;";

    // Calculer label semaine depuis la clé YYYY-WNN
    var weekLabelText = "Semaine";
    if(wkey !== "current"){
      try {
        var parts = wkey.split("-W");
        var year = parseInt(parts[0]);
        var week = parseInt(parts[1]);
        var jan4 = new Date(year, 0, 4);
        var jan4day = jan4.getDay() || 7;
        var mon = new Date(jan4.getTime() + (week-1)*7*86400000 - (jan4day-1)*86400000);
        var sun = new Date(mon.getTime() + 6*86400000);
        var months = ["jan","fév","mar","avr","mai","jun","jul","aoû","sep","oct","nov","déc"];
        var monStr = mon.getDate()+" "+months[mon.getMonth()];
        var sunStr = sun.getDate()+" "+months[sun.getMonth()]+" "+sun.getFullYear();
        var curKey = getWeekKey(0);
        var nextKey = getWeekKey(1);
        if(wkey === curKey) weekLabelText = "📅 Cette semaine · "+monStr+" – "+sunStr;
        else if(wkey === nextKey) weekLabelText = "📅 Semaine prochaine · "+monStr+" – "+sunStr;
        else weekLabelText = "📅 Semaine du "+monStr+" – "+sunStr;
      } catch(e){ weekLabelText = "📅 "+wkey; }
    } else {
      weekLabelText = "📅 Cette semaine";
    }

    // Recettes de cette semaine
    var weekRecipes = {};
    Object.values(wp).forEach(function(rid){
      weekRecipes[rid] = (weekRecipes[rid]||0)+1;
    });
    var recipePills = Object.keys(weekRecipes).map(function(rid){
      var r = getRecipe(parseInt(rid));
      if(!r) return "";
      var cnt = weekRecipes[rid];
      return r.emoji+" "+r.title+(cnt>1?" <b style='color:#FF3E7F;'>×"+cnt+"</b>":"");
    }).filter(Boolean).join("  •  ");

    weekHeader.innerHTML =
      "<div style='font-size:12px;font-weight:700;color:#FF3E7F;margin-bottom:6px;'>"+weekLabelText+"</div>"+
      "<div style='font-size:11px;color:#6B7280;line-height:1.7;'>"+recipePills+"</div>";
    body.appendChild(weekHeader);

    // Construire la liste de cette semaine
    var grouped = computeShoppingListForWeek(wp);

    // Source ingrédients
    var ingredientSources = {};
    Object.values(wp).forEach(function(rid){
      var r = getRecipe(rid); if(!r) return;
      r.ing.forEach(function(pair){
        var key = pair[0].toLowerCase().trim();
        if(!ingredientSources[key]) ingredientSources[key] = [];
        if(ingredientSources[key].indexOf(r.title) === -1) ingredientSources[key].push(r.title);
      });
    });

    var catOrder = Object.keys(ING_CATEGORIES);
    Object.keys(grouped).forEach(function(c){ if(catOrder.indexOf(c)===-1) catOrder.push(c); });

    catOrder.forEach(function(cat){
      var items = grouped[cat];
      if(!items || !items.length) return;
      totalItems += items.length;

      var section = document.createElement("div");
      section.style.cssText = "margin-bottom:12px;";

      var title = document.createElement("div");
      title.style.cssText = "font-size:11px;font-weight:700;color:#6B7280;letter-spacing:.5px;margin-bottom:6px;padding:0 2px;";
      title.textContent = cat;
      section.appendChild(title);

      var card = document.createElement("div");
      card.style.cssText = "background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 1px 6px rgba(0,0,0,.06);";

      items.forEach(function(item, idx){
        var checked = !!state.checkedItems[item.key];
        if(checked) checkedCount++;
        var unitCost = estimateItemCost(item.name, item.qty);
        totalCost += unitCost;

        var row = document.createElement("div");
        row.style.cssText = "display:flex;align-items:center;gap:12px;padding:10px 14px;"+
          (idx < items.length-1 ? "border-bottom:1px solid #F0F0F5;" : "")+
          (checked ? "opacity:.45;" : "")+"cursor:pointer;transition:opacity .15s;";

        var cb = document.createElement("div");
        cb.style.cssText = "width:22px;height:22px;border-radius:7px;border:2px solid "+
          (checked ? "#10B981;background:#10B981;" : "#D1D5DB;")+
          "display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:13px;color:#fff;transition:all .18s;";
        cb.textContent = checked ? "✓" : "";

        var nameWrap = document.createElement("div");
        nameWrap.style.cssText = "flex:1;min-width:0;";

        var name = document.createElement("div");
        name.style.cssText = "font-size:13px;font-weight:500;"+(checked?"text-decoration:line-through;color:#9CA3AF;":"color:#1A1A2E;");
        name.textContent = item.name;

        var sources = ingredientSources[item.name.toLowerCase().trim()];
        if(sources && sources.length){
          var src = document.createElement("div");
          src.style.cssText = "font-size:10px;color:#9CA3AF;margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;";
          src.textContent = "← "+sources.join(", ");
          nameWrap.appendChild(name);
          nameWrap.appendChild(src);
        } else {
          nameWrap.appendChild(name);
        }

        var qty = document.createElement("span");
        qty.style.cssText = "display:flex;flex-direction:column;align-items:flex-end;flex-shrink:0;gap:1px;";
        var qtyVal = document.createElement("span");
        qtyVal.style.cssText = "font-size:12px;font-weight:700;color:#FF3E7F;";
        qtyVal.textContent = item.qty;
        qty.appendChild(qtyVal);

        row.appendChild(cb);
        row.appendChild(nameWrap);
        row.appendChild(qty);

        row.addEventListener("click", function(){
          if(state.checkedItems[item.key]) delete state.checkedItems[item.key];
          else state.checkedItems[item.key] = true;
          saveToStorage();
          renderShoppingList();
        });

        card.appendChild(row);
      });

      section.appendChild(card);
      body.appendChild(section);
    });
  });

  // ── Ajouts manuels ────────────────────────────────────────
  if(state.manualItems.length > 0){
    var manualHeader = document.createElement("div");
    manualHeader.style.cssText = "margin:16px 0 10px;";
    manualHeader.innerHTML = "<div style='font-size:13px;font-weight:700;color:#1A1A2E;'>🛒 Mes ajouts</div>";
    body.appendChild(manualHeader);

    var manualBycat = {};
    state.manualItems.forEach(function(it){
      var c = it.category||"📦 Autres";
      if(!manualBycat[c]) manualBycat[c]=[];
      manualBycat[c].push(it);
    });

    Object.keys(manualBycat).forEach(function(cat){
      var items = manualBycat[cat];
      totalItems += items.length;

      var section = document.createElement("div");
      section.style.cssText = "margin-bottom:12px;";

      var title = document.createElement("div");
      title.style.cssText = "font-size:11px;font-weight:700;color:#6B7280;letter-spacing:.5px;margin-bottom:6px;padding:0 2px;";
      title.textContent = cat;
      section.appendChild(title);

      var card = document.createElement("div");
      card.style.cssText = "background:#fff;border-radius:14px;overflow:hidden;box-shadow:0 1px 6px rgba(0,0,0,.06);";

      items.forEach(function(it, idx){
        var checked = !!it.checked;
        if(checked) checkedCount++;

        var row = document.createElement("div");
        row.style.cssText = "display:flex;align-items:center;gap:12px;padding:10px 14px;"+
          (idx<items.length-1?"border-bottom:1px solid #F0F0F5;":"")+
          (checked?"opacity:.45;":"")+"cursor:pointer;";

        var cb = document.createElement("div");
        cb.style.cssText = "width:22px;height:22px;border-radius:7px;border:2px solid "+
          (checked?"#10B981;background:#10B981;":"#D1D5DB;")+
          "display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:13px;color:#fff;";
        cb.textContent = checked?"✓":"";

        var name = document.createElement("div");
        name.style.cssText = "flex:1;font-size:13px;font-weight:500;"+(checked?"text-decoration:line-through;color:#9CA3AF;":"color:#1A1A2E;");
        name.textContent = it.name;

        var del = document.createElement("button");
        del.style.cssText = "background:none;border:none;font-size:18px;color:#D1D5DB;cursor:pointer;padding:0 4px;flex-shrink:0;";
        del.textContent = "×";
        del.addEventListener("click", function(e){
          e.stopPropagation();
          state.manualItems = state.manualItems.filter(function(x){ return x.id!==it.id; });
          saveToStorage();
          renderShoppingList();
        });

        row.appendChild(cb);
        row.appendChild(name);
        row.appendChild(del);

        row.addEventListener("click", function(e){
          if(e.target===del) return;
          it.checked = !it.checked;
          saveToStorage();
          renderShoppingList();
        });

        card.appendChild(row);
      });

      section.appendChild(card);
      body.appendChild(section);
    });
  }

  if(countEl) countEl.textContent = totalItems+" article"+(totalItems>1?"s":"")+" · "+checkedCount+" coché"+(checkedCount>1?"s":"");

  // Masquer la fenêtre d'estimation séparée (consolidée dans le récap)
  var costEl = document.getElementById("shop-cost-label");
  if(costEl) costEl.style.display = "none";
}


/* ═══════════════════════════════════════════
   PDF EXPORT
═══════════════════════════════════════════ */

/* ═══════════════════════════════════════════
   SWIPE GESTURE
═══════════════════════════════════════════ */
function initSwipeGesture(){
  var card = document.getElementById("swipe-card");
  if(!card) return;

  var startX=0, startY=0, isDragging=false, swipeLocked=false, startTime=0;
  var lastTap=0;
  var SWIPE_THRESHOLD = 72;

  function onDragMove(dx){
    card.style.transition = "none";
    card.style.transform = "translateX("+dx+"px) rotate("+(dx*0.04)+"deg)";
    document.getElementById("badge-left").style.opacity  = dx < -20 ? Math.min(1,Math.abs(dx)/80) : 0;
    document.getElementById("badge-right").style.opacity = dx >  20 ? Math.min(1,dx/80) : 0;
  }
  function onDragEnd(dx){
    document.getElementById("badge-left").style.opacity  = 0;
    document.getElementById("badge-right").style.opacity = 0;
    if(dx < -SWIPE_THRESHOLD)      doSwipe("left");
    else if(dx > SWIPE_THRESHOLD)  doSwipe("right");
    else{ card.style.transition="transform .3s ease"; card.style.transform=""; }
  }

  /* ─── MOUSE ─────────────────────────────── */
  card.addEventListener("mousedown", function(e){
    startX=e.clientX; startY=e.clientY;
    isDragging=true; swipeLocked=false; startTime=Date.now();
    card.classList.add("dragging");
    e.preventDefault();
  });
  document.addEventListener("mousemove", function(e){
    if(!isDragging) return;
    onDragMove(e.clientX - startX);
  });
  document.addEventListener("mouseup", function(e){
    if(!isDragging) return;
    isDragging=false; card.classList.remove("dragging");
    onDragEnd(e.clientX - startX);
  });

  /* ─── TOUCH ─────────────────────────────── */
  card.addEventListener("touchstart", function(e){
    var t = e.touches[0];
    startX=t.clientX; startY=t.clientY;
    isDragging=true; swipeLocked=false; startTime=Date.now();
    card.classList.add("dragging");
  }, {passive:true});

  card.addEventListener("touchmove", function(e){
    if(!isDragging) return;
    var t  = e.touches[0];
    var dx = t.clientX - startX;
    var dy = t.clientY - startY;

    if(!swipeLocked){
      if(Math.abs(dx) > 10 && Math.abs(dx) > Math.abs(dy)){
        swipeLocked = true;       // mouvement horizontal → on prend le contrôle
      } else if(Math.abs(dy) > 10){
        isDragging = false;       // mouvement vertical → on laisse scroller
        card.style.transition="transform .3s ease"; card.style.transform="";
        document.getElementById("badge-left").style.opacity=0;
        document.getElementById("badge-right").style.opacity=0;
        return;
      } else { return; }          // encore indéterminé
    }

    e.preventDefault();           // bloque le scroll pendant le swipe horizontal
    onDragMove(dx);
  }, {passive:false});             // ← DOIT être false pour pouvoir preventDefault

  card.addEventListener("touchend", function(e){
    var now = Date.now();
    card.classList.remove("dragging");

    // Double-tap
    if(!isDragging || !swipeLocked){
      if(now - lastTap < 280){
        var r = currentRecipe();
        if(r) openDetail(r.id,"main");
      }
      lastTap = now;
      if(!isDragging){ return; }
    }
    lastTap = now;

    isDragging = false;
    var dx = e.changedTouches[0].clientX - startX;

    if(!swipeLocked){
      card.style.transition="transform .3s ease"; card.style.transform="";
      document.getElementById("badge-left").style.opacity=0;
      document.getElementById("badge-right").style.opacity=0;
      return;
    }
    onDragEnd(dx);
  }, {passive:true});

  card.addEventListener("touchcancel", function(){
    isDragging=false; swipeLocked=false;
    card.classList.remove("dragging");
    card.style.transition="transform .3s ease"; card.style.transform="";
    document.getElementById("badge-left").style.opacity=0;
    document.getElementById("badge-right").style.opacity=0;
  }, {passive:true});

  /* ─── Double-click desktop ───────────────── */
  card.addEventListener("dblclick", function(){
    var r = currentRecipe();
    if(r) openDetail(r.id,"main");
  });
}

/* ═══════════════════════════════════════════
   BIND HELPER
═══════════════════════════════════════════ */
function bind(id,fn){var el=document.getElementById(id);if(el) el.addEventListener("click",fn);}

/* ═══════════════════════════════════════════
   INIT
═══════════════════════════════════════════ */

/* ═══════════════════════════════════════════
   PROFILE SCREEN
═══════════════════════════════════════════ */
function openProfile(){
  // Sync UI to current state.profile
  var p=state.profile;
  // Email
  var em=document.getElementById("prof-email");
  if(em) em.value=p.email||"";
  // Diet
  document.querySelectorAll(".prof2-diet-opt").forEach(function(el){
    var sel=el.getAttribute("data-diet")===p.diet;
    el.classList.toggle("sel",sel);
    var chk=el.querySelector(".prof2-diet-chk");
    if(chk) chk.textContent=sel?"✓":"";
  });
  // Allergies
  document.querySelectorAll(".prof2-allergy-chip").forEach(function(el){
    el.classList.toggle("sel", p.allergies.indexOf(el.getAttribute("data-allergy"))!==-1);
  });
  // Disliked
  renderDislikedTags();
  // Avatar sub
  var sub=document.getElementById("prof-display-diet");
  if(sub) sub.textContent=p.diet+(p.allergies.length?" · "+p.allergies.length+" allergie(s)":"");
  navigateTo("profile");
}

function renderDislikedTags(){
  var wrap=document.getElementById("prof-dislike-tags");
  if(!wrap) return;
  wrap.innerHTML="";
  state.profile.disliked.forEach(function(item,idx){
    var tag=document.createElement("div");
    tag.className="prof2-dislike-tag";
    tag.innerHTML="<span>"+item+"</span><button data-idx='"+idx+"'>✕</button>";
    tag.querySelector("button").addEventListener("click",function(){
      state.profile.disliked.splice(idx,1);
      renderDislikedTags();
    });
    wrap.appendChild(tag);
  });
}

function saveProfile(){
  var p=state.profile;
  var em=document.getElementById("prof-email");
  if(em) p.email=em.value.trim();
  // Rebuild deck with new profile (reset seen)
  state.seenIds={};
  _buildDeck(false);
  // Update avatar
  var sub=document.getElementById("prof-display-diet");
  if(sub) sub.textContent=p.diet+(p.allergies.length?" · "+p.allergies.length+" allergie(s)":"");
  toast("✅ Profil sauvegardé !");
  navigateTo("main");
}

function initProfileScreen(){
  // Back button
  var back=document.getElementById("btn-profile-back");
  if(back) back.addEventListener("click",function(){ navigateTo("main"); });
  // Save
  var save=document.getElementById("btn-profile-save");
  if(save) save.addEventListener("click",saveProfile);
  // Open profile btn in main header
  var open=document.getElementById("btn-open-profile");
  if(open) open.addEventListener("click",openProfile);
  // Diet options
  var dietGrid=document.getElementById("prof-diet-grid");
  if(dietGrid){
    dietGrid.addEventListener("click",function(e){
      var opt=e.target.closest(".prof2-diet-opt");
      if(!opt) return;
      state.profile.diet=opt.getAttribute("data-diet");
      document.querySelectorAll(".prof2-diet-opt").forEach(function(el){
        var sel=el===opt;
        el.classList.toggle("sel",sel);
        var chk=el.querySelector(".prof2-diet-chk");
        if(chk) chk.textContent=sel?"✓":"";
      });
    });
  }
  // Allergy chips
  var allergyGrid=document.getElementById("prof-allergy-grid");
  if(allergyGrid){
    allergyGrid.addEventListener("click",function(e){
      var chip=e.target.closest(".prof2-allergy-chip");
      if(!chip) return;
      var a=chip.getAttribute("data-allergy");
      var idx=state.profile.allergies.indexOf(a);
      if(idx===-1){ state.profile.allergies.push(a); chip.classList.add("sel"); }
      else { state.profile.allergies.splice(idx,1); chip.classList.remove("sel"); }
    });
  }
  // Disliked input
  var dinp=document.getElementById("prof-dislike-inp");
  var dadd=document.getElementById("prof-dislike-add");
  function addDisliked(){
    if(!dinp) return;
    var v=dinp.value.trim().toLowerCase();
    if(!v||state.profile.disliked.indexOf(v)!==-1){dinp.value="";return;}
    state.profile.disliked.push(v);
    renderDislikedTags();
    dinp.value="";
  }
  if(dadd) dadd.addEventListener("click",addDisliked);
  if(dinp) dinp.addEventListener("keydown",function(e){if(e.key==="Enter"){e.preventDefault();addDisliked();}});
  // Logout
  var logout=document.getElementById("btn-prof-logout");
  if(logout) logout.addEventListener("click",function(){navigateTo("splash");});
  // Swipe-end buttons
  var restart=document.getElementById("btn-swipe-restart");
  if(restart) restart.addEventListener("click",function(){
    state.seenIds={};
    _buildDeck(false);
    renderCard();
    var se=document.getElementById("swipe-end");
    if(se) se.style.display="none";
  });
  var goSaved=document.getElementById("btn-swipe-go-saved");
  if(goSaved) goSaved.addEventListener("click",function(){navigateTo("saved");});
}

/* ═══════════════════════════════════════════
   AJOUTS MANUELS — LISTE DE COURSES
═══════════════════════════════════════════ */
var _selectedManualCat = "📦 Autres";

window.openAddManualModal = function openAddManualModal(){
  var modal = document.getElementById("modal-add-manual");
  var input = document.getElementById("manual-item-input");
  var picker = document.getElementById("manual-cat-picker");

  // Reset
  input.value = "";
  _selectedManualCat = "📦 Autres";
  picker.innerHTML = "";

  // Construire les boutons de catégorie
  MANUAL_CATEGORIES.forEach(function(cat){
    var btn = document.createElement("button");
    btn.textContent = cat;
    btn.dataset.cat = cat;
    btn.style.cssText = "padding:6px 10px;border-radius:20px;border:2px solid #F0F0F5;background:transparent;font-size:11px;font-weight:600;cursor:pointer;transition:all .15s;color:#6B7280;font-family:inherit;";
    btn.addEventListener("click", function(){
      _selectedManualCat = cat;
      Array.from(picker.children).forEach(function(b){
        b.style.background = "transparent";
        b.style.borderColor = "#F0F0F5";
        b.style.color = "#6B7280";
      });
      btn.style.background = "#FF3E7F";
      btn.style.borderColor = "#FF3E7F";
      btn.style.color = "#fff";
    });
    picker.appendChild(btn);
  });

  // Sélectionner "Autres" par défaut
  picker.children[picker.children.length-1].click();

  modal.style.display = "flex";
  setTimeout(function(){ input.focus(); }, 100);
}

window.closeAddManualModal = function closeAddManualModal(){
  document.getElementById("modal-add-manual").style.display = "none";
}

window.confirmAddManual = function confirmAddManual(){
  var input = document.getElementById("manual-item-input");
  var name = input.value.trim();
  if(!name) return;

  // Auto-détecter la catégorie si possible
  var autoCat = null;
  var nameLower = name.toLowerCase();
  Object.keys(ING_CATEGORIES).forEach(function(cat){
    if(autoCat) return;
    ING_CATEGORIES[cat].forEach(function(kw){
      if(nameLower.indexOf(kw) !== -1) autoCat = cat;
    });
  });

  state.manualItems.push({
    id: Date.now(),
    name: name,
    category: autoCat || _selectedManualCat,
    checked: false
  });

  saveToStorage();
  closeAddManualModal();
  renderShoppingList();
}

// Fermer modal en cliquant dehors
document.addEventListener("click", function(e){
  var modal = document.getElementById("modal-add-manual");
  if(modal && modal.style.display === "flex" && e.target === modal){
    closeAddManualModal();
  }
});

// Enter pour valider
document.addEventListener("keydown", function(e){
  if(e.key === "Enter"){
    var modal = document.getElementById("modal-add-manual");
    if(modal && modal.style.display === "flex") confirmAddManual();
  }
});


function updateWeekLabel(){
  var el = document.getElementById("cal-week-label");
  if(!el) return;
  var offset = state.weekOffset||0;
  var mon = getMonday(offset);
  var sun = addDays(mon,6);
  var label = fmtShort(mon)+" – "+fmtFull(sun);
  if(offset===0) label = "Cette semaine · "+label;
  else if(offset===1) label = "Semaine prochaine · "+label;
  else if(offset===-1) label = "Semaine dernière · "+label;
  else if(offset>0) label = "Dans "+offset+" sem. · "+label;
  else label = "Il y a "+Math.abs(offset)+" sem. · "+label;
  el.textContent = label;
}


window.filterSavedRecipes = function(query){
  state._savedSearch = query.toLowerCase().trim();
  renderSavedScreen();
};


window.openShopHistory = function(){
  var modal = document.getElementById("modal-shop-history");
  var histBody = document.getElementById("shop-history-body");
  if(!modal || !histBody) return;
  histBody.innerHTML = "";

  if(!state.shoppingHistory || state.shoppingHistory.length === 0){
    var empty = document.createElement("div");
    empty.style.cssText = "text-align:center;padding:30px;color:#9CA3AF;font-size:13px;line-height:1.7;";
    empty.textContent = "Aucun historique pour l’instant. Appuie sur Courses faites après tes courses !";
    histBody.appendChild(empty);
  } else {
    state.shoppingHistory.forEach(function(entry){
      var card = document.createElement("div");
      card.style.cssText = "background:#fff;border-radius:16px;padding:14px;margin-bottom:12px;box-shadow:0 1px 6px rgba(0,0,0,.06);";
      var dateEl = document.createElement("div");
      dateEl.style.cssText = "font-size:11px;font-weight:700;color:#6B7280;letter-spacing:.5px;margin-bottom:8px;text-transform:uppercase;";
      dateEl.textContent = "✅ " + entry.date;
      card.appendChild(dateEl);
      (entry.recipes||[]).forEach(function(r){
        var line = document.createElement("div");
        line.style.cssText = "font-size:12px;color:#1A1A2E;line-height:1.8;";
        line.textContent = r.emoji + " " + r.title;
        card.appendChild(line);
      });
      var footer = document.createElement("div");
      footer.style.cssText = "display:flex;justify-content:space-between;font-size:11px;color:#9CA3AF;margin-top:8px;";
      var left = document.createElement("span");
      left.textContent = (entry.itemCount||0) + " ingrédients";
      footer.appendChild(left);
      if(entry.totalLo > 0){
        var right = document.createElement("span");
        right.style.cssText = "color:#FF3E7F;font-weight:700;";
        right.textContent = "~" + entry.totalLo + "-" + entry.totalHi + "€";
        footer.appendChild(right);
      }
      card.appendChild(footer);
      histBody.appendChild(card);
    });
  }
  modal.style.display = "flex";
};

window.closeShopHistory = function(){
  var modal = document.getElementById("modal-shop-history");
  if(modal) modal.style.display = "none";
};


function init(){
  // Charger les données sauvegardées
  loadFromStorage();

  // Skip onboarding si utilisateur déjà connu
  if(state.likedIds.length > 0 || Object.keys(state.weekPlanning).length > 0 || Object.keys(state.checkedItems).length > 0){
    showScreen("main");
    _buildDeck(false);
    renderCard();
    renderSavedScreen();
    renderCalendar();
    renderShoppingList();
    updateBadges(false);
  }

  // Onboarding
  bind("btn-start",function(){goTo("onboard");});
  bind("btn-to-allergies",function(){goTo("allergies");});
  bind("btn-login",function(){goTo("allergies");});
  bind("btn-to-diet",function(){goTo("diet");});
  bind("btn-skip-a",function(){goTo("diet");});
  bind("btn-to-main",function(){goTo("main");renderCard();});
  bind("btn-logout",function(){goTo("splash");});

  // Swipe
  bind("btn-pass",function(){doSwipe("left");});
  bind("btn-save",function(){doSwipe("right");});
  bind("btn-info",function(){openDetail(currentRecipe().id,"main");});

  // Detail
  bind("btn-det-back",function(){goTo(state.detailFrom);});
  bind("btn-det-fav",function(){
    var id=state.detailRecipeId;
    var btn=document.getElementById("btn-det-fav");
    if(isLiked(id)){unlikeRecipe(id);btn.textContent="★";toast("Recette retirée");}
    else{likeRecipe(id);btn.textContent="♥";btn.classList.add("heart-burst");setTimeout(function(){btn.classList.remove("heart-burst");},420);toast("✓ Recette sauvegardée !");}
  });
  bind("btn-add-to-planning",function(){openPlanningPicker(state.detailRecipeId);});

  // Planning picker
  bind("pt-midi",function(){
    state.pickerTime="midi";
    document.getElementById("pt-midi").classList.add("selected");
    document.getElementById("pt-soir").classList.remove("selected");
  });
  bind("pt-soir",function(){
    state.pickerTime="soir";
    document.getElementById("pt-soir").classList.add("selected");
    document.getElementById("pt-midi").classList.remove("selected");
  });
  bind("btn-confirm-plan",function(){confirmPlanning();});

  // Portions
  bind("btn-pm",function(){state.portions=Math.max(1,state.portions-1);document.getElementById("pnum").textContent=state.portions;});
  bind("btn-pp",function(){state.portions=Math.min(10,state.portions+1);document.getElementById("pnum").textContent=state.portions;});

  // Filter modal
  bind("btn-filter",function(){openModal("filt-modal");});
  bind("overlay",function(){closeModal();});
  bind("btn-apply-filt",function(){closeModal();});
  for(var i=0;i<6;i++){(function(idx){var el=document.getElementById("fc"+idx);if(el) el.addEventListener("click",function(){el.classList.toggle("selected");});})(i);}
  var pills=document.querySelectorAll(".filt-pill");
  pills.forEach(function(p){p.addEventListener("click",function(){pills.forEach(function(q){q.classList.remove("active");});p.classList.add("active");});});

  // Allergy chips
  document.querySelectorAll(".allergy-chip").forEach(function(el){el.addEventListener("click",function(){el.classList.toggle("selected");});});

  // Diet
  for(var i=0;i<4;i++){(function(idx){var el=document.getElementById("diet"+idx);if(!el) return;
    el.addEventListener("click",function(){
      for(var j=0;j<4;j++){var d=document.getElementById("diet"+j);if(d){d.classList.remove("selected");d.querySelector(".diet-chk").textContent="";}}
      el.classList.add("selected");el.querySelector(".diet-chk").textContent="✓";
    });
  })(i);}

  // Toggles
  ["tog0","tog1","tog2"].forEach(function(id){var el=document.getElementById(id);if(el) el.addEventListener("click",function(){el.querySelector(".toggle").classList.toggle("on");});});

  // Saved multi-select
  bind("btn-select-mode",function(){
    state.selectMode=true;state.selectedIds=[];
    document.getElementById("sel-toolbar").classList.add("visible");
    document.getElementById("sel-info").textContent="0 sélectionnée(s)";
    renderSavedScreen();
  });
  bind("btn-cancel-sel",function(){exitSelectMode();});
  bind("btn-sel-all",function(){
    if(state.selectedIds.length===state.likedIds.length) state.selectedIds=[];
    else state.selectedIds=state.likedIds.slice();
    document.getElementById("sel-info").textContent=state.selectedIds.length+" sélectionnée(s)";
    renderSavedScreen();
  });
  bind("btn-del-selected",function(){
    if(!state.selectedIds.length){toast("Aucune sélection");return;}
    var cards=document.querySelectorAll(".saved-card.selected");
    cards.forEach(function(c){c.classList.add("card-exit");});
    var toRemove=state.selectedIds.slice();
    toast(toRemove.length+" recette(s) supprimée(s)");
    setTimeout(function(){
      toRemove.forEach(function(id){unlikeRecipe(id);});
      state.selectedIds=[];
      if(state.likedIds.length===0) exitSelectMode();
      else renderSavedScreen();
    },260);
  });

  // Calendar
  bind("btn-week-prev",function(){
    state.weekOffset=(state.weekOffset||0)-1;
    renderCalendar();
    renderShoppingList();
    updateWeekLabel();
  });
  bind("btn-week-next",function(){
    state.weekOffset=(state.weekOffset||0)+1;
    renderCalendar();
    renderShoppingList();
    updateWeekLabel();
  });
  bind("btn-shop-history", function(){ openShopHistory(); });

  bind("btn-courses-faites", function(){
    // Collecter les recettes non-achetées pour archiver
    var allWeekKeys = Object.keys(state.allWeeks).filter(function(k){
      return Object.keys(state.allWeeks[k]).length > 0;
    });
    if(allWeekKeys.length === 0 && Object.keys(state.weekPlanning).length > 0){
      allWeekKeys = ["current"];
    }
    var filteredWeeks = {};
    allWeekKeys.forEach(function(wkey){
      var wp = wkey==="current" ? state.weekPlanning : state.allWeeks[wkey];
      var filtered = {};
      Object.keys(wp).forEach(function(slot){
        var rid = wp[slot];
        if(!state.boughtRecipes[wkey+"_"+rid] && !state.boughtRecipes["current_"+rid]){
          filtered[slot] = rid;
        }
      });
      if(Object.keys(filtered).length > 0) filteredWeeks[wkey] = filtered;
    });

    var recipesToArchive = [];
    var sumLo = 0, sumHi = 0, itemCount = 0;
    Object.keys(filteredWeeks).forEach(function(wkey){
      Object.values(filteredWeeks[wkey]).forEach(function(rid){
        var r = getRecipe(parseInt(rid)); if(!r) return;
        recipesToArchive.push({title: r.title, emoji: r.emoji});
        var rp = estimateRecipePrice(r);
        if(rp){ sumLo+=rp.lo; sumHi+=rp.hi; }
        itemCount += r.ing ? r.ing.length : 0;
      });
    });

    if(recipesToArchive.length === 0 && state.manualItems.length === 0){
      toast("Aucune course à archiver"); return;
    }

    // Archiver
    if(recipesToArchive.length > 0){
      var now = new Date();
      var months = ["jan","fév","mar","avr","mai","jun","jul","aoû","sep","oct","nov","déc"];
      state.shoppingHistory.unshift({
        date: now.getDate()+" "+months[now.getMonth()]+" "+now.getFullYear(),
        recipes: recipesToArchive, totalLo: sumLo, totalHi: sumHi, itemCount: itemCount
      });
      if(state.shoppingHistory.length > 10) state.shoppingHistory = state.shoppingHistory.slice(0,10);
    }

    // Marquer toutes comme achetées
    Object.keys(filteredWeeks).forEach(function(wkey){
      Object.keys(filteredWeeks[wkey]).forEach(function(slot){
        state.boughtRecipes[wkey+"_"+filteredWeeks[wkey][slot]] = true;
      });
    });

    state.manualItems = [];
    state.checkedItems = {};
    saveToStorage();
    renderShoppingList();
    renderCalendar();
    toast("🎉 Courses archivées ! Bon appétit !");
  });

  bind("btn-clear-week",function(){
    var wkey=getWeekKey(state.weekOffset);
    state.allWeeks[wkey]={};
    state.checkedItems={};
    updateBadges(false);
    saveToStorage();
    renderCalendar();renderShoppingList();
    toast("Planning vidé");
  });

  // Shopping
  // Shopping action buttons removed (export/reset/share)

  // Swipe gesture on card
  initSwipeGesture();

  // Create recipe screen
  initCreateScreen();

  // Profile screen
  initProfileScreen();

  // Saved screen — edit mode
  var btnToggleEdit = document.getElementById("btn-toggle-edit");
  if(btnToggleEdit) btnToggleEdit.addEventListener("click", function(){
    _editMode = !_editMode;
    _selectedIds = {};
    renderSavedScreen();
  });
  var btnSelAll = document.getElementById("btn-sel-all");
  if(btnSelAll) btnSelAll.addEventListener("click", function(){
    var allSelected = state.likedIds.length === Object.keys(_selectedIds).length;
    if(allSelected){ _selectedIds = {}; }
    else { state.likedIds.forEach(function(id){ _selectedIds[id] = true; }); }
    renderSavedScreen();
  });
  var btnDelSel = document.getElementById("btn-del-sel");
  if(btnDelSel) btnDelSel.addEventListener("click", function(){
    var ids = Object.keys(_selectedIds).map(Number);
    if(!ids.length) return;
    ids.forEach(function(id){ unlikeRecipe(id); });
    _selectedIds = {};
    _editMode = false;
    renderSavedScreen();
    toast("🗑 " + ids.length + " recette" + (ids.length > 1 ? "s" : "") + " supprimée" + (ids.length > 1 ? "s" : ""));
  });

  // Init nav
  initNavBars();
  setActiveNav(0);

  // Initial renders
  _buildDeck();
  renderCard();
  updateBadges(false);
}

if(document.readyState==="loading") document.addEventListener("DOMContentLoaded",init);
else init();


/* ═══════════════════════
   PDF HELPERS
═══════════════════════ */
function pdfHeader(doc,title,subtitle){
  var margin=18,pageW=210;
  doc.setFillColor(255,62,127);
  doc.rect(0,0,pageW,14,"F");
  doc.setFont("helvetica","bold");
  doc.setFontSize(13);doc.setTextColor(255,255,255);
  doc.text("RECIPY",margin,10);
  doc.setFont("helvetica","normal");
  doc.setFontSize(9);doc.text(subtitle,pageW-margin,10,"right");
  doc.setFontSize(18);doc.setFont("helvetica","bold");doc.setTextColor(26,26,46);
  doc.text(title,margin,26);
  doc.setDrawColor(230,230,230);doc.line(margin,31,pageW-margin,31);
  return 39;
}
function pdfSectionTitle(doc,title,y,margin){
  doc.setFontSize(11);doc.setFont("helvetica","bold");doc.setTextColor(255,62,127);
  doc.text(title,margin,y);
  return y+6;
}
function pdfCheckItem(doc,name,qty,y,margin,pageW){
  if(y>275){doc.addPage();y=20;}
  doc.setDrawColor(180,180,180);doc.rect(margin,y-3.5,3.5,3.5);
  doc.setFont("helvetica","normal");doc.setFontSize(10);doc.setTextColor(50,50,50);
  doc.text(name,margin+6,y);
  doc.setTextColor(255,62,127);doc.setFont("helvetica","bold");
  doc.text(qty,pageW-margin,y,"right");
  return y+6;
}

/* ═══════════════════════
   OPTION A — Planning complet + recettes + courses
═══════════════════════ */
function exportFullPDF(){
  if(typeof window.jspdf==="undefined"){toast("PDF non disponible");return;}
  var jsPDF=window.jspdf.jsPDF;
  var doc=new jsPDF({orientation:"portrait",unit:"mm",format:"a4"});
  var margin=18,pageW=210,lineH=7;
  var y=pdfHeader(doc,"Planning de la semaine","Recipy — Export complet");

  y=pdfSectionTitle(doc,"Repas planifies",y,margin);
  var hasPlan=false;
  DAYS_FULL.forEach(function(day,di){
    ["midi","soir"].forEach(function(m){
      var rid=state.weekPlanning[di+"-"+m];
      if(rid===undefined) return;
      hasPlan=true;
      var r=getRecipe(rid);if(!r) return;
      if(y>275){doc.addPage();y=20;}
      doc.setFont("helvetica","bold");doc.setFontSize(10);doc.setTextColor(26,26,46);
      doc.text(day+" ["+(m==="midi"?"Midi":"Soir")+"]",margin,y);
      doc.setFont("helvetica","normal");doc.setTextColor(100,100,100);
      doc.text(r.title+" - "+r.time,margin+42,y);
      y+=lineH;
    });
  });
  if(!hasPlan){doc.setFont("helvetica","italic");doc.setFontSize(10);doc.setTextColor(150,150,150);doc.text("Aucun repas planifie.",margin,y);y+=lineH;}

  y+=4;if(y>255){doc.addPage();y=20;}
  doc.setDrawColor(230,230,230);doc.line(margin,y,pageW-margin,y);y+=8;
  y=pdfSectionTitle(doc,"Liste de courses consolidee",y,margin);
  var grouped=computeShoppingList();
  var catOrder=["legumes","viandes","laitiers","feculents","fruits","epicerie","boissons"];
  var catMap={"legumes":"legumes","viandes":"viandes","laitiers":"laitiers","feculents":"feculents","fruits":"fruits","epicerie":"epicerie","boissons":"boissons"};
  var allCats=Object.keys(grouped);
  allCats.forEach(function(cat){
    var items=grouped[cat];if(!items||!items.length) return;
    if(y>268){doc.addPage();y=20;}
    doc.setFont("helvetica","bold");doc.setFontSize(10);doc.setTextColor(26,26,46);
    doc.text(cat.charAt(0).toUpperCase()+cat.slice(1),margin,y);y+=5;
    items.forEach(function(item){y=pdfCheckItem(doc,item.name,item.qty,y,margin,pageW);});
    y+=3;
  });

  // Recipe pages
  var plannedIds={};
  Object.values(state.weekPlanning).forEach(function(id){plannedIds[id]=true;});
  Object.keys(plannedIds).forEach(function(id){
    var r=getRecipe(parseInt(id));if(!r) return;
    doc.addPage();
    var ry=pdfHeader(doc,r.title,r.tag1+" - "+r.time);
    doc.setFont("helvetica","normal");doc.setFontSize(10);doc.setTextColor(80,80,80);
    var dl=doc.splitTextToSize(r.desc,pageW-margin*2);
    doc.text(dl,margin,ry);ry+=dl.length*5+5;
    ry=pdfSectionTitle(doc,"Ingredients",ry,margin);
    r.ing.forEach(function(p){ry=pdfCheckItem(doc,p[0],p[1],ry,margin,pageW);});
    ry+=3;ry=pdfSectionTitle(doc,"Instructions",ry,margin);
    r.steps.forEach(function(s,i){
      if(ry>270){doc.addPage();ry=20;}
      doc.setFont("helvetica","bold");doc.setFontSize(10);doc.setTextColor(255,62,127);
      doc.text((i+1)+".",margin,ry);
      doc.setFont("helvetica","normal");doc.setTextColor(50,50,50);
      var sl=doc.splitTextToSize(s,pageW-margin*2-7);
      doc.text(sl,margin+7,ry);ry+=sl.length*5.5+2;
    });
  });

  doc.save("recipy-planning-complet.pdf");
  toast("PDF complet exporte !");
}

/* ═══════════════════════
   OPTION B — Courses seules (format magasin optimise)
═══════════════════════ */
function exportShoppingPDF(){
  if(typeof window.jspdf==="undefined"){toast("PDF non disponible");return;}
  var jsPDF=window.jspdf.jsPDF;
  var doc=new jsPDF({orientation:"portrait",unit:"mm",format:"a4"});
  var margin=18,pageW=210;
  var y=pdfHeader(doc,"Liste de courses","Format magasin");

  var grouped=computeShoppingList();
  var catLabels={"legumes":"Legumes","viandes":"Viandes et Poissons","laitiers":"Produits laitiers","feculents":"Feculents","fruits":"Fruits","epicerie":"Epicerie","boissons":"Boissons"};
  var hasItems=false;
  var allCats=Object.keys(grouped);

  allCats.forEach(function(cat){
    var items=grouped[cat];if(!items||!items.length) return;
    hasItems=true;
    if(y>262){doc.addPage();y=20;}
    doc.setFillColor(255,240,245);
    doc.rect(margin-2,y-5,pageW-margin*2+4,8,"F");
    doc.setFont("helvetica","bold");doc.setFontSize(11);doc.setTextColor(26,26,46);
    doc.text(catLabels[cat]||cat.charAt(0).toUpperCase()+cat.slice(1),margin,y);y+=9;
    items.forEach(function(item){y=pdfCheckItem(doc,item.name,item.qty,y,margin,pageW);});
    y+=4;
  });

  if(!hasItems){
    doc.setFont("helvetica","italic");doc.setFontSize(11);doc.setTextColor(150,150,150);
    doc.text("Aucun ingredient a acheter.",margin,y);
    doc.text("Planifiez vos repas dans l'onglet Calendrier.",margin,y+7);
  }

  var mealCount=Object.keys(state.weekPlanning).length;
  doc.setFontSize(8);doc.setFont("helvetica","italic");doc.setTextColor(180,180,180);
  doc.text("Generee depuis "+mealCount+" repas - Recipy App",margin,290);

  doc.save("recipy-courses.pdf");
  toast("PDF courses exporte !");
}

})();
</script>

<script>
if('serviceWorker' in navigator){
  window.addEventListener('load', function(){
    navigator.serviceWorker.register('service-worker.js')
      .then(function(reg){ console.log('SW registered:', reg.scope); })
      .catch(function(err){ console.log('SW error:', err); });
  });
}
</script>
<script>
/* ═══════════════════════════════════════════
   EDGE SWIPE — geste "retour" depuis bord gauche
═══════════════════════════════════════════ */
(function(){
  var EDGE_ZONE    = 28;
  var MIN_DIST_X   = 60;
  var MAX_DIST_Y   = 100;
  var MAX_DURATION = 500;

  var touchStartX    = 0;
  var touchStartY    = 0;
  var touchStartTime = 0;
  var edgeActive     = false;
  var indicator      = null;

  /* Créer l'indicateur visuel (trait rose au bord gauche) */
  function getIndicator(){
    if(!indicator){
      indicator = document.createElement('div');
      indicator.style.cssText = [
        'position:fixed','top:0','left:0','width:4px','height:100%',
        'background:linear-gradient(to right,#FF3E7F,rgba(255,62,127,0))',
        'opacity:0','transition:opacity .15s','z-index:9999',
        'pointer-events:none','border-radius:0 4px 4px 0'
      ].join(';');
      document.body.appendChild(indicator);
    }
    return indicator;
  }

  document.addEventListener('touchstart', function(e){
    var t = e.touches[0];
    touchStartX    = t.clientX;
    touchStartY    = t.clientY;
    touchStartTime = Date.now();
    var onCard = !!(e.target.closest && e.target.closest('#swipe-card'));
    edgeActive = (touchStartX <= EDGE_ZONE) && !onCard;
    if(edgeActive) getIndicator().style.opacity = '1';
  }, { passive: true });

  document.addEventListener('touchmove', function(e){
    if(!edgeActive) return;
    var dx = e.touches[0].clientX - touchStartX;
    /* Largeur de l'indicateur suit le doigt */
    var pct = Math.min(1, dx / 120);
    getIndicator().style.width = (4 + pct * 20) + 'px';
  }, { passive: true });

  document.addEventListener('touchend', function(e){
    if(!edgeActive) return;
    edgeActive = false;
    if(indicator){ indicator.style.opacity = '0'; indicator.style.width = '4px'; }

    var t        = e.changedTouches[0];
    var distX    = t.clientX - touchStartX;
    var distY    = Math.abs(t.clientY - touchStartY);
    var duration = Date.now() - touchStartTime;

    if(distX >= MIN_DIST_X && distY <= MAX_DIST_Y && duration <= MAX_DURATION){
      /* Essayer d'abord l'historique de navigation */
      if(typeof navigateBack === 'function' && navigateBack()) return;
      /* Fallback : si on est sur detail, cliquer le bouton retour */
      var detail = document.getElementById('detail');
      if(detail && detail.classList.contains('active')){
        var backBtn = document.getElementById('btn-det-back');
        if(backBtn) backBtn.click();
      }
    }
  }, { passive: true });

  document.addEventListener('touchcancel', function(){
    edgeActive = false;
    if(indicator){ indicator.style.opacity = '0'; indicator.style.width = '4px'; }
  }, { passive: true });
})();
</script>



</body>
</html>
